(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function s(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(i){if(i.ep)return;i.ep=!0;const n=s(i);fetch(i.href,n)}})();function Ge(t,e){var s={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(s[r]=t[r]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,r=Object.getOwnPropertySymbols(t);i<r.length;i++)e.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(t,r[i])&&(s[r[i]]=t[r[i]]);return s}function ps(t,e,s,r){function i(n){return n instanceof s?n:new s(function(a){a(n)})}return new(s||(s=Promise))(function(n,a){function o(u){try{c(r.next(u))}catch(g){a(g)}}function l(u){try{c(r.throw(u))}catch(g){a(g)}}function c(u){u.done?n(u.value):i(u.value).then(o,l)}c((r=r.apply(t,e||[])).next())})}const gs=t=>t?(...e)=>t(...e):(...e)=>fetch(...e);class vt extends Error{constructor(e,s="FunctionsError",r){super(e),this.name=s,this.context=r}}class ms extends vt{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class Rt extends vt{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class Ot extends vt{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var ct;(function(t){t.Any="any",t.ApNortheast1="ap-northeast-1",t.ApNortheast2="ap-northeast-2",t.ApSouth1="ap-south-1",t.ApSoutheast1="ap-southeast-1",t.ApSoutheast2="ap-southeast-2",t.CaCentral1="ca-central-1",t.EuCentral1="eu-central-1",t.EuWest1="eu-west-1",t.EuWest2="eu-west-2",t.EuWest3="eu-west-3",t.SaEast1="sa-east-1",t.UsEast1="us-east-1",t.UsWest1="us-west-1",t.UsWest2="us-west-2"})(ct||(ct={}));class ys{constructor(e,{headers:s={},customFetch:r,region:i=ct.Any}={}){this.url=e,this.headers=s,this.region=i,this.fetch=gs(r)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e){return ps(this,arguments,void 0,function*(s,r={}){var i;let n,a;try{const{headers:o,method:l,body:c,signal:u,timeout:g}=r;let p={},{region:d}=r;d||(d=this.region);const m=new URL(`${this.url}/${s}`);d&&d!=="any"&&(p["x-region"]=d,m.searchParams.set("forceFunctionRegion",d));let v;c&&(o&&!Object.prototype.hasOwnProperty.call(o,"Content-Type")||!o)?typeof Blob<"u"&&c instanceof Blob||c instanceof ArrayBuffer?(p["Content-Type"]="application/octet-stream",v=c):typeof c=="string"?(p["Content-Type"]="text/plain",v=c):typeof FormData<"u"&&c instanceof FormData?v=c:(p["Content-Type"]="application/json",v=JSON.stringify(c)):c&&typeof c!="string"&&!(typeof Blob<"u"&&c instanceof Blob)&&!(c instanceof ArrayBuffer)&&!(typeof FormData<"u"&&c instanceof FormData)?v=JSON.stringify(c):v=c;let b=u;g&&(a=new AbortController,n=setTimeout(()=>a.abort(),g),u?(b=a.signal,u.addEventListener("abort",()=>a.abort())):b=a.signal);const E=yield this.fetch(m.toString(),{method:l||"POST",headers:Object.assign(Object.assign(Object.assign({},p),this.headers),o),body:v,signal:b}).catch(D=>{throw new ms(D)}),w=E.headers.get("x-relay-error");if(w&&w==="true")throw new Rt(E);if(!E.ok)throw new Ot(E);let S=((i=E.headers.get("Content-Type"))!==null&&i!==void 0?i:"text/plain").split(";")[0].trim(),O;return S==="application/json"?O=yield E.json():S==="application/octet-stream"||S==="application/pdf"?O=yield E.blob():S==="text/event-stream"?O=E:S==="multipart/form-data"?O=yield E.formData():O=yield E.text(),{data:O,error:null,response:E}}catch(o){return{data:null,error:o,response:o instanceof Ot||o instanceof Rt?o.context:void 0}}finally{n&&clearTimeout(n)}})}}var ws=class extends Error{constructor(t){super(t.message),this.name="PostgrestError",this.details=t.details,this.hint=t.hint,this.code=t.code}},vs=class{constructor(t){var e,s,r;this.shouldThrowOnError=!1,this.method=t.method,this.url=t.url,this.headers=new Headers(t.headers),this.schema=t.schema,this.body=t.body,this.shouldThrowOnError=(e=t.shouldThrowOnError)!==null&&e!==void 0?e:!1,this.signal=t.signal,this.isMaybeSingle=(s=t.isMaybeSingle)!==null&&s!==void 0?s:!1,this.urlLengthLimit=(r=t.urlLengthLimit)!==null&&r!==void 0?r:8e3,t.fetch?this.fetch=t.fetch:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(t,e){return this.headers=new Headers(this.headers),this.headers.set(t,e),this}then(t,e){var s=this;this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers.set("Accept-Profile",this.schema):this.headers.set("Content-Profile",this.schema)),this.method!=="GET"&&this.method!=="HEAD"&&this.headers.set("Content-Type","application/json");const r=this.fetch;let i=r(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async n=>{let a=null,o=null,l=null,c=n.status,u=n.statusText;if(n.ok){var g,p;if(s.method!=="HEAD"){var d;const E=await n.text();E===""||(s.headers.get("Accept")==="text/csv"||s.headers.get("Accept")&&(!((d=s.headers.get("Accept"))===null||d===void 0)&&d.includes("application/vnd.pgrst.plan+text"))?o=E:o=JSON.parse(E))}const v=(g=s.headers.get("Prefer"))===null||g===void 0?void 0:g.match(/count=(exact|planned|estimated)/),b=(p=n.headers.get("content-range"))===null||p===void 0?void 0:p.split("/");v&&b&&b.length>1&&(l=parseInt(b[1])),s.isMaybeSingle&&s.method==="GET"&&Array.isArray(o)&&(o.length>1?(a={code:"PGRST116",details:`Results contain ${o.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},o=null,l=null,c=406,u="Not Acceptable"):o.length===1?o=o[0]:o=null)}else{var m;const v=await n.text();try{a=JSON.parse(v),Array.isArray(a)&&n.status===404&&(o=[],a=null,c=200,u="OK")}catch{n.status===404&&v===""?(c=204,u="No Content"):a={message:v}}if(a&&s.isMaybeSingle&&(!(a==null||(m=a.details)===null||m===void 0)&&m.includes("0 rows"))&&(a=null,c=200,u="OK"),a&&s.shouldThrowOnError)throw new ws(a)}return{error:a,data:o,count:l,status:c,statusText:u}});return this.shouldThrowOnError||(i=i.catch(n=>{var a;let o="",l="",c="";const u=n==null?void 0:n.cause;if(u){var g,p,d,m;const E=(g=u==null?void 0:u.message)!==null&&g!==void 0?g:"",w=(p=u==null?void 0:u.code)!==null&&p!==void 0?p:"";o=`${(d=n==null?void 0:n.name)!==null&&d!==void 0?d:"FetchError"}: ${n==null?void 0:n.message}`,o+=`

Caused by: ${(m=u==null?void 0:u.name)!==null&&m!==void 0?m:"Error"}: ${E}`,w&&(o+=` (${w})`),u!=null&&u.stack&&(o+=`
${u.stack}`)}else{var v;o=(v=n==null?void 0:n.stack)!==null&&v!==void 0?v:""}const b=this.url.toString().length;return(n==null?void 0:n.name)==="AbortError"||(n==null?void 0:n.code)==="ABORT_ERR"?(c="",l="Request was aborted (timeout or manual cancellation)",b>this.urlLengthLimit&&(l+=`. Note: Your request URL is ${b} characters, which may exceed server limits. If selecting many fields, consider using views. If filtering with large arrays (e.g., .in('id', [many IDs])), consider using an RPC function to pass values server-side.`)):((u==null?void 0:u.name)==="HeadersOverflowError"||(u==null?void 0:u.code)==="UND_ERR_HEADERS_OVERFLOW")&&(c="",l="HTTP headers exceeded server limits (typically 16KB)",b>this.urlLengthLimit&&(l+=`. Your request URL is ${b} characters. If selecting many fields, consider using views. If filtering with large arrays (e.g., .in('id', [200+ IDs])), consider using an RPC function instead.`)),{error:{message:`${(a=n==null?void 0:n.name)!==null&&a!==void 0?a:"FetchError"}: ${n==null?void 0:n.message}`,details:o,hint:l,code:c},data:null,count:null,status:0,statusText:""}})),i.then(t,e)}returns(){return this}overrideTypes(){return this}},bs=class extends vs{select(t){let e=!1;const s=(t??"*").split("").map(r=>/\s/.test(r)&&!e?"":(r==='"'&&(e=!e),r)).join("");return this.url.searchParams.set("select",s),this.headers.append("Prefer","return=representation"),this}order(t,{ascending:e=!0,nullsFirst:s,foreignTable:r,referencedTable:i=r}={}){const n=i?`${i}.order`:"order",a=this.url.searchParams.get(n);return this.url.searchParams.set(n,`${a?`${a},`:""}${t}.${e?"asc":"desc"}${s===void 0?"":s?".nullsfirst":".nullslast"}`),this}limit(t,{foreignTable:e,referencedTable:s=e}={}){const r=typeof s>"u"?"limit":`${s}.limit`;return this.url.searchParams.set(r,`${t}`),this}range(t,e,{foreignTable:s,referencedTable:r=s}={}){const i=typeof r>"u"?"offset":`${r}.offset`,n=typeof r>"u"?"limit":`${r}.limit`;return this.url.searchParams.set(i,`${t}`),this.url.searchParams.set(n,`${e-t+1}`),this}abortSignal(t){return this.signal=t,this}single(){return this.headers.set("Accept","application/vnd.pgrst.object+json"),this}maybeSingle(){return this.method==="GET"?this.headers.set("Accept","application/json"):this.headers.set("Accept","application/vnd.pgrst.object+json"),this.isMaybeSingle=!0,this}csv(){return this.headers.set("Accept","text/csv"),this}geojson(){return this.headers.set("Accept","application/geo+json"),this}explain({analyze:t=!1,verbose:e=!1,settings:s=!1,buffers:r=!1,wal:i=!1,format:n="text"}={}){var a;const o=[t?"analyze":null,e?"verbose":null,s?"settings":null,r?"buffers":null,i?"wal":null].filter(Boolean).join("|"),l=(a=this.headers.get("Accept"))!==null&&a!==void 0?a:"application/json";return this.headers.set("Accept",`application/vnd.pgrst.plan+${n}; for="${l}"; options=${o};`),n==="json"?this:this}rollback(){return this.headers.append("Prefer","tx=rollback"),this}returns(){return this}maxAffected(t){return this.headers.append("Prefer","handling=strict"),this.headers.append("Prefer",`max-affected=${t}`),this}};const Ct=new RegExp("[,()]");var ge=class extends bs{eq(t,e){return this.url.searchParams.append(t,`eq.${e}`),this}neq(t,e){return this.url.searchParams.append(t,`neq.${e}`),this}gt(t,e){return this.url.searchParams.append(t,`gt.${e}`),this}gte(t,e){return this.url.searchParams.append(t,`gte.${e}`),this}lt(t,e){return this.url.searchParams.append(t,`lt.${e}`),this}lte(t,e){return this.url.searchParams.append(t,`lte.${e}`),this}like(t,e){return this.url.searchParams.append(t,`like.${e}`),this}likeAllOf(t,e){return this.url.searchParams.append(t,`like(all).{${e.join(",")}}`),this}likeAnyOf(t,e){return this.url.searchParams.append(t,`like(any).{${e.join(",")}}`),this}ilike(t,e){return this.url.searchParams.append(t,`ilike.${e}`),this}ilikeAllOf(t,e){return this.url.searchParams.append(t,`ilike(all).{${e.join(",")}}`),this}ilikeAnyOf(t,e){return this.url.searchParams.append(t,`ilike(any).{${e.join(",")}}`),this}regexMatch(t,e){return this.url.searchParams.append(t,`match.${e}`),this}regexIMatch(t,e){return this.url.searchParams.append(t,`imatch.${e}`),this}is(t,e){return this.url.searchParams.append(t,`is.${e}`),this}isDistinct(t,e){return this.url.searchParams.append(t,`isdistinct.${e}`),this}in(t,e){const s=Array.from(new Set(e)).map(r=>typeof r=="string"&&Ct.test(r)?`"${r}"`:`${r}`).join(",");return this.url.searchParams.append(t,`in.(${s})`),this}notIn(t,e){const s=Array.from(new Set(e)).map(r=>typeof r=="string"&&Ct.test(r)?`"${r}"`:`${r}`).join(",");return this.url.searchParams.append(t,`not.in.(${s})`),this}contains(t,e){return typeof e=="string"?this.url.searchParams.append(t,`cs.${e}`):Array.isArray(e)?this.url.searchParams.append(t,`cs.{${e.join(",")}}`):this.url.searchParams.append(t,`cs.${JSON.stringify(e)}`),this}containedBy(t,e){return typeof e=="string"?this.url.searchParams.append(t,`cd.${e}`):Array.isArray(e)?this.url.searchParams.append(t,`cd.{${e.join(",")}}`):this.url.searchParams.append(t,`cd.${JSON.stringify(e)}`),this}rangeGt(t,e){return this.url.searchParams.append(t,`sr.${e}`),this}rangeGte(t,e){return this.url.searchParams.append(t,`nxl.${e}`),this}rangeLt(t,e){return this.url.searchParams.append(t,`sl.${e}`),this}rangeLte(t,e){return this.url.searchParams.append(t,`nxr.${e}`),this}rangeAdjacent(t,e){return this.url.searchParams.append(t,`adj.${e}`),this}overlaps(t,e){return typeof e=="string"?this.url.searchParams.append(t,`ov.${e}`):this.url.searchParams.append(t,`ov.{${e.join(",")}}`),this}textSearch(t,e,{config:s,type:r}={}){let i="";r==="plain"?i="pl":r==="phrase"?i="ph":r==="websearch"&&(i="w");const n=s===void 0?"":`(${s})`;return this.url.searchParams.append(t,`${i}fts${n}.${e}`),this}match(t){return Object.entries(t).forEach(([e,s])=>{this.url.searchParams.append(e,`eq.${s}`)}),this}not(t,e,s){return this.url.searchParams.append(t,`not.${e}.${s}`),this}or(t,{foreignTable:e,referencedTable:s=e}={}){const r=s?`${s}.or`:"or";return this.url.searchParams.append(r,`(${t})`),this}filter(t,e,s){return this.url.searchParams.append(t,`${e}.${s}`),this}},_s=class{constructor(t,{headers:e={},schema:s,fetch:r,urlLengthLimit:i=8e3}){this.url=t,this.headers=new Headers(e),this.schema=s,this.fetch=r,this.urlLengthLimit=i}cloneRequestState(){return{url:new URL(this.url.toString()),headers:new Headers(this.headers)}}select(t,e){const{head:s=!1,count:r}=e??{},i=s?"HEAD":"GET";let n=!1;const a=(t??"*").split("").map(c=>/\s/.test(c)&&!n?"":(c==='"'&&(n=!n),c)).join(""),{url:o,headers:l}=this.cloneRequestState();return o.searchParams.set("select",a),r&&l.append("Prefer",`count=${r}`),new ge({method:i,url:o,headers:l,schema:this.schema,fetch:this.fetch,urlLengthLimit:this.urlLengthLimit})}insert(t,{count:e,defaultToNull:s=!0}={}){var r;const i="POST",{url:n,headers:a}=this.cloneRequestState();if(e&&a.append("Prefer",`count=${e}`),s||a.append("Prefer","missing=default"),Array.isArray(t)){const o=t.reduce((l,c)=>l.concat(Object.keys(c)),[]);if(o.length>0){const l=[...new Set(o)].map(c=>`"${c}"`);n.searchParams.set("columns",l.join(","))}}return new ge({method:i,url:n,headers:a,schema:this.schema,body:t,fetch:(r=this.fetch)!==null&&r!==void 0?r:fetch,urlLengthLimit:this.urlLengthLimit})}upsert(t,{onConflict:e,ignoreDuplicates:s=!1,count:r,defaultToNull:i=!0}={}){var n;const a="POST",{url:o,headers:l}=this.cloneRequestState();if(l.append("Prefer",`resolution=${s?"ignore":"merge"}-duplicates`),e!==void 0&&o.searchParams.set("on_conflict",e),r&&l.append("Prefer",`count=${r}`),i||l.append("Prefer","missing=default"),Array.isArray(t)){const c=t.reduce((u,g)=>u.concat(Object.keys(g)),[]);if(c.length>0){const u=[...new Set(c)].map(g=>`"${g}"`);o.searchParams.set("columns",u.join(","))}}return new ge({method:a,url:o,headers:l,schema:this.schema,body:t,fetch:(n=this.fetch)!==null&&n!==void 0?n:fetch,urlLengthLimit:this.urlLengthLimit})}update(t,{count:e}={}){var s;const r="PATCH",{url:i,headers:n}=this.cloneRequestState();return e&&n.append("Prefer",`count=${e}`),new ge({method:r,url:i,headers:n,schema:this.schema,body:t,fetch:(s=this.fetch)!==null&&s!==void 0?s:fetch,urlLengthLimit:this.urlLengthLimit})}delete({count:t}={}){var e;const s="DELETE",{url:r,headers:i}=this.cloneRequestState();return t&&i.append("Prefer",`count=${t}`),new ge({method:s,url:r,headers:i,schema:this.schema,fetch:(e=this.fetch)!==null&&e!==void 0?e:fetch,urlLengthLimit:this.urlLengthLimit})}};function Re(t){"@babel/helpers - typeof";return Re=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Re(t)}function Ss(t,e){if(Re(t)!="object"||!t)return t;var s=t[Symbol.toPrimitive];if(s!==void 0){var r=s.call(t,e);if(Re(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(t)}function Es(t){var e=Ss(t,"string");return Re(e)=="symbol"?e:e+""}function ks(t,e,s){return(e=Es(e))in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}function Lt(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),s.push.apply(s,r)}return s}function Ne(t){for(var e=1;e<arguments.length;e++){var s=arguments[e]!=null?arguments[e]:{};e%2?Lt(Object(s),!0).forEach(function(r){ks(t,r,s[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):Lt(Object(s)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(s,r))})}return t}var As=class Xt{constructor(e,{headers:s={},schema:r,fetch:i,timeout:n,urlLengthLimit:a=8e3}={}){this.url=e,this.headers=new Headers(s),this.schemaName=r,this.urlLengthLimit=a;const o=i??globalThis.fetch;n!==void 0&&n>0?this.fetch=(l,c)=>{const u=new AbortController,g=setTimeout(()=>u.abort(),n),p=c==null?void 0:c.signal;if(p){if(p.aborted)return clearTimeout(g),o(l,c);const d=()=>{clearTimeout(g),u.abort()};return p.addEventListener("abort",d,{once:!0}),o(l,Ne(Ne({},c),{},{signal:u.signal})).finally(()=>{clearTimeout(g),p.removeEventListener("abort",d)})}return o(l,Ne(Ne({},c),{},{signal:u.signal})).finally(()=>clearTimeout(g))}:this.fetch=o}from(e){if(!e||typeof e!="string"||e.trim()==="")throw new Error("Invalid relation name: relation must be a non-empty string.");return new _s(new URL(`${this.url}/${e}`),{headers:new Headers(this.headers),schema:this.schemaName,fetch:this.fetch,urlLengthLimit:this.urlLengthLimit})}schema(e){return new Xt(this.url,{headers:this.headers,schema:e,fetch:this.fetch,urlLengthLimit:this.urlLengthLimit})}rpc(e,s={},{head:r=!1,get:i=!1,count:n}={}){var a;let o;const l=new URL(`${this.url}/rpc/${e}`);let c;const u=d=>d!==null&&typeof d=="object"&&(!Array.isArray(d)||d.some(u)),g=r&&Object.values(s).some(u);g?(o="POST",c=s):r||i?(o=r?"HEAD":"GET",Object.entries(s).filter(([d,m])=>m!==void 0).map(([d,m])=>[d,Array.isArray(m)?`{${m.join(",")}}`:`${m}`]).forEach(([d,m])=>{l.searchParams.append(d,m)})):(o="POST",c=s);const p=new Headers(this.headers);return g?p.set("Prefer",n?`count=${n},return=minimal`:"return=minimal"):n&&p.set("Prefer",`count=${n}`),new ge({method:o,url:l,headers:p,schema:this.schemaName,body:c,fetch:(a=this.fetch)!==null&&a!==void 0?a:fetch,urlLengthLimit:this.urlLengthLimit})}};class Ts{constructor(){}static detectEnvironment(){var e;if(typeof WebSocket<"u")return{type:"native",constructor:WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocket<"u")return{type:"native",constructor:globalThis.WebSocket};if(typeof global<"u"&&typeof global.WebSocket<"u")return{type:"native",constructor:global.WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocketPair<"u"&&typeof globalThis.WebSocket>"u")return{type:"cloudflare",error:"Cloudflare Workers detected. WebSocket clients are not supported in Cloudflare Workers.",workaround:"Use Cloudflare Workers WebSocket API for server-side WebSocket handling, or deploy to a different runtime."};if(typeof globalThis<"u"&&globalThis.EdgeRuntime||typeof navigator<"u"&&(!((e=navigator.userAgent)===null||e===void 0)&&e.includes("Vercel-Edge")))return{type:"unsupported",error:"Edge runtime detected (Vercel Edge/Netlify Edge). WebSockets are not supported in edge functions.",workaround:"Use serverless functions or a different deployment target for WebSocket functionality."};const s=globalThis.process;if(s){const r=s.versions;if(r&&r.node){const i=r.node,n=parseInt(i.replace(/^v/,"").split(".")[0]);return n>=22?typeof globalThis.WebSocket<"u"?{type:"native",constructor:globalThis.WebSocket}:{type:"unsupported",error:`Node.js ${n} detected but native WebSocket not found.`,workaround:"Provide a WebSocket implementation via the transport option."}:{type:"unsupported",error:`Node.js ${n} detected without native WebSocket support.`,workaround:`For Node.js < 22, install "ws" package and provide it via the transport option:
import ws from "ws"
new RealtimeClient(url, { transport: ws })`}}}return{type:"unsupported",error:"Unknown JavaScript runtime without WebSocket support.",workaround:"Ensure you're running in a supported environment (browser, Node.js, Deno) or provide a custom WebSocket implementation."}}static getWebSocketConstructor(){const e=this.detectEnvironment();if(e.constructor)return e.constructor;let s=e.error||"WebSocket not supported in this environment.";throw e.workaround&&(s+=`

Suggested solution: ${e.workaround}`),new Error(s)}static createWebSocket(e,s){const r=this.getWebSocketConstructor();return new r(e,s)}static isWebSocketSupported(){try{const e=this.detectEnvironment();return e.type==="native"||e.type==="ws"}catch{return!1}}}const Rs="2.97.0",Os=`realtime-js/${Rs}`,Cs="1.0.0",Zt="2.0.0",It=Zt,ut=1e4,Ls=1e3,Is=100;var te;(function(t){t[t.connecting=0]="connecting",t[t.open=1]="open",t[t.closing=2]="closing",t[t.closed=3]="closed"})(te||(te={}));var q;(function(t){t.closed="closed",t.errored="errored",t.joined="joined",t.joining="joining",t.leaving="leaving"})(q||(q={}));var Y;(function(t){t.close="phx_close",t.error="phx_error",t.join="phx_join",t.reply="phx_reply",t.leave="phx_leave",t.access_token="access_token"})(Y||(Y={}));var dt;(function(t){t.websocket="websocket"})(dt||(dt={}));var ae;(function(t){t.Connecting="connecting",t.Open="open",t.Closing="closing",t.Closed="closed"})(ae||(ae={}));class Ps{constructor(e){this.HEADER_LENGTH=1,this.USER_BROADCAST_PUSH_META_LENGTH=6,this.KINDS={userBroadcastPush:3,userBroadcast:4},this.BINARY_ENCODING=0,this.JSON_ENCODING=1,this.BROADCAST_EVENT="broadcast",this.allowedMetadataKeys=[],this.allowedMetadataKeys=e??[]}encode(e,s){if(e.event===this.BROADCAST_EVENT&&!(e.payload instanceof ArrayBuffer)&&typeof e.payload.event=="string")return s(this._binaryEncodeUserBroadcastPush(e));let r=[e.join_ref,e.ref,e.topic,e.event,e.payload];return s(JSON.stringify(r))}_binaryEncodeUserBroadcastPush(e){var s;return this._isArrayBuffer((s=e.payload)===null||s===void 0?void 0:s.payload)?this._encodeBinaryUserBroadcastPush(e):this._encodeJsonUserBroadcastPush(e)}_encodeBinaryUserBroadcastPush(e){var s,r;const i=(r=(s=e.payload)===null||s===void 0?void 0:s.payload)!==null&&r!==void 0?r:new ArrayBuffer(0);return this._encodeUserBroadcastPush(e,this.BINARY_ENCODING,i)}_encodeJsonUserBroadcastPush(e){var s,r;const i=(r=(s=e.payload)===null||s===void 0?void 0:s.payload)!==null&&r!==void 0?r:{},a=new TextEncoder().encode(JSON.stringify(i)).buffer;return this._encodeUserBroadcastPush(e,this.JSON_ENCODING,a)}_encodeUserBroadcastPush(e,s,r){var i,n;const a=e.topic,o=(i=e.ref)!==null&&i!==void 0?i:"",l=(n=e.join_ref)!==null&&n!==void 0?n:"",c=e.payload.event,u=this.allowedMetadataKeys?this._pick(e.payload,this.allowedMetadataKeys):{},g=Object.keys(u).length===0?"":JSON.stringify(u);if(l.length>255)throw new Error(`joinRef length ${l.length} exceeds maximum of 255`);if(o.length>255)throw new Error(`ref length ${o.length} exceeds maximum of 255`);if(a.length>255)throw new Error(`topic length ${a.length} exceeds maximum of 255`);if(c.length>255)throw new Error(`userEvent length ${c.length} exceeds maximum of 255`);if(g.length>255)throw new Error(`metadata length ${g.length} exceeds maximum of 255`);const p=this.USER_BROADCAST_PUSH_META_LENGTH+l.length+o.length+a.length+c.length+g.length,d=new ArrayBuffer(this.HEADER_LENGTH+p);let m=new DataView(d),v=0;m.setUint8(v++,this.KINDS.userBroadcastPush),m.setUint8(v++,l.length),m.setUint8(v++,o.length),m.setUint8(v++,a.length),m.setUint8(v++,c.length),m.setUint8(v++,g.length),m.setUint8(v++,s),Array.from(l,E=>m.setUint8(v++,E.charCodeAt(0))),Array.from(o,E=>m.setUint8(v++,E.charCodeAt(0))),Array.from(a,E=>m.setUint8(v++,E.charCodeAt(0))),Array.from(c,E=>m.setUint8(v++,E.charCodeAt(0))),Array.from(g,E=>m.setUint8(v++,E.charCodeAt(0)));var b=new Uint8Array(d.byteLength+r.byteLength);return b.set(new Uint8Array(d),0),b.set(new Uint8Array(r),d.byteLength),b.buffer}decode(e,s){if(this._isArrayBuffer(e)){let r=this._binaryDecode(e);return s(r)}if(typeof e=="string"){const r=JSON.parse(e),[i,n,a,o,l]=r;return s({join_ref:i,ref:n,topic:a,event:o,payload:l})}return s({})}_binaryDecode(e){const s=new DataView(e),r=s.getUint8(0),i=new TextDecoder;switch(r){case this.KINDS.userBroadcast:return this._decodeUserBroadcast(e,s,i)}}_decodeUserBroadcast(e,s,r){const i=s.getUint8(1),n=s.getUint8(2),a=s.getUint8(3),o=s.getUint8(4);let l=this.HEADER_LENGTH+4;const c=r.decode(e.slice(l,l+i));l=l+i;const u=r.decode(e.slice(l,l+n));l=l+n;const g=r.decode(e.slice(l,l+a));l=l+a;const p=e.slice(l,e.byteLength),d=o===this.JSON_ENCODING?JSON.parse(r.decode(p)):p,m={type:this.BROADCAST_EVENT,event:u,payload:d};return a>0&&(m.meta=JSON.parse(g)),{join_ref:null,ref:null,topic:c,event:this.BROADCAST_EVENT,payload:m}}_isArrayBuffer(e){var s;return e instanceof ArrayBuffer||((s=e==null?void 0:e.constructor)===null||s===void 0?void 0:s.name)==="ArrayBuffer"}_pick(e,s){return!e||typeof e!="object"?{}:Object.fromEntries(Object.entries(e).filter(([r])=>s.includes(r)))}}class es{constructor(e,s){this.callback=e,this.timerCalc=s,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=s}reset(){this.tries=0,clearTimeout(this.timer),this.timer=void 0}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}var x;(function(t){t.abstime="abstime",t.bool="bool",t.date="date",t.daterange="daterange",t.float4="float4",t.float8="float8",t.int2="int2",t.int4="int4",t.int4range="int4range",t.int8="int8",t.int8range="int8range",t.json="json",t.jsonb="jsonb",t.money="money",t.numeric="numeric",t.oid="oid",t.reltime="reltime",t.text="text",t.time="time",t.timestamp="timestamp",t.timestamptz="timestamptz",t.timetz="timetz",t.tsrange="tsrange",t.tstzrange="tstzrange"})(x||(x={}));const Pt=(t,e,s={})=>{var r;const i=(r=s.skipTypes)!==null&&r!==void 0?r:[];return e?Object.keys(e).reduce((n,a)=>(n[a]=$s(a,t,e,i),n),{}):{}},$s=(t,e,s,r)=>{const i=e.find(o=>o.name===t),n=i==null?void 0:i.type,a=s[t];return n&&!r.includes(n)?ts(n,a):ht(a)},ts=(t,e)=>{if(t.charAt(0)==="_"){const s=t.slice(1,t.length);return Ns(e,s)}switch(t){case x.bool:return xs(e);case x.float4:case x.float8:case x.int2:case x.int4:case x.int8:case x.numeric:case x.oid:return Ds(e);case x.json:case x.jsonb:return js(e);case x.timestamp:return Us(e);case x.abstime:case x.date:case x.daterange:case x.int4range:case x.int8range:case x.money:case x.reltime:case x.text:case x.time:case x.timestamptz:case x.timetz:case x.tsrange:case x.tstzrange:return ht(e);default:return ht(e)}},ht=t=>t,xs=t=>{switch(t){case"t":return!0;case"f":return!1;default:return t}},Ds=t=>{if(typeof t=="string"){const e=parseFloat(t);if(!Number.isNaN(e))return e}return t},js=t=>{if(typeof t=="string")try{return JSON.parse(t)}catch{return t}return t},Ns=(t,e)=>{if(typeof t!="string")return t;const s=t.length-1,r=t[s];if(t[0]==="{"&&r==="}"){let n;const a=t.slice(1,s);try{n=JSON.parse("["+a+"]")}catch{n=a?a.split(","):[]}return n.map(o=>ts(e,o))}return t},Us=t=>typeof t=="string"?t.replace(" ","T"):t,ss=t=>{const e=new URL(t);return e.protocol=e.protocol.replace(/^ws/i,"http"),e.pathname=e.pathname.replace(/\/+$/,"").replace(/\/socket\/websocket$/i,"").replace(/\/socket$/i,"").replace(/\/websocket$/i,""),e.pathname===""||e.pathname==="/"?e.pathname="/api/broadcast":e.pathname=e.pathname+"/api/broadcast",e.href};class st{constructor(e,s,r={},i=ut){this.channel=e,this.event=s,this.payload=r,this.timeout=i,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,s){var r;return this._hasReceived(e)&&s((r=this.receivedResp)===null||r===void 0?void 0:r.response),this.recHooks.push({status:e,callback:s}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const e=s=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=s,this._matchReceive(s)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,s){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:s})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:s}){this.recHooks.filter(r=>r.status===e).forEach(r=>r.callback(s))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var $t;(function(t){t.SYNC="sync",t.JOIN="join",t.LEAVE="leave"})($t||($t={}));class Ae{constructor(e,s){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.enabled=!1,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const r=(s==null?void 0:s.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(r.state,{},i=>{const{onJoin:n,onLeave:a,onSync:o}=this.caller;this.joinRef=this.channel._joinRef(),this.state=Ae.syncState(this.state,i,n,a),this.pendingDiffs.forEach(l=>{this.state=Ae.syncDiff(this.state,l,n,a)}),this.pendingDiffs=[],o()}),this.channel._on(r.diff,{},i=>{const{onJoin:n,onLeave:a,onSync:o}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(i):(this.state=Ae.syncDiff(this.state,i,n,a),o())}),this.onJoin((i,n,a)=>{this.channel._trigger("presence",{event:"join",key:i,currentPresences:n,newPresences:a})}),this.onLeave((i,n,a)=>{this.channel._trigger("presence",{event:"leave",key:i,currentPresences:n,leftPresences:a})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,s,r,i){const n=this.cloneDeep(e),a=this.transformState(s),o={},l={};return this.map(n,(c,u)=>{a[c]||(l[c]=u)}),this.map(a,(c,u)=>{const g=n[c];if(g){const p=u.map(b=>b.presence_ref),d=g.map(b=>b.presence_ref),m=u.filter(b=>d.indexOf(b.presence_ref)<0),v=g.filter(b=>p.indexOf(b.presence_ref)<0);m.length>0&&(o[c]=m),v.length>0&&(l[c]=v)}else o[c]=u}),this.syncDiff(n,{joins:o,leaves:l},r,i)}static syncDiff(e,s,r,i){const{joins:n,leaves:a}={joins:this.transformState(s.joins),leaves:this.transformState(s.leaves)};return r||(r=()=>{}),i||(i=()=>{}),this.map(n,(o,l)=>{var c;const u=(c=e[o])!==null&&c!==void 0?c:[];if(e[o]=this.cloneDeep(l),u.length>0){const g=e[o].map(d=>d.presence_ref),p=u.filter(d=>g.indexOf(d.presence_ref)<0);e[o].unshift(...p)}r(o,u,l)}),this.map(a,(o,l)=>{let c=e[o];if(!c)return;const u=l.map(g=>g.presence_ref);c=c.filter(g=>u.indexOf(g.presence_ref)<0),e[o]=c,i(o,c,l),c.length===0&&delete e[o]}),e}static map(e,s){return Object.getOwnPropertyNames(e).map(r=>s(r,e[r]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((s,r)=>{const i=e[r];return"metas"in i?s[r]=i.metas.map(n=>(n.presence_ref=n.phx_ref,delete n.phx_ref,delete n.phx_ref_prev,n)):s[r]=i,s},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var xt;(function(t){t.ALL="*",t.INSERT="INSERT",t.UPDATE="UPDATE",t.DELETE="DELETE"})(xt||(xt={}));var Te;(function(t){t.BROADCAST="broadcast",t.PRESENCE="presence",t.POSTGRES_CHANGES="postgres_changes",t.SYSTEM="system"})(Te||(Te={}));var Z;(function(t){t.SUBSCRIBED="SUBSCRIBED",t.TIMED_OUT="TIMED_OUT",t.CLOSED="CLOSED",t.CHANNEL_ERROR="CHANNEL_ERROR"})(Z||(Z={}));class we{constructor(e,s={config:{}},r){var i,n;if(this.topic=e,this.params=s,this.socket=r,this.bindings={},this.state=q.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:"",enabled:!1},private:!1},s.config),this.timeout=this.socket.timeout,this.joinPush=new st(this,Y.join,this.params,this.timeout),this.rejoinTimer=new es(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=q.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(a=>a.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=q.closed,this.socket._remove(this)}),this._onError(a=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,a),this.state=q.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=q.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("error",a=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,a),this.state=q.errored,this.rejoinTimer.scheduleTimeout())}),this._on(Y.reply,{},(a,o)=>{this._trigger(this._replyEventName(o),a)}),this.presence=new Ae(this),this.broadcastEndpointURL=ss(this.socket.endPoint),this.private=this.params.config.private||!1,!this.private&&(!((n=(i=this.params.config)===null||i===void 0?void 0:i.broadcast)===null||n===void 0)&&n.replay))throw`tried to use replay on public channel '${this.topic}'. It must be a private channel.`}subscribe(e,s=this.timeout){var r,i,n;if(this.socket.isConnected()||this.socket.connect(),this.state==q.closed){const{config:{broadcast:a,presence:o,private:l}}=this.params,c=(i=(r=this.bindings.postgres_changes)===null||r===void 0?void 0:r.map(d=>d.filter))!==null&&i!==void 0?i:[],u=!!this.bindings[Te.PRESENCE]&&this.bindings[Te.PRESENCE].length>0||((n=this.params.config.presence)===null||n===void 0?void 0:n.enabled)===!0,g={},p={broadcast:a,presence:Object.assign(Object.assign({},o),{enabled:u}),postgres_changes:c,private:l};this.socket.accessTokenValue&&(g.access_token=this.socket.accessTokenValue),this._onError(d=>e==null?void 0:e(Z.CHANNEL_ERROR,d)),this._onClose(()=>e==null?void 0:e(Z.CLOSED)),this.updateJoinPayload(Object.assign({config:p},g)),this.joinedOnce=!0,this._rejoin(s),this.joinPush.receive("ok",async({postgres_changes:d})=>{var m;if(this.socket._isManualToken()||this.socket.setAuth(),d===void 0){e==null||e(Z.SUBSCRIBED);return}else{const v=this.bindings.postgres_changes,b=(m=v==null?void 0:v.length)!==null&&m!==void 0?m:0,E=[];for(let w=0;w<b;w++){const S=v[w],{filter:{event:O,schema:D,table:P,filter:U}}=S,V=d&&d[w];if(V&&V.event===O&&we.isFilterValueEqual(V.schema,D)&&we.isFilterValueEqual(V.table,P)&&we.isFilterValueEqual(V.filter,U))E.push(Object.assign(Object.assign({},S),{id:V.id}));else{this.unsubscribe(),this.state=q.errored,e==null||e(Z.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=E,e&&e(Z.SUBSCRIBED);return}}).receive("error",d=>{this.state=q.errored,e==null||e(Z.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(d).join(", ")||"error")))}).receive("timeout",()=>{e==null||e(Z.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(e,s={}){return await this.send({type:"presence",event:"track",payload:e},s.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,s,r){return this.state===q.joined&&e===Te.PRESENCE&&(this.socket.log("channel",`resubscribe to ${this.topic} due to change in presence callbacks on joined channel`),this.unsubscribe().then(async()=>await this.subscribe())),this._on(e,s,r)}async httpSend(e,s,r={}){var i;if(s==null)return Promise.reject("Payload is required for httpSend()");const n={apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"};this.socket.accessTokenValue&&(n.Authorization=`Bearer ${this.socket.accessTokenValue}`);const a={method:"POST",headers:n,body:JSON.stringify({messages:[{topic:this.subTopic,event:e,payload:s,private:this.private}]})},o=await this._fetchWithTimeout(this.broadcastEndpointURL,a,(i=r.timeout)!==null&&i!==void 0?i:this.timeout);if(o.status===202)return{success:!0};let l=o.statusText;try{const c=await o.json();l=c.error||c.message||l}catch{}return Promise.reject(new Error(l))}async send(e,s={}){var r,i;if(!this._canPush()&&e.type==="broadcast"){console.warn("Realtime send() is automatically falling back to REST API. This behavior will be deprecated in the future. Please use httpSend() explicitly for REST delivery.");const{event:n,payload:a}=e,o={apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"};this.socket.accessTokenValue&&(o.Authorization=`Bearer ${this.socket.accessTokenValue}`);const l={method:"POST",headers:o,body:JSON.stringify({messages:[{topic:this.subTopic,event:n,payload:a,private:this.private}]})};try{const c=await this._fetchWithTimeout(this.broadcastEndpointURL,l,(r=s.timeout)!==null&&r!==void 0?r:this.timeout);return await((i=c.body)===null||i===void 0?void 0:i.cancel()),c.ok?"ok":"error"}catch(c){return c.name==="AbortError"?"timed out":"error"}}else return new Promise(n=>{var a,o,l;const c=this._push(e.type,e,s.timeout||this.timeout);e.type==="broadcast"&&!(!((l=(o=(a=this.params)===null||a===void 0?void 0:a.config)===null||o===void 0?void 0:o.broadcast)===null||l===void 0)&&l.ack)&&n("ok"),c.receive("ok",()=>n("ok")),c.receive("error",()=>n("error")),c.receive("timeout",()=>n("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=q.leaving;const s=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(Y.close,"leave",this._joinRef())};this.joinPush.destroy();let r=null;return new Promise(i=>{r=new st(this,Y.leave,{},e),r.receive("ok",()=>{s(),i("ok")}).receive("timeout",()=>{s(),i("timed out")}).receive("error",()=>{i("error")}),r.send(),this._canPush()||r.trigger("ok",{})}).finally(()=>{r==null||r.destroy()})}teardown(){this.pushBuffer.forEach(e=>e.destroy()),this.pushBuffer=[],this.rejoinTimer.reset(),this.joinPush.destroy(),this.state=q.closed,this.bindings={}}async _fetchWithTimeout(e,s,r){const i=new AbortController,n=setTimeout(()=>i.abort(),r),a=await this.socket.fetch(e,Object.assign(Object.assign({},s),{signal:i.signal}));return clearTimeout(n),a}_push(e,s,r=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let i=new st(this,e,s,r);return this._canPush()?i.send():this._addToPushBuffer(i),i}_addToPushBuffer(e){if(e.startTimeout(),this.pushBuffer.push(e),this.pushBuffer.length>Is){const s=this.pushBuffer.shift();s&&(s.destroy(),this.socket.log("channel",`discarded push due to buffer overflow: ${s.event}`,s.payload))}}_onMessage(e,s,r){return s}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,s,r){var i,n;const a=e.toLocaleLowerCase(),{close:o,error:l,leave:c,join:u}=Y;if(r&&[o,l,c,u].indexOf(a)>=0&&r!==this._joinRef())return;let p=this._onMessage(a,s,r);if(s&&!p)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(a)?(i=this.bindings.postgres_changes)===null||i===void 0||i.filter(d=>{var m,v,b;return((m=d.filter)===null||m===void 0?void 0:m.event)==="*"||((b=(v=d.filter)===null||v===void 0?void 0:v.event)===null||b===void 0?void 0:b.toLocaleLowerCase())===a}).map(d=>d.callback(p,r)):(n=this.bindings[a])===null||n===void 0||n.filter(d=>{var m,v,b,E,w,S;if(["broadcast","presence","postgres_changes"].includes(a))if("id"in d){const O=d.id,D=(m=d.filter)===null||m===void 0?void 0:m.event;return O&&((v=s.ids)===null||v===void 0?void 0:v.includes(O))&&(D==="*"||(D==null?void 0:D.toLocaleLowerCase())===((b=s.data)===null||b===void 0?void 0:b.type.toLocaleLowerCase()))}else{const O=(w=(E=d==null?void 0:d.filter)===null||E===void 0?void 0:E.event)===null||w===void 0?void 0:w.toLocaleLowerCase();return O==="*"||O===((S=s==null?void 0:s.event)===null||S===void 0?void 0:S.toLocaleLowerCase())}else return d.type.toLocaleLowerCase()===a}).map(d=>{if(typeof p=="object"&&"ids"in p){const m=p.data,{schema:v,table:b,commit_timestamp:E,type:w,errors:S}=m;p=Object.assign(Object.assign({},{schema:v,table:b,commit_timestamp:E,eventType:w,new:{},old:{},errors:S}),this._getPayloadRecords(m))}d.callback(p,r)})}_isClosed(){return this.state===q.closed}_isJoined(){return this.state===q.joined}_isJoining(){return this.state===q.joining}_isLeaving(){return this.state===q.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,s,r){const i=e.toLocaleLowerCase(),n={type:i,filter:s,callback:r};return this.bindings[i]?this.bindings[i].push(n):this.bindings[i]=[n],this}_off(e,s){const r=e.toLocaleLowerCase();return this.bindings[r]&&(this.bindings[r]=this.bindings[r].filter(i=>{var n;return!(((n=i.type)===null||n===void 0?void 0:n.toLocaleLowerCase())===r&&we.isEqual(i.filter,s))})),this}static isEqual(e,s){if(Object.keys(e).length!==Object.keys(s).length)return!1;for(const r in e)if(e[r]!==s[r])return!1;return!0}static isFilterValueEqual(e,s){return(e??void 0)===(s??void 0)}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(Y.close,{},e)}_onError(e){this._on(Y.error,{},s=>e(s))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=q.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const s={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(s.new=Pt(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(s.old=Pt(e.columns,e.old_record)),s}}const rt=()=>{},Ue={HEARTBEAT_INTERVAL:25e3,RECONNECT_DELAY:10,HEARTBEAT_TIMEOUT_FALLBACK:100},Bs=[1e3,2e3,5e3,1e4],Fs=1e4,qs=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`;class Ms{constructor(e,s){var r;if(this.accessTokenValue=null,this.apiKey=null,this._manuallySetToken=!1,this.channels=new Array,this.endPoint="",this.httpEndpoint="",this.headers={},this.params={},this.timeout=ut,this.transport=null,this.heartbeatIntervalMs=Ue.HEARTBEAT_INTERVAL,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=rt,this.ref=0,this.reconnectTimer=null,this.vsn=It,this.logger=rt,this.conn=null,this.sendBuffer=[],this.serializer=new Ps,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._connectionState="disconnected",this._wasManualDisconnect=!1,this._authPromise=null,this._heartbeatSentAt=null,this._resolveFetch=i=>i?(...n)=>i(...n):(...n)=>fetch(...n),!(!((r=s==null?void 0:s.params)===null||r===void 0)&&r.apikey))throw new Error("API key is required to connect to Realtime");this.apiKey=s.params.apikey,this.endPoint=`${e}/${dt.websocket}`,this.httpEndpoint=ss(e),this._initializeOptions(s),this._setupReconnectionTimer(),this.fetch=this._resolveFetch(s==null?void 0:s.fetch)}connect(){if(!(this.isConnecting()||this.isDisconnecting()||this.conn!==null&&this.isConnected())){if(this._setConnectionState("connecting"),this.accessToken&&!this._authPromise&&this._setAuthSafely("connect"),this.transport)this.conn=new this.transport(this.endpointURL());else try{this.conn=Ts.createWebSocket(this.endpointURL())}catch(e){this._setConnectionState("disconnected");const s=e.message;throw s.includes("Node.js")?new Error(`${s}

To use Realtime in Node.js, you need to provide a WebSocket implementation:

Option 1: Use Node.js 22+ which has native WebSocket support
Option 2: Install and provide the "ws" package:

  npm install ws

  import ws from "ws"
  const client = new RealtimeClient(url, {
    ...options,
    transport: ws
  })`):new Error(`WebSocket not available: ${s}`)}this._setupConnectionHandlers()}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:this.vsn}))}disconnect(e,s){if(!this.isDisconnecting())if(this._setConnectionState("disconnecting",!0),this.conn){const r=setTimeout(()=>{this._setConnectionState("disconnected")},100);this.conn.onclose=()=>{clearTimeout(r),this._setConnectionState("disconnected")},typeof this.conn.close=="function"&&(e?this.conn.close(e,s??""):this.conn.close()),this._teardownConnection()}else this._setConnectionState("disconnected")}getChannels(){return this.channels}async removeChannel(e){const s=await e.unsubscribe();return this.channels.length===0&&this.disconnect(),s}async removeAllChannels(){const e=await Promise.all(this.channels.map(s=>s.unsubscribe()));return this.channels=[],this.disconnect(),e}log(e,s,r){this.logger(e,s,r)}connectionState(){switch(this.conn&&this.conn.readyState){case te.connecting:return ae.Connecting;case te.open:return ae.Open;case te.closing:return ae.Closing;default:return ae.Closed}}isConnected(){return this.connectionState()===ae.Open}isConnecting(){return this._connectionState==="connecting"}isDisconnecting(){return this._connectionState==="disconnecting"}channel(e,s={config:{}}){const r=`realtime:${e}`,i=this.getChannels().find(n=>n.topic===r);if(i)return i;{const n=new we(`realtime:${e}`,s,this);return this.channels.push(n),n}}push(e){const{topic:s,event:r,payload:i,ref:n}=e,a=()=>{this.encode(e,o=>{var l;(l=this.conn)===null||l===void 0||l.send(o)})};this.log("push",`${s} ${r} (${n})`,i),this.isConnected()?a():this.sendBuffer.push(a)}async setAuth(e=null){this._authPromise=this._performAuth(e);try{await this._authPromise}finally{this._authPromise=null}}_isManualToken(){return this._manuallySetToken}async sendHeartbeat(){var e;if(!this.isConnected()){try{this.heartbeatCallback("disconnected")}catch(s){this.log("error","error in heartbeat callback",s)}return}if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this._heartbeatSentAt=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection");try{this.heartbeatCallback("timeout")}catch(s){this.log("error","error in heartbeat callback",s)}this._wasManualDisconnect=!1,(e=this.conn)===null||e===void 0||e.close(Ls,"heartbeat timeout"),setTimeout(()=>{var s;this.isConnected()||(s=this.reconnectTimer)===null||s===void 0||s.scheduleTimeout()},Ue.HEARTBEAT_TIMEOUT_FALLBACK);return}this._heartbeatSentAt=Date.now(),this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef});try{this.heartbeatCallback("sent")}catch(s){this.log("error","error in heartbeat callback",s)}this._setAuthSafely("heartbeat")}onHeartbeat(e){this.heartbeatCallback=e}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let s=this.channels.find(r=>r.topic===e&&(r._isJoined()||r._isJoining()));s&&(this.log("transport",`leaving duplicate topic "${e}"`),s.unsubscribe())}_remove(e){this.channels=this.channels.filter(s=>s.topic!==e.topic)}_onConnMessage(e){this.decode(e.data,s=>{if(s.topic==="phoenix"&&s.event==="phx_reply"&&s.ref&&s.ref===this.pendingHeartbeatRef){const c=this._heartbeatSentAt?Date.now()-this._heartbeatSentAt:void 0;try{this.heartbeatCallback(s.payload.status==="ok"?"ok":"error",c)}catch(u){this.log("error","error in heartbeat callback",u)}this._heartbeatSentAt=null,this.pendingHeartbeatRef=null}const{topic:r,event:i,payload:n,ref:a}=s,o=a?`(${a})`:"",l=n.status||"";this.log("receive",`${l} ${r} ${i} ${o}`.trim(),n),this.channels.filter(c=>c._isMember(r)).forEach(c=>c._trigger(i,n,a)),this._triggerStateCallbacks("message",s)})}_clearTimer(e){var s;e==="heartbeat"&&this.heartbeatTimer?(clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0):e==="reconnect"&&((s=this.reconnectTimer)===null||s===void 0||s.reset())}_clearAllTimers(){this._clearTimer("heartbeat"),this._clearTimer("reconnect")}_setupConnectionHandlers(){this.conn&&("binaryType"in this.conn&&(this.conn.binaryType="arraybuffer"),this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e),this.conn.readyState===te.open&&this._onConnOpen())}_teardownConnection(){if(this.conn){if(this.conn.readyState===te.open||this.conn.readyState===te.connecting)try{this.conn.close()}catch(e){this.log("error","Error closing connection",e)}this.conn.onopen=null,this.conn.onerror=null,this.conn.onmessage=null,this.conn.onclose=null,this.conn=null}this._clearAllTimers(),this._terminateWorker(),this.channels.forEach(e=>e.teardown())}_onConnOpen(){this._setConnectionState("connected"),this.log("transport",`connected to ${this.endpointURL()}`),(this._authPromise||(this.accessToken&&!this.accessTokenValue?this.setAuth():Promise.resolve())).then(()=>{this.flushSendBuffer()}).catch(s=>{this.log("error","error waiting for auth on connect",s),this.flushSendBuffer()}),this._clearTimer("reconnect"),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this._triggerStateCallbacks("open")}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const e=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(e),this.workerRef.onerror=s=>{this.log("worker","worker error",s.message),this._terminateWorker()},this.workerRef.onmessage=s=>{s.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_terminateWorker(){this.workerRef&&(this.log("worker","terminating worker"),this.workerRef.terminate(),this.workerRef=void 0)}_onConnClose(e){var s;this._setConnectionState("disconnected"),this.log("transport","close",e),this._triggerChanError(),this._clearTimer("heartbeat"),this._wasManualDisconnect||(s=this.reconnectTimer)===null||s===void 0||s.scheduleTimeout(),this._triggerStateCallbacks("close",e)}_onConnError(e){this._setConnectionState("disconnected"),this.log("transport",`${e}`),this._triggerChanError(),this._triggerStateCallbacks("error",e);try{this.heartbeatCallback("error")}catch(s){this.log("error","error in heartbeat callback",s)}}_triggerChanError(){this.channels.forEach(e=>e._trigger(Y.error))}_appendParams(e,s){if(Object.keys(s).length===0)return e;const r=e.match(/\?/)?"&":"?",i=new URLSearchParams(s);return`${e}${r}${i}`}_workerObjectUrl(e){let s;if(e)s=e;else{const r=new Blob([qs],{type:"application/javascript"});s=URL.createObjectURL(r)}return s}_setConnectionState(e,s=!1){this._connectionState=e,e==="connecting"?this._wasManualDisconnect=!1:e==="disconnecting"&&(this._wasManualDisconnect=s)}async _performAuth(e=null){let s,r=!1;if(e)s=e,r=!0;else if(this.accessToken)try{s=await this.accessToken()}catch(i){this.log("error","Error fetching access token from callback",i),s=this.accessTokenValue}else s=this.accessTokenValue;r?this._manuallySetToken=!0:this.accessToken&&(this._manuallySetToken=!1),this.accessTokenValue!=s&&(this.accessTokenValue=s,this.channels.forEach(i=>{const n={access_token:s,version:Os};s&&i.updateJoinPayload(n),i.joinedOnce&&i._isJoined()&&i._push(Y.access_token,{access_token:s})}))}async _waitForAuthIfNeeded(){this._authPromise&&await this._authPromise}_setAuthSafely(e="general"){this._isManualToken()||this.setAuth().catch(s=>{this.log("error",`Error setting auth in ${e}`,s)})}_triggerStateCallbacks(e,s){try{this.stateChangeCallbacks[e].forEach(r=>{try{r(s)}catch(i){this.log("error",`error in ${e} callback`,i)}})}catch(r){this.log("error",`error triggering ${e} callbacks`,r)}}_setupReconnectionTimer(){this.reconnectTimer=new es(async()=>{setTimeout(async()=>{await this._waitForAuthIfNeeded(),this.isConnected()||this.connect()},Ue.RECONNECT_DELAY)},this.reconnectAfterMs)}_initializeOptions(e){var s,r,i,n,a,o,l,c,u,g,p,d;switch(this.transport=(s=e==null?void 0:e.transport)!==null&&s!==void 0?s:null,this.timeout=(r=e==null?void 0:e.timeout)!==null&&r!==void 0?r:ut,this.heartbeatIntervalMs=(i=e==null?void 0:e.heartbeatIntervalMs)!==null&&i!==void 0?i:Ue.HEARTBEAT_INTERVAL,this.worker=(n=e==null?void 0:e.worker)!==null&&n!==void 0?n:!1,this.accessToken=(a=e==null?void 0:e.accessToken)!==null&&a!==void 0?a:null,this.heartbeatCallback=(o=e==null?void 0:e.heartbeatCallback)!==null&&o!==void 0?o:rt,this.vsn=(l=e==null?void 0:e.vsn)!==null&&l!==void 0?l:It,e!=null&&e.params&&(this.params=e.params),e!=null&&e.logger&&(this.logger=e.logger),(e!=null&&e.logLevel||e!=null&&e.log_level)&&(this.logLevel=e.logLevel||e.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),this.reconnectAfterMs=(c=e==null?void 0:e.reconnectAfterMs)!==null&&c!==void 0?c:m=>Bs[m-1]||Fs,this.vsn){case Cs:this.encode=(u=e==null?void 0:e.encode)!==null&&u!==void 0?u:(m,v)=>v(JSON.stringify(m)),this.decode=(g=e==null?void 0:e.decode)!==null&&g!==void 0?g:(m,v)=>v(JSON.parse(m));break;case Zt:this.encode=(p=e==null?void 0:e.encode)!==null&&p!==void 0?p:this.serializer.encode.bind(this.serializer),this.decode=(d=e==null?void 0:e.decode)!==null&&d!==void 0?d:this.serializer.decode.bind(this.serializer);break;default:throw new Error(`Unsupported serializer version: ${this.vsn}`)}if(this.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.workerUrl=e==null?void 0:e.workerUrl}}}var Oe=class extends Error{constructor(t,e){var s;super(t),this.name="IcebergError",this.status=e.status,this.icebergType=e.icebergType,this.icebergCode=e.icebergCode,this.details=e.details,this.isCommitStateUnknown=e.icebergType==="CommitStateUnknownException"||[500,502,504].includes(e.status)&&((s=e.icebergType)==null?void 0:s.includes("CommitState"))===!0}isNotFound(){return this.status===404}isConflict(){return this.status===409}isAuthenticationTimeout(){return this.status===419}};function Hs(t,e,s){const r=new URL(e,t);if(s)for(const[i,n]of Object.entries(s))n!==void 0&&r.searchParams.set(i,n);return r.toString()}async function Vs(t){return!t||t.type==="none"?{}:t.type==="bearer"?{Authorization:`Bearer ${t.token}`}:t.type==="header"?{[t.name]:t.value}:t.type==="custom"?await t.getHeaders():{}}function Ks(t){const e=t.fetchImpl??globalThis.fetch;return{async request({method:s,path:r,query:i,body:n,headers:a}){const o=Hs(t.baseUrl,r,i),l=await Vs(t.auth),c=await e(o,{method:s,headers:{...n?{"Content-Type":"application/json"}:{},...l,...a},body:n?JSON.stringify(n):void 0}),u=await c.text(),g=(c.headers.get("content-type")||"").includes("application/json"),p=g&&u?JSON.parse(u):u;if(!c.ok){const d=g?p:void 0,m=d==null?void 0:d.error;throw new Oe((m==null?void 0:m.message)??`Request failed with status ${c.status}`,{status:c.status,icebergType:m==null?void 0:m.type,icebergCode:m==null?void 0:m.code,details:d})}return{status:c.status,headers:c.headers,data:p}}}}function Be(t){return t.join("")}var Ws=class{constructor(t,e=""){this.client=t,this.prefix=e}async listNamespaces(t){const e=t?{parent:Be(t.namespace)}:void 0;return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces`,query:e})).data.namespaces.map(r=>({namespace:r}))}async createNamespace(t,e){const s={namespace:t.namespace,properties:e==null?void 0:e.properties};return(await this.client.request({method:"POST",path:`${this.prefix}/namespaces`,body:s})).data}async dropNamespace(t){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${Be(t.namespace)}`})}async loadNamespaceMetadata(t){return{properties:(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${Be(t.namespace)}`})).data.properties}}async namespaceExists(t){try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${Be(t.namespace)}`}),!0}catch(e){if(e instanceof Oe&&e.status===404)return!1;throw e}}async createNamespaceIfNotExists(t,e){try{return await this.createNamespace(t,e)}catch(s){if(s instanceof Oe&&s.status===409)return;throw s}}};function ce(t){return t.join("")}var Gs=class{constructor(t,e="",s){this.client=t,this.prefix=e,this.accessDelegation=s}async listTables(t){return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${ce(t.namespace)}/tables`})).data.identifiers}async createTable(t,e){const s={};return this.accessDelegation&&(s["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${ce(t.namespace)}/tables`,body:e,headers:s})).data.metadata}async updateTable(t,e){const s=await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${ce(t.namespace)}/tables/${t.name}`,body:e});return{"metadata-location":s.data["metadata-location"],metadata:s.data.metadata}}async dropTable(t,e){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${ce(t.namespace)}/tables/${t.name}`,query:{purgeRequested:String((e==null?void 0:e.purge)??!1)}})}async loadTable(t){const e={};return this.accessDelegation&&(e["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${ce(t.namespace)}/tables/${t.name}`,headers:e})).data.metadata}async tableExists(t){const e={};this.accessDelegation&&(e["X-Iceberg-Access-Delegation"]=this.accessDelegation);try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${ce(t.namespace)}/tables/${t.name}`,headers:e}),!0}catch(s){if(s instanceof Oe&&s.status===404)return!1;throw s}}async createTableIfNotExists(t,e){try{return await this.createTable(t,e)}catch(s){if(s instanceof Oe&&s.status===409)return await this.loadTable({namespace:t.namespace,name:e.name});throw s}}},zs=class{constructor(t){var r;let e="v1";t.catalogName&&(e+=`/${t.catalogName}`);const s=t.baseUrl.endsWith("/")?t.baseUrl:`${t.baseUrl}/`;this.client=Ks({baseUrl:s,auth:t.auth,fetchImpl:t.fetch}),this.accessDelegation=(r=t.accessDelegation)==null?void 0:r.join(","),this.namespaceOps=new Ws(this.client,e),this.tableOps=new Gs(this.client,e,this.accessDelegation)}async listNamespaces(t){return this.namespaceOps.listNamespaces(t)}async createNamespace(t,e){return this.namespaceOps.createNamespace(t,e)}async dropNamespace(t){await this.namespaceOps.dropNamespace(t)}async loadNamespaceMetadata(t){return this.namespaceOps.loadNamespaceMetadata(t)}async listTables(t){return this.tableOps.listTables(t)}async createTable(t,e){return this.tableOps.createTable(t,e)}async updateTable(t,e){return this.tableOps.updateTable(t,e)}async dropTable(t,e){await this.tableOps.dropTable(t,e)}async loadTable(t){return this.tableOps.loadTable(t)}async namespaceExists(t){return this.namespaceOps.namespaceExists(t)}async tableExists(t){return this.tableOps.tableExists(t)}async createNamespaceIfNotExists(t,e){return this.namespaceOps.createNamespaceIfNotExists(t,e)}async createTableIfNotExists(t,e){return this.tableOps.createTableIfNotExists(t,e)}},ze=class extends Error{constructor(t,e="storage",s,r){super(t),this.__isStorageError=!0,this.namespace=e,this.name=e==="vectors"?"StorageVectorsError":"StorageError",this.status=s,this.statusCode=r}};function Je(t){return typeof t=="object"&&t!==null&&"__isStorageError"in t}var Fe=class extends ze{constructor(t,e,s,r="storage"){super(t,r,e,s),this.name=r==="vectors"?"StorageVectorsApiError":"StorageApiError",this.status=e,this.statusCode=s}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}},rs=class extends ze{constructor(t,e,s="storage"){super(t,s),this.name=s==="vectors"?"StorageVectorsUnknownError":"StorageUnknownError",this.originalError=e}};const Js=t=>t?(...e)=>t(...e):(...e)=>fetch(...e),Qs=t=>{if(typeof t!="object"||t===null)return!1;const e=Object.getPrototypeOf(t);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in t)&&!(Symbol.iterator in t)},ft=t=>{if(Array.isArray(t))return t.map(s=>ft(s));if(typeof t=="function"||t!==Object(t))return t;const e={};return Object.entries(t).forEach(([s,r])=>{const i=s.replace(/([-_][a-z])/gi,n=>n.toUpperCase().replace(/[-_]/g,""));e[i]=ft(r)}),e},Ys=t=>!t||typeof t!="string"||t.length===0||t.length>100||t.trim()!==t||t.includes("/")||t.includes("\\")?!1:/^[\w!.\*'() &$@=;:+,?-]+$/.test(t);function Ce(t){"@babel/helpers - typeof";return Ce=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ce(t)}function Xs(t,e){if(Ce(t)!="object"||!t)return t;var s=t[Symbol.toPrimitive];if(s!==void 0){var r=s.call(t,e);if(Ce(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(t)}function Zs(t){var e=Xs(t,"string");return Ce(e)=="symbol"?e:e+""}function er(t,e,s){return(e=Zs(e))in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}function Dt(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),s.push.apply(s,r)}return s}function T(t){for(var e=1;e<arguments.length;e++){var s=arguments[e]!=null?arguments[e]:{};e%2?Dt(Object(s),!0).forEach(function(r){er(t,r,s[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):Dt(Object(s)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(s,r))})}return t}const jt=t=>{var e;return t.msg||t.message||t.error_description||(typeof t.error=="string"?t.error:(e=t.error)===null||e===void 0?void 0:e.message)||JSON.stringify(t)},tr=async(t,e,s,r)=>{if(t&&typeof t=="object"&&"status"in t&&"ok"in t&&typeof t.status=="number"&&!(s!=null&&s.noResolveJson)){const i=t,n=i.status||500;if(typeof i.json=="function")i.json().then(a=>{const o=(a==null?void 0:a.statusCode)||(a==null?void 0:a.code)||n+"";e(new Fe(jt(a),n,o,r))}).catch(()=>{if(r==="vectors"){const a=n+"";e(new Fe(i.statusText||`HTTP ${n} error`,n,a,r))}else{const a=n+"";e(new Fe(i.statusText||`HTTP ${n} error`,n,a,r))}});else{const a=n+"";e(new Fe(i.statusText||`HTTP ${n} error`,n,a,r))}}else e(new rs(jt(t),t,r))},sr=(t,e,s,r)=>{const i={method:t,headers:(e==null?void 0:e.headers)||{}};return t==="GET"||t==="HEAD"||!r?T(T({},i),s):(Qs(r)?(i.headers=T({"Content-Type":"application/json"},e==null?void 0:e.headers),i.body=JSON.stringify(r)):i.body=r,e!=null&&e.duplex&&(i.duplex=e.duplex),T(T({},i),s))};async function Ee(t,e,s,r,i,n,a){return new Promise((o,l)=>{t(s,sr(e,r,i,n)).then(c=>{if(!c.ok)throw c;if(r!=null&&r.noResolveJson)return c;if(a==="vectors"){const u=c.headers.get("content-type");if(c.headers.get("content-length")==="0"||c.status===204)return{};if(!u||!u.includes("application/json"))return{}}return c.json()}).then(c=>o(c)).catch(c=>tr(c,l,r,a))})}function ns(t="storage"){return{get:async(e,s,r,i)=>Ee(e,"GET",s,r,i,void 0,t),post:async(e,s,r,i,n)=>Ee(e,"POST",s,i,n,r,t),put:async(e,s,r,i,n)=>Ee(e,"PUT",s,i,n,r,t),head:async(e,s,r,i)=>Ee(e,"HEAD",s,T(T({},r),{},{noResolveJson:!0}),i,void 0,t),remove:async(e,s,r,i,n)=>Ee(e,"DELETE",s,i,n,r,t)}}const rr=ns("storage"),{get:Le,post:Q,put:pt,head:nr,remove:bt}=rr,z=ns("vectors");var be=class{constructor(t,e={},s,r="storage"){this.shouldThrowOnError=!1,this.url=t,this.headers=e,this.fetch=Js(s),this.namespace=r}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(t,e){return this.headers=T(T({},this.headers),{},{[t]:e}),this}async handleOperation(t){var e=this;try{return{data:await t(),error:null}}catch(s){if(e.shouldThrowOnError)throw s;if(Je(s))return{data:null,error:s};throw s}}},ir=class{constructor(t,e){this.downloadFn=t,this.shouldThrowOnError=e}then(t,e){return this.execute().then(t,e)}async execute(){var t=this;try{return{data:(await t.downloadFn()).body,error:null}}catch(e){if(t.shouldThrowOnError)throw e;if(Je(e))return{data:null,error:e};throw e}}};let is;is=Symbol.toStringTag;var ar=class{constructor(t,e){this.downloadFn=t,this.shouldThrowOnError=e,this[is]="BlobDownloadBuilder",this.promise=null}asStream(){return new ir(this.downloadFn,this.shouldThrowOnError)}then(t,e){return this.getPromise().then(t,e)}catch(t){return this.getPromise().catch(t)}finally(t){return this.getPromise().finally(t)}getPromise(){return this.promise||(this.promise=this.execute()),this.promise}async execute(){var t=this;try{return{data:await(await t.downloadFn()).blob(),error:null}}catch(e){if(t.shouldThrowOnError)throw e;if(Je(e))return{data:null,error:e};throw e}}};const or={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},Nt={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};var lr=class extends be{constructor(t,e={},s,r){super(t,e,r,"storage"),this.bucketId=s}async uploadOrUpdate(t,e,s,r){var i=this;return i.handleOperation(async()=>{let n;const a=T(T({},Nt),r);let o=T(T({},i.headers),t==="POST"&&{"x-upsert":String(a.upsert)});const l=a.metadata;typeof Blob<"u"&&s instanceof Blob?(n=new FormData,n.append("cacheControl",a.cacheControl),l&&n.append("metadata",i.encodeMetadata(l)),n.append("",s)):typeof FormData<"u"&&s instanceof FormData?(n=s,n.has("cacheControl")||n.append("cacheControl",a.cacheControl),l&&!n.has("metadata")&&n.append("metadata",i.encodeMetadata(l))):(n=s,o["cache-control"]=`max-age=${a.cacheControl}`,o["content-type"]=a.contentType,l&&(o["x-metadata"]=i.toBase64(i.encodeMetadata(l))),(typeof ReadableStream<"u"&&n instanceof ReadableStream||n&&typeof n=="object"&&"pipe"in n&&typeof n.pipe=="function")&&!a.duplex&&(a.duplex="half")),r!=null&&r.headers&&(o=T(T({},o),r.headers));const c=i._removeEmptyFolders(e),u=i._getFinalPath(c),g=await(t=="PUT"?pt:Q)(i.fetch,`${i.url}/object/${u}`,n,T({headers:o},a!=null&&a.duplex?{duplex:a.duplex}:{}));return{path:c,id:g.Id,fullPath:g.Key}})}async upload(t,e,s){return this.uploadOrUpdate("POST",t,e,s)}async uploadToSignedUrl(t,e,s,r){var i=this;const n=i._removeEmptyFolders(t),a=i._getFinalPath(n),o=new URL(i.url+`/object/upload/sign/${a}`);return o.searchParams.set("token",e),i.handleOperation(async()=>{let l;const c=T({upsert:Nt.upsert},r),u=T(T({},i.headers),{"x-upsert":String(c.upsert)});return typeof Blob<"u"&&s instanceof Blob?(l=new FormData,l.append("cacheControl",c.cacheControl),l.append("",s)):typeof FormData<"u"&&s instanceof FormData?(l=s,l.append("cacheControl",c.cacheControl)):(l=s,u["cache-control"]=`max-age=${c.cacheControl}`,u["content-type"]=c.contentType),{path:n,fullPath:(await pt(i.fetch,o.toString(),l,{headers:u})).Key}})}async createSignedUploadUrl(t,e){var s=this;return s.handleOperation(async()=>{let r=s._getFinalPath(t);const i=T({},s.headers);e!=null&&e.upsert&&(i["x-upsert"]="true");const n=await Q(s.fetch,`${s.url}/object/upload/sign/${r}`,{},{headers:i}),a=new URL(s.url+n.url),o=a.searchParams.get("token");if(!o)throw new ze("No token returned by API");return{signedUrl:a.toString(),path:t,token:o}})}async update(t,e,s){return this.uploadOrUpdate("PUT",t,e,s)}async move(t,e,s){var r=this;return r.handleOperation(async()=>await Q(r.fetch,`${r.url}/object/move`,{bucketId:r.bucketId,sourceKey:t,destinationKey:e,destinationBucket:s==null?void 0:s.destinationBucket},{headers:r.headers}))}async copy(t,e,s){var r=this;return r.handleOperation(async()=>({path:(await Q(r.fetch,`${r.url}/object/copy`,{bucketId:r.bucketId,sourceKey:t,destinationKey:e,destinationBucket:s==null?void 0:s.destinationBucket},{headers:r.headers})).Key}))}async createSignedUrl(t,e,s){var r=this;return r.handleOperation(async()=>{let i=r._getFinalPath(t),n=await Q(r.fetch,`${r.url}/object/sign/${i}`,T({expiresIn:e},s!=null&&s.transform?{transform:s.transform}:{}),{headers:r.headers});const a=s!=null&&s.download?`&download=${s.download===!0?"":s.download}`:"";return{signedUrl:encodeURI(`${r.url}${n.signedURL}${a}`)}})}async createSignedUrls(t,e,s){var r=this;return r.handleOperation(async()=>{const i=await Q(r.fetch,`${r.url}/object/sign/${r.bucketId}`,{expiresIn:e,paths:t},{headers:r.headers}),n=s!=null&&s.download?`&download=${s.download===!0?"":s.download}`:"";return i.map(a=>T(T({},a),{},{signedUrl:a.signedURL?encodeURI(`${r.url}${a.signedURL}${n}`):null}))})}download(t,e,s){const r=typeof(e==null?void 0:e.transform)<"u"?"render/image/authenticated":"object",i=this.transformOptsToQueryString((e==null?void 0:e.transform)||{}),n=i?`?${i}`:"",a=this._getFinalPath(t),o=()=>Le(this.fetch,`${this.url}/${r}/${a}${n}`,{headers:this.headers,noResolveJson:!0},s);return new ar(o,this.shouldThrowOnError)}async info(t){var e=this;const s=e._getFinalPath(t);return e.handleOperation(async()=>ft(await Le(e.fetch,`${e.url}/object/info/${s}`,{headers:e.headers})))}async exists(t){var e=this;const s=e._getFinalPath(t);try{return await nr(e.fetch,`${e.url}/object/${s}`,{headers:e.headers}),{data:!0,error:null}}catch(r){if(e.shouldThrowOnError)throw r;if(Je(r)&&r instanceof rs){const i=r.originalError;if([400,404].includes(i==null?void 0:i.status))return{data:!1,error:r}}throw r}}getPublicUrl(t,e){const s=this._getFinalPath(t),r=[],i=e!=null&&e.download?`download=${e.download===!0?"":e.download}`:"";i!==""&&r.push(i);const n=typeof(e==null?void 0:e.transform)<"u"?"render/image":"object",a=this.transformOptsToQueryString((e==null?void 0:e.transform)||{});a!==""&&r.push(a);let o=r.join("&");return o!==""&&(o=`?${o}`),{data:{publicUrl:encodeURI(`${this.url}/${n}/public/${s}${o}`)}}}async remove(t){var e=this;return e.handleOperation(async()=>await bt(e.fetch,`${e.url}/object/${e.bucketId}`,{prefixes:t},{headers:e.headers}))}async list(t,e,s){var r=this;return r.handleOperation(async()=>{const i=T(T(T({},or),e),{},{prefix:t||""});return await Q(r.fetch,`${r.url}/object/list/${r.bucketId}`,i,{headers:r.headers},s)})}async listV2(t,e){var s=this;return s.handleOperation(async()=>{const r=T({},t);return await Q(s.fetch,`${s.url}/object/list-v2/${s.bucketId}`,r,{headers:s.headers},e)})}encodeMetadata(t){return JSON.stringify(t)}toBase64(t){return typeof Buffer<"u"?Buffer.from(t).toString("base64"):btoa(t)}_getFinalPath(t){return`${this.bucketId}/${t.replace(/^\/+/,"")}`}_removeEmptyFolders(t){return t.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(t){const e=[];return t.width&&e.push(`width=${t.width}`),t.height&&e.push(`height=${t.height}`),t.resize&&e.push(`resize=${t.resize}`),t.format&&e.push(`format=${t.format}`),t.quality&&e.push(`quality=${t.quality}`),e.join("&")}};const cr="2.97.0",xe={"X-Client-Info":`storage-js/${cr}`};var ur=class extends be{constructor(t,e={},s,r){const i=new URL(t);r!=null&&r.useNewHostname&&/supabase\.(co|in|red)$/.test(i.hostname)&&!i.hostname.includes("storage.supabase.")&&(i.hostname=i.hostname.replace("supabase.","storage.supabase."));const n=i.href.replace(/\/$/,""),a=T(T({},xe),e);super(n,a,s,"storage")}async listBuckets(t){var e=this;return e.handleOperation(async()=>{const s=e.listBucketOptionsToQueryString(t);return await Le(e.fetch,`${e.url}/bucket${s}`,{headers:e.headers})})}async getBucket(t){var e=this;return e.handleOperation(async()=>await Le(e.fetch,`${e.url}/bucket/${t}`,{headers:e.headers}))}async createBucket(t,e={public:!1}){var s=this;return s.handleOperation(async()=>await Q(s.fetch,`${s.url}/bucket`,{id:t,name:t,type:e.type,public:e.public,file_size_limit:e.fileSizeLimit,allowed_mime_types:e.allowedMimeTypes},{headers:s.headers}))}async updateBucket(t,e){var s=this;return s.handleOperation(async()=>await pt(s.fetch,`${s.url}/bucket/${t}`,{id:t,name:t,public:e.public,file_size_limit:e.fileSizeLimit,allowed_mime_types:e.allowedMimeTypes},{headers:s.headers}))}async emptyBucket(t){var e=this;return e.handleOperation(async()=>await Q(e.fetch,`${e.url}/bucket/${t}/empty`,{},{headers:e.headers}))}async deleteBucket(t){var e=this;return e.handleOperation(async()=>await bt(e.fetch,`${e.url}/bucket/${t}`,{},{headers:e.headers}))}listBucketOptionsToQueryString(t){const e={};return t&&("limit"in t&&(e.limit=String(t.limit)),"offset"in t&&(e.offset=String(t.offset)),t.search&&(e.search=t.search),t.sortColumn&&(e.sortColumn=t.sortColumn),t.sortOrder&&(e.sortOrder=t.sortOrder)),Object.keys(e).length>0?"?"+new URLSearchParams(e).toString():""}},dr=class extends be{constructor(t,e={},s){const r=t.replace(/\/$/,""),i=T(T({},xe),e);super(r,i,s,"storage")}async createBucket(t){var e=this;return e.handleOperation(async()=>await Q(e.fetch,`${e.url}/bucket`,{name:t},{headers:e.headers}))}async listBuckets(t){var e=this;return e.handleOperation(async()=>{const s=new URLSearchParams;(t==null?void 0:t.limit)!==void 0&&s.set("limit",t.limit.toString()),(t==null?void 0:t.offset)!==void 0&&s.set("offset",t.offset.toString()),t!=null&&t.sortColumn&&s.set("sortColumn",t.sortColumn),t!=null&&t.sortOrder&&s.set("sortOrder",t.sortOrder),t!=null&&t.search&&s.set("search",t.search);const r=s.toString(),i=r?`${e.url}/bucket?${r}`:`${e.url}/bucket`;return await Le(e.fetch,i,{headers:e.headers})})}async deleteBucket(t){var e=this;return e.handleOperation(async()=>await bt(e.fetch,`${e.url}/bucket/${t}`,{},{headers:e.headers}))}from(t){var e=this;if(!Ys(t))throw new ze("Invalid bucket name: File, folder, and bucket names must follow AWS object key naming guidelines and should avoid the use of any other characters.");const s=new zs({baseUrl:this.url,catalogName:t,auth:{type:"custom",getHeaders:async()=>e.headers},fetch:this.fetch}),r=this.shouldThrowOnError;return new Proxy(s,{get(i,n){const a=i[n];return typeof a!="function"?a:async(...o)=>{try{return{data:await a.apply(i,o),error:null}}catch(l){if(r)throw l;return{data:null,error:l}}}}})}},hr=class extends be{constructor(t,e={},s){const r=t.replace(/\/$/,""),i=T(T({},xe),{},{"Content-Type":"application/json"},e);super(r,i,s,"vectors")}async createIndex(t){var e=this;return e.handleOperation(async()=>await z.post(e.fetch,`${e.url}/CreateIndex`,t,{headers:e.headers})||{})}async getIndex(t,e){var s=this;return s.handleOperation(async()=>await z.post(s.fetch,`${s.url}/GetIndex`,{vectorBucketName:t,indexName:e},{headers:s.headers}))}async listIndexes(t){var e=this;return e.handleOperation(async()=>await z.post(e.fetch,`${e.url}/ListIndexes`,t,{headers:e.headers}))}async deleteIndex(t,e){var s=this;return s.handleOperation(async()=>await z.post(s.fetch,`${s.url}/DeleteIndex`,{vectorBucketName:t,indexName:e},{headers:s.headers})||{})}},fr=class extends be{constructor(t,e={},s){const r=t.replace(/\/$/,""),i=T(T({},xe),{},{"Content-Type":"application/json"},e);super(r,i,s,"vectors")}async putVectors(t){var e=this;if(t.vectors.length<1||t.vectors.length>500)throw new Error("Vector batch size must be between 1 and 500 items");return e.handleOperation(async()=>await z.post(e.fetch,`${e.url}/PutVectors`,t,{headers:e.headers})||{})}async getVectors(t){var e=this;return e.handleOperation(async()=>await z.post(e.fetch,`${e.url}/GetVectors`,t,{headers:e.headers}))}async listVectors(t){var e=this;if(t.segmentCount!==void 0){if(t.segmentCount<1||t.segmentCount>16)throw new Error("segmentCount must be between 1 and 16");if(t.segmentIndex!==void 0&&(t.segmentIndex<0||t.segmentIndex>=t.segmentCount))throw new Error(`segmentIndex must be between 0 and ${t.segmentCount-1}`)}return e.handleOperation(async()=>await z.post(e.fetch,`${e.url}/ListVectors`,t,{headers:e.headers}))}async queryVectors(t){var e=this;return e.handleOperation(async()=>await z.post(e.fetch,`${e.url}/QueryVectors`,t,{headers:e.headers}))}async deleteVectors(t){var e=this;if(t.keys.length<1||t.keys.length>500)throw new Error("Keys batch size must be between 1 and 500 items");return e.handleOperation(async()=>await z.post(e.fetch,`${e.url}/DeleteVectors`,t,{headers:e.headers})||{})}},pr=class extends be{constructor(t,e={},s){const r=t.replace(/\/$/,""),i=T(T({},xe),{},{"Content-Type":"application/json"},e);super(r,i,s,"vectors")}async createBucket(t){var e=this;return e.handleOperation(async()=>await z.post(e.fetch,`${e.url}/CreateVectorBucket`,{vectorBucketName:t},{headers:e.headers})||{})}async getBucket(t){var e=this;return e.handleOperation(async()=>await z.post(e.fetch,`${e.url}/GetVectorBucket`,{vectorBucketName:t},{headers:e.headers}))}async listBuckets(t={}){var e=this;return e.handleOperation(async()=>await z.post(e.fetch,`${e.url}/ListVectorBuckets`,t,{headers:e.headers}))}async deleteBucket(t){var e=this;return e.handleOperation(async()=>await z.post(e.fetch,`${e.url}/DeleteVectorBucket`,{vectorBucketName:t},{headers:e.headers})||{})}},gr=class extends pr{constructor(t,e={}){super(t,e.headers||{},e.fetch)}from(t){return new mr(this.url,this.headers,t,this.fetch)}async createBucket(t){var e=()=>super.createBucket,s=this;return e().call(s,t)}async getBucket(t){var e=()=>super.getBucket,s=this;return e().call(s,t)}async listBuckets(t={}){var e=()=>super.listBuckets,s=this;return e().call(s,t)}async deleteBucket(t){var e=()=>super.deleteBucket,s=this;return e().call(s,t)}},mr=class extends hr{constructor(t,e,s,r){super(t,e,r),this.vectorBucketName=s}async createIndex(t){var e=()=>super.createIndex,s=this;return e().call(s,T(T({},t),{},{vectorBucketName:s.vectorBucketName}))}async listIndexes(t={}){var e=()=>super.listIndexes,s=this;return e().call(s,T(T({},t),{},{vectorBucketName:s.vectorBucketName}))}async getIndex(t){var e=()=>super.getIndex,s=this;return e().call(s,s.vectorBucketName,t)}async deleteIndex(t){var e=()=>super.deleteIndex,s=this;return e().call(s,s.vectorBucketName,t)}index(t){return new yr(this.url,this.headers,this.vectorBucketName,t,this.fetch)}},yr=class extends fr{constructor(t,e,s,r,i){super(t,e,i),this.vectorBucketName=s,this.indexName=r}async putVectors(t){var e=()=>super.putVectors,s=this;return e().call(s,T(T({},t),{},{vectorBucketName:s.vectorBucketName,indexName:s.indexName}))}async getVectors(t){var e=()=>super.getVectors,s=this;return e().call(s,T(T({},t),{},{vectorBucketName:s.vectorBucketName,indexName:s.indexName}))}async listVectors(t={}){var e=()=>super.listVectors,s=this;return e().call(s,T(T({},t),{},{vectorBucketName:s.vectorBucketName,indexName:s.indexName}))}async queryVectors(t){var e=()=>super.queryVectors,s=this;return e().call(s,T(T({},t),{},{vectorBucketName:s.vectorBucketName,indexName:s.indexName}))}async deleteVectors(t){var e=()=>super.deleteVectors,s=this;return e().call(s,T(T({},t),{},{vectorBucketName:s.vectorBucketName,indexName:s.indexName}))}},wr=class extends ur{constructor(t,e={},s,r){super(t,e,s,r)}from(t){return new lr(this.url,this.headers,t,this.fetch)}get vectors(){return new gr(this.url+"/vector",{headers:this.headers,fetch:this.fetch})}get analytics(){return new dr(this.url+"/iceberg",this.headers,this.fetch)}};const as="2.97.0",me=30*1e3,gt=3,nt=gt*me,vr="http://localhost:9999",br="supabase.auth.token",_r={"X-Client-Info":`gotrue-js/${as}`},mt="X-Supabase-Api-Version",os={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}},Sr=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i,Er=10*60*1e3;class Ie extends Error{constructor(e,s,r){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=s,this.code=r}}function A(t){return typeof t=="object"&&t!==null&&"__isAuthError"in t}class kr extends Ie{constructor(e,s,r){super(e,s,r),this.name="AuthApiError",this.status=s,this.code=r}}function Ar(t){return A(t)&&t.name==="AuthApiError"}class oe extends Ie{constructor(e,s){super(e),this.name="AuthUnknownError",this.originalError=s}}class ee extends Ie{constructor(e,s,r,i){super(e,r,i),this.name=s,this.status=r}}class G extends ee{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}function it(t){return A(t)&&t.name==="AuthSessionMissingError"}class ue extends ee{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class qe extends ee{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}}class Me extends ee{constructor(e,s=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=s}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}function Tr(t){return A(t)&&t.name==="AuthImplicitGrantRedirectError"}class Ut extends ee{constructor(e,s=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=s}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class Rr extends ee{constructor(){super("PKCE code verifier not found in storage. This can happen if the auth flow was initiated in a different browser or device, or if the storage was cleared. For SSR frameworks (Next.js, SvelteKit, etc.), use @supabase/ssr on both the server and client to store the code verifier in cookies.","AuthPKCECodeVerifierMissingError",400,"pkce_code_verifier_not_found")}}class yt extends ee{constructor(e,s){super(e,"AuthRetryableFetchError",s,void 0)}}function at(t){return A(t)&&t.name==="AuthRetryableFetchError"}class Bt extends ee{constructor(e,s,r){super(e,"AuthWeakPasswordError",s,"weak_password"),this.reasons=r}}class wt extends ee{constructor(e){super(e,"AuthInvalidJwtError",400,"invalid_jwt")}}const Ve="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),Ft=` 	
\r=`.split(""),Or=(()=>{const t=new Array(128);for(let e=0;e<t.length;e+=1)t[e]=-1;for(let e=0;e<Ft.length;e+=1)t[Ft[e].charCodeAt(0)]=-2;for(let e=0;e<Ve.length;e+=1)t[Ve[e].charCodeAt(0)]=e;return t})();function qt(t,e,s){if(t!==null)for(e.queue=e.queue<<8|t,e.queuedBits+=8;e.queuedBits>=6;){const r=e.queue>>e.queuedBits-6&63;s(Ve[r]),e.queuedBits-=6}else if(e.queuedBits>0)for(e.queue=e.queue<<6-e.queuedBits,e.queuedBits=6;e.queuedBits>=6;){const r=e.queue>>e.queuedBits-6&63;s(Ve[r]),e.queuedBits-=6}}function ls(t,e,s){const r=Or[t];if(r>-1)for(e.queue=e.queue<<6|r,e.queuedBits+=6;e.queuedBits>=8;)s(e.queue>>e.queuedBits-8&255),e.queuedBits-=8;else{if(r===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(t)}"`)}}function Mt(t){const e=[],s=a=>{e.push(String.fromCodePoint(a))},r={utf8seq:0,codepoint:0},i={queue:0,queuedBits:0},n=a=>{Ir(a,r,s)};for(let a=0;a<t.length;a+=1)ls(t.charCodeAt(a),i,n);return e.join("")}function Cr(t,e){if(t<=127){e(t);return}else if(t<=2047){e(192|t>>6),e(128|t&63);return}else if(t<=65535){e(224|t>>12),e(128|t>>6&63),e(128|t&63);return}else if(t<=1114111){e(240|t>>18),e(128|t>>12&63),e(128|t>>6&63),e(128|t&63);return}throw new Error(`Unrecognized Unicode codepoint: ${t.toString(16)}`)}function Lr(t,e){for(let s=0;s<t.length;s+=1){let r=t.charCodeAt(s);if(r>55295&&r<=56319){const i=(r-55296)*1024&65535;r=(t.charCodeAt(s+1)-56320&65535|i)+65536,s+=1}Cr(r,e)}}function Ir(t,e,s){if(e.utf8seq===0){if(t<=127){s(t);return}for(let r=1;r<6;r+=1)if(!(t>>7-r&1)){e.utf8seq=r;break}if(e.utf8seq===2)e.codepoint=t&31;else if(e.utf8seq===3)e.codepoint=t&15;else if(e.utf8seq===4)e.codepoint=t&7;else throw new Error("Invalid UTF-8 sequence");e.utf8seq-=1}else if(e.utf8seq>0){if(t<=127)throw new Error("Invalid UTF-8 sequence");e.codepoint=e.codepoint<<6|t&63,e.utf8seq-=1,e.utf8seq===0&&s(e.codepoint)}}function ve(t){const e=[],s={queue:0,queuedBits:0},r=i=>{e.push(i)};for(let i=0;i<t.length;i+=1)ls(t.charCodeAt(i),s,r);return new Uint8Array(e)}function Pr(t){const e=[];return Lr(t,s=>e.push(s)),new Uint8Array(e)}function le(t){const e=[],s={queue:0,queuedBits:0},r=i=>{e.push(i)};return t.forEach(i=>qt(i,s,r)),qt(null,s,r),e.join("")}function $r(t){return Math.round(Date.now()/1e3)+t}function xr(){return Symbol("auth-callback")}const H=()=>typeof window<"u"&&typeof document<"u",re={tested:!1,writable:!1},cs=()=>{if(!H())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(re.tested)return re.writable;const t=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(t,t),globalThis.localStorage.removeItem(t),re.tested=!0,re.writable=!0}catch{re.tested=!0,re.writable=!1}return re.writable};function Dr(t){const e={},s=new URL(t);if(s.hash&&s.hash[0]==="#")try{new URLSearchParams(s.hash.substring(1)).forEach((i,n)=>{e[n]=i})}catch{}return s.searchParams.forEach((r,i)=>{e[i]=r}),e}const us=t=>t?(...e)=>t(...e):(...e)=>fetch(...e),jr=t=>typeof t=="object"&&t!==null&&"status"in t&&"ok"in t&&"json"in t&&typeof t.json=="function",ye=async(t,e,s)=>{await t.setItem(e,JSON.stringify(s))},ne=async(t,e)=>{const s=await t.getItem(e);if(!s)return null;try{return JSON.parse(s)}catch{return s}},M=async(t,e)=>{await t.removeItem(e)};class Qe{constructor(){this.promise=new Qe.promiseConstructor((e,s)=>{this.resolve=e,this.reject=s})}}Qe.promiseConstructor=Promise;function He(t){const e=t.split(".");if(e.length!==3)throw new wt("Invalid JWT structure");for(let r=0;r<e.length;r++)if(!Sr.test(e[r]))throw new wt("JWT not in base64url format");return{header:JSON.parse(Mt(e[0])),payload:JSON.parse(Mt(e[1])),signature:ve(e[2]),raw:{header:e[0],payload:e[1]}}}async function Nr(t){return await new Promise(e=>{setTimeout(()=>e(null),t)})}function Ur(t,e){return new Promise((r,i)=>{(async()=>{for(let n=0;n<1/0;n++)try{const a=await t(n);if(!e(n,null,a)){r(a);return}}catch(a){if(!e(n,a)){i(a);return}}})()})}function Br(t){return("0"+t.toString(16)).substr(-2)}function Fr(){const e=new Uint32Array(56);if(typeof crypto>"u"){const s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",r=s.length;let i="";for(let n=0;n<56;n++)i+=s.charAt(Math.floor(Math.random()*r));return i}return crypto.getRandomValues(e),Array.from(e,Br).join("")}async function qr(t){const s=new TextEncoder().encode(t),r=await crypto.subtle.digest("SHA-256",s),i=new Uint8Array(r);return Array.from(i).map(n=>String.fromCharCode(n)).join("")}async function Mr(t){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),t;const s=await qr(t);return btoa(s).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function de(t,e,s=!1){const r=Fr();let i=r;s&&(i+="/PASSWORD_RECOVERY"),await ye(t,`${e}-code-verifier`,i);const n=await Mr(r);return[n,r===n?"plain":"s256"]}const Hr=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function Vr(t){const e=t.headers.get(mt);if(!e||!e.match(Hr))return null;try{return new Date(`${e}T00:00:00.0Z`)}catch{return null}}function Kr(t){if(!t)throw new Error("Missing exp claim");const e=Math.floor(Date.now()/1e3);if(t<=e)throw new Error("JWT has expired")}function Wr(t){switch(t){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}const Gr=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function he(t){if(!Gr.test(t))throw new Error("@supabase/auth-js: Expected parameter to be UUID but is not")}function ot(){const t={};return new Proxy(t,{get:(e,s)=>{if(s==="__isUserNotAvailableProxy")return!0;if(typeof s=="symbol"){const r=s.toString();if(r==="Symbol(Symbol.toPrimitive)"||r==="Symbol(Symbol.toStringTag)"||r==="Symbol(util.inspect.custom)")return}throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Accessing the "${s}" property of the session object is not supported. Please use getUser() instead.`)},set:(e,s)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Setting the "${s}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)},deleteProperty:(e,s)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Deleting the "${s}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)}})}function zr(t,e){return new Proxy(t,{get:(s,r,i)=>{if(r==="__isInsecureUserWarningProxy")return!0;if(typeof r=="symbol"){const n=r.toString();if(n==="Symbol(Symbol.toPrimitive)"||n==="Symbol(Symbol.toStringTag)"||n==="Symbol(util.inspect.custom)"||n==="Symbol(nodejs.util.inspect.custom)")return Reflect.get(s,r,i)}return!e.value&&typeof r=="string"&&(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),e.value=!0),Reflect.get(s,r,i)}})}function Ht(t){return JSON.parse(JSON.stringify(t))}const ie=t=>t.msg||t.message||t.error_description||t.error||JSON.stringify(t),Jr=[502,503,504];async function Vt(t){var e;if(!jr(t))throw new yt(ie(t),0);if(Jr.includes(t.status))throw new yt(ie(t),t.status);let s;try{s=await t.json()}catch(n){throw new oe(ie(n),n)}let r;const i=Vr(t);if(i&&i.getTime()>=os["2024-01-01"].timestamp&&typeof s=="object"&&s&&typeof s.code=="string"?r=s.code:typeof s=="object"&&s&&typeof s.error_code=="string"&&(r=s.error_code),r){if(r==="weak_password")throw new Bt(ie(s),t.status,((e=s.weak_password)===null||e===void 0?void 0:e.reasons)||[]);if(r==="session_not_found")throw new G}else if(typeof s=="object"&&s&&typeof s.weak_password=="object"&&s.weak_password&&Array.isArray(s.weak_password.reasons)&&s.weak_password.reasons.length&&s.weak_password.reasons.reduce((n,a)=>n&&typeof a=="string",!0))throw new Bt(ie(s),t.status,s.weak_password.reasons);throw new kr(ie(s),t.status||500,r)}const Qr=(t,e,s,r)=>{const i={method:t,headers:(e==null?void 0:e.headers)||{}};return t==="GET"?i:(i.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e==null?void 0:e.headers),i.body=JSON.stringify(r),Object.assign(Object.assign({},i),s))};async function R(t,e,s,r){var i;const n=Object.assign({},r==null?void 0:r.headers);n[mt]||(n[mt]=os["2024-01-01"].name),r!=null&&r.jwt&&(n.Authorization=`Bearer ${r.jwt}`);const a=(i=r==null?void 0:r.query)!==null&&i!==void 0?i:{};r!=null&&r.redirectTo&&(a.redirect_to=r.redirectTo);const o=Object.keys(a).length?"?"+new URLSearchParams(a).toString():"",l=await Yr(t,e,s+o,{headers:n,noResolveJson:r==null?void 0:r.noResolveJson},{},r==null?void 0:r.body);return r!=null&&r.xform?r==null?void 0:r.xform(l):{data:Object.assign({},l),error:null}}async function Yr(t,e,s,r,i,n){const a=Qr(e,r,i,n);let o;try{o=await t(s,Object.assign({},a))}catch(l){throw console.error(l),new yt(ie(l),0)}if(o.ok||await Vt(o),r!=null&&r.noResolveJson)return o;try{return await o.json()}catch(l){await Vt(l)}}function J(t){var e;let s=null;en(t)&&(s=Object.assign({},t),t.expires_at||(s.expires_at=$r(t.expires_in)));const r=(e=t.user)!==null&&e!==void 0?e:t;return{data:{session:s,user:r},error:null}}function Kt(t){const e=J(t);return!e.error&&t.weak_password&&typeof t.weak_password=="object"&&Array.isArray(t.weak_password.reasons)&&t.weak_password.reasons.length&&t.weak_password.message&&typeof t.weak_password.message=="string"&&t.weak_password.reasons.reduce((s,r)=>s&&typeof r=="string",!0)&&(e.data.weak_password=t.weak_password),e}function se(t){var e;return{data:{user:(e=t.user)!==null&&e!==void 0?e:t},error:null}}function Xr(t){return{data:t,error:null}}function Zr(t){const{action_link:e,email_otp:s,hashed_token:r,redirect_to:i,verification_type:n}=t,a=Ge(t,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),o={action_link:e,email_otp:s,hashed_token:r,redirect_to:i,verification_type:n},l=Object.assign({},a);return{data:{properties:o,user:l},error:null}}function Wt(t){return t}function en(t){return t.access_token&&t.refresh_token&&t.expires_in}const lt=["global","local","others"];class tn{constructor({url:e="",headers:s={},fetch:r}){this.url=e,this.headers=s,this.fetch=us(r),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)},this.oauth={listClients:this._listOAuthClients.bind(this),createClient:this._createOAuthClient.bind(this),getClient:this._getOAuthClient.bind(this),updateClient:this._updateOAuthClient.bind(this),deleteClient:this._deleteOAuthClient.bind(this),regenerateClientSecret:this._regenerateOAuthClientSecret.bind(this)}}async signOut(e,s=lt[0]){if(lt.indexOf(s)<0)throw new Error(`@supabase/auth-js: Parameter scope must be one of ${lt.join(", ")}`);try{return await R(this.fetch,"POST",`${this.url}/logout?scope=${s}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(r){if(A(r))return{data:null,error:r};throw r}}async inviteUserByEmail(e,s={}){try{return await R(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:s.data},headers:this.headers,redirectTo:s.redirectTo,xform:se})}catch(r){if(A(r))return{data:{user:null},error:r};throw r}}async generateLink(e){try{const{options:s}=e,r=Ge(e,["options"]),i=Object.assign(Object.assign({},r),s);return"newEmail"in r&&(i.new_email=r==null?void 0:r.newEmail,delete i.newEmail),await R(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:i,headers:this.headers,xform:Zr,redirectTo:s==null?void 0:s.redirectTo})}catch(s){if(A(s))return{data:{properties:null,user:null},error:s};throw s}}async createUser(e){try{return await R(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:se})}catch(s){if(A(s))return{data:{user:null},error:s};throw s}}async listUsers(e){var s,r,i,n,a,o,l;try{const c={nextPage:null,lastPage:0,total:0},u=await R(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(r=(s=e==null?void 0:e.page)===null||s===void 0?void 0:s.toString())!==null&&r!==void 0?r:"",per_page:(n=(i=e==null?void 0:e.perPage)===null||i===void 0?void 0:i.toString())!==null&&n!==void 0?n:""},xform:Wt});if(u.error)throw u.error;const g=await u.json(),p=(a=u.headers.get("x-total-count"))!==null&&a!==void 0?a:0,d=(l=(o=u.headers.get("link"))===null||o===void 0?void 0:o.split(","))!==null&&l!==void 0?l:[];return d.length>0&&(d.forEach(m=>{const v=parseInt(m.split(";")[0].split("=")[1].substring(0,1)),b=JSON.parse(m.split(";")[1].split("=")[1]);c[`${b}Page`]=v}),c.total=parseInt(p)),{data:Object.assign(Object.assign({},g),c),error:null}}catch(c){if(A(c))return{data:{users:[]},error:c};throw c}}async getUserById(e){he(e);try{return await R(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:se})}catch(s){if(A(s))return{data:{user:null},error:s};throw s}}async updateUserById(e,s){he(e);try{return await R(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:s,headers:this.headers,xform:se})}catch(r){if(A(r))return{data:{user:null},error:r};throw r}}async deleteUser(e,s=!1){he(e);try{return await R(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:s},xform:se})}catch(r){if(A(r))return{data:{user:null},error:r};throw r}}async _listFactors(e){he(e.userId);try{const{data:s,error:r}=await R(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:i=>({data:{factors:i},error:null})});return{data:s,error:r}}catch(s){if(A(s))return{data:null,error:s};throw s}}async _deleteFactor(e){he(e.userId),he(e.id);try{return{data:await R(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(s){if(A(s))return{data:null,error:s};throw s}}async _listOAuthClients(e){var s,r,i,n,a,o,l;try{const c={nextPage:null,lastPage:0,total:0},u=await R(this.fetch,"GET",`${this.url}/admin/oauth/clients`,{headers:this.headers,noResolveJson:!0,query:{page:(r=(s=e==null?void 0:e.page)===null||s===void 0?void 0:s.toString())!==null&&r!==void 0?r:"",per_page:(n=(i=e==null?void 0:e.perPage)===null||i===void 0?void 0:i.toString())!==null&&n!==void 0?n:""},xform:Wt});if(u.error)throw u.error;const g=await u.json(),p=(a=u.headers.get("x-total-count"))!==null&&a!==void 0?a:0,d=(l=(o=u.headers.get("link"))===null||o===void 0?void 0:o.split(","))!==null&&l!==void 0?l:[];return d.length>0&&(d.forEach(m=>{const v=parseInt(m.split(";")[0].split("=")[1].substring(0,1)),b=JSON.parse(m.split(";")[1].split("=")[1]);c[`${b}Page`]=v}),c.total=parseInt(p)),{data:Object.assign(Object.assign({},g),c),error:null}}catch(c){if(A(c))return{data:{clients:[]},error:c};throw c}}async _createOAuthClient(e){try{return await R(this.fetch,"POST",`${this.url}/admin/oauth/clients`,{body:e,headers:this.headers,xform:s=>({data:s,error:null})})}catch(s){if(A(s))return{data:null,error:s};throw s}}async _getOAuthClient(e){try{return await R(this.fetch,"GET",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,xform:s=>({data:s,error:null})})}catch(s){if(A(s))return{data:null,error:s};throw s}}async _updateOAuthClient(e,s){try{return await R(this.fetch,"PUT",`${this.url}/admin/oauth/clients/${e}`,{body:s,headers:this.headers,xform:r=>({data:r,error:null})})}catch(r){if(A(r))return{data:null,error:r};throw r}}async _deleteOAuthClient(e){try{return await R(this.fetch,"DELETE",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,noResolveJson:!0}),{data:null,error:null}}catch(s){if(A(s))return{data:null,error:s};throw s}}async _regenerateOAuthClientSecret(e){try{return await R(this.fetch,"POST",`${this.url}/admin/oauth/clients/${e}/regenerate_secret`,{headers:this.headers,xform:s=>({data:s,error:null})})}catch(s){if(A(s))return{data:null,error:s};throw s}}}function Gt(t={}){return{getItem:e=>t[e]||null,setItem:(e,s)=>{t[e]=s},removeItem:e=>{delete t[e]}}}const fe={debug:!!(globalThis&&cs()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class ds extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class zt extends ds{}async function sn(t,e,s){fe.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",t,e);const r=new globalThis.AbortController;e>0&&setTimeout(()=>{r.abort(),fe.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",t)},e),await Promise.resolve();try{return await globalThis.navigator.locks.request(t,e===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:r.signal},async i=>{if(i){fe.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",t,i.name);try{return await s()}finally{fe.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",t,i.name)}}else{if(e===0)throw fe.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",t),new zt(`Acquiring an exclusive Navigator LockManager lock "${t}" immediately failed`);if(fe.debug)try{const n=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(n,null,"  "))}catch(n){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",n)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await s()}})}catch(i){throw(i==null?void 0:i.name)==="AbortError"?new zt(`Acquiring an exclusive Navigator LockManager lock "${t}" timed out waiting ${e}ms`):i}}function rn(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}function hs(t){if(!/^0x[a-fA-F0-9]{40}$/.test(t))throw new Error(`@supabase/auth-js: Address "${t}" is invalid.`);return t.toLowerCase()}function nn(t){return parseInt(t,16)}function an(t){const e=new TextEncoder().encode(t);return"0x"+Array.from(e,r=>r.toString(16).padStart(2,"0")).join("")}function on(t){var e;const{chainId:s,domain:r,expirationTime:i,issuedAt:n=new Date,nonce:a,notBefore:o,requestId:l,resources:c,scheme:u,uri:g,version:p}=t;{if(!Number.isInteger(s))throw new Error(`@supabase/auth-js: Invalid SIWE message field "chainId". Chain ID must be a EIP-155 chain ID. Provided value: ${s}`);if(!r)throw new Error('@supabase/auth-js: Invalid SIWE message field "domain". Domain must be provided.');if(a&&a.length<8)throw new Error(`@supabase/auth-js: Invalid SIWE message field "nonce". Nonce must be at least 8 characters. Provided value: ${a}`);if(!g)throw new Error('@supabase/auth-js: Invalid SIWE message field "uri". URI must be provided.');if(p!=="1")throw new Error(`@supabase/auth-js: Invalid SIWE message field "version". Version must be '1'. Provided value: ${p}`);if(!((e=t.statement)===null||e===void 0)&&e.includes(`
`))throw new Error(`@supabase/auth-js: Invalid SIWE message field "statement". Statement must not include '\\n'. Provided value: ${t.statement}`)}const d=hs(t.address),m=u?`${u}://${r}`:r,v=t.statement?`${t.statement}
`:"",b=`${m} wants you to sign in with your Ethereum account:
${d}

${v}`;let E=`URI: ${g}
Version: ${p}
Chain ID: ${s}${a?`
Nonce: ${a}`:""}
Issued At: ${n.toISOString()}`;if(i&&(E+=`
Expiration Time: ${i.toISOString()}`),o&&(E+=`
Not Before: ${o.toISOString()}`),l&&(E+=`
Request ID: ${l}`),c){let w=`
Resources:`;for(const S of c){if(!S||typeof S!="string")throw new Error(`@supabase/auth-js: Invalid SIWE message field "resources". Every resource must be a valid string. Provided value: ${S}`);w+=`
- ${S}`}E+=w}return`${b}
${E}`}class F extends Error{constructor({message:e,code:s,cause:r,name:i}){var n;super(e,{cause:r}),this.__isWebAuthnError=!0,this.name=(n=i??(r instanceof Error?r.name:void 0))!==null&&n!==void 0?n:"Unknown Error",this.code=s}}class Ke extends F{constructor(e,s){super({code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:s,message:e}),this.name="WebAuthnUnknownError",this.originalError=s}}function ln({error:t,options:e}){var s,r,i;const{publicKey:n}=e;if(!n)throw Error("options was missing required publicKey property");if(t.name==="AbortError"){if(e.signal instanceof AbortSignal)return new F({message:"Registration ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:t})}else if(t.name==="ConstraintError"){if(((s=n.authenticatorSelection)===null||s===void 0?void 0:s.requireResidentKey)===!0)return new F({message:"Discoverable credentials were required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_DISCOVERABLE_CREDENTIAL_SUPPORT",cause:t});if(e.mediation==="conditional"&&((r=n.authenticatorSelection)===null||r===void 0?void 0:r.userVerification)==="required")return new F({message:"User verification was required during automatic registration but it could not be performed",code:"ERROR_AUTO_REGISTER_USER_VERIFICATION_FAILURE",cause:t});if(((i=n.authenticatorSelection)===null||i===void 0?void 0:i.userVerification)==="required")return new F({message:"User verification was required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_USER_VERIFICATION_SUPPORT",cause:t})}else{if(t.name==="InvalidStateError")return new F({message:"The authenticator was previously registered",code:"ERROR_AUTHENTICATOR_PREVIOUSLY_REGISTERED",cause:t});if(t.name==="NotAllowedError")return new F({message:t.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t});if(t.name==="NotSupportedError")return n.pubKeyCredParams.filter(o=>o.type==="public-key").length===0?new F({message:'No entry in pubKeyCredParams was of type "public-key"',code:"ERROR_MALFORMED_PUBKEYCREDPARAMS",cause:t}):new F({message:"No available authenticator supported any of the specified pubKeyCredParams algorithms",code:"ERROR_AUTHENTICATOR_NO_SUPPORTED_PUBKEYCREDPARAMS_ALG",cause:t});if(t.name==="SecurityError"){const a=window.location.hostname;if(fs(a)){if(n.rp.id!==a)return new F({message:`The RP ID "${n.rp.id}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:t})}else return new F({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:t})}else if(t.name==="TypeError"){if(n.user.id.byteLength<1||n.user.id.byteLength>64)return new F({message:"User ID was not between 1 and 64 characters",code:"ERROR_INVALID_USER_ID_LENGTH",cause:t})}else if(t.name==="UnknownError")return new F({message:"The authenticator was unable to process the specified options, or could not create a new credential",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:t})}return new F({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t})}function cn({error:t,options:e}){const{publicKey:s}=e;if(!s)throw Error("options was missing required publicKey property");if(t.name==="AbortError"){if(e.signal instanceof AbortSignal)return new F({message:"Authentication ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:t})}else{if(t.name==="NotAllowedError")return new F({message:t.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t});if(t.name==="SecurityError"){const r=window.location.hostname;if(fs(r)){if(s.rpId!==r)return new F({message:`The RP ID "${s.rpId}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:t})}else return new F({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:t})}else if(t.name==="UnknownError")return new F({message:"The authenticator was unable to process the specified options, or could not create a new assertion signature",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:t})}return new F({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t})}class un{createNewAbortSignal(){if(this.controller){const s=new Error("Cancelling existing WebAuthn API call for new one");s.name="AbortError",this.controller.abort(s)}const e=new AbortController;return this.controller=e,e.signal}cancelCeremony(){if(this.controller){const e=new Error("Manually cancelling existing WebAuthn API call");e.name="AbortError",this.controller.abort(e),this.controller=void 0}}}const dn=new un;function hn(t){if(!t)throw new Error("Credential creation options are required");if(typeof PublicKeyCredential<"u"&&"parseCreationOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseCreationOptionsFromJSON=="function")return PublicKeyCredential.parseCreationOptionsFromJSON(t);const{challenge:e,user:s,excludeCredentials:r}=t,i=Ge(t,["challenge","user","excludeCredentials"]),n=ve(e).buffer,a=Object.assign(Object.assign({},s),{id:ve(s.id).buffer}),o=Object.assign(Object.assign({},i),{challenge:n,user:a});if(r&&r.length>0){o.excludeCredentials=new Array(r.length);for(let l=0;l<r.length;l++){const c=r[l];o.excludeCredentials[l]=Object.assign(Object.assign({},c),{id:ve(c.id).buffer,type:c.type||"public-key",transports:c.transports})}}return o}function fn(t){if(!t)throw new Error("Credential request options are required");if(typeof PublicKeyCredential<"u"&&"parseRequestOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseRequestOptionsFromJSON=="function")return PublicKeyCredential.parseRequestOptionsFromJSON(t);const{challenge:e,allowCredentials:s}=t,r=Ge(t,["challenge","allowCredentials"]),i=ve(e).buffer,n=Object.assign(Object.assign({},r),{challenge:i});if(s&&s.length>0){n.allowCredentials=new Array(s.length);for(let a=0;a<s.length;a++){const o=s[a];n.allowCredentials[a]=Object.assign(Object.assign({},o),{id:ve(o.id).buffer,type:o.type||"public-key",transports:o.transports})}}return n}function pn(t){var e;if("toJSON"in t&&typeof t.toJSON=="function")return t.toJSON();const s=t;return{id:t.id,rawId:t.id,response:{attestationObject:le(new Uint8Array(t.response.attestationObject)),clientDataJSON:le(new Uint8Array(t.response.clientDataJSON))},type:"public-key",clientExtensionResults:t.getClientExtensionResults(),authenticatorAttachment:(e=s.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function gn(t){var e;if("toJSON"in t&&typeof t.toJSON=="function")return t.toJSON();const s=t,r=t.getClientExtensionResults(),i=t.response;return{id:t.id,rawId:t.id,response:{authenticatorData:le(new Uint8Array(i.authenticatorData)),clientDataJSON:le(new Uint8Array(i.clientDataJSON)),signature:le(new Uint8Array(i.signature)),userHandle:i.userHandle?le(new Uint8Array(i.userHandle)):void 0},type:"public-key",clientExtensionResults:r,authenticatorAttachment:(e=s.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function fs(t){return t==="localhost"||/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(t)}function Jt(){var t,e;return!!(H()&&"PublicKeyCredential"in window&&window.PublicKeyCredential&&"credentials"in navigator&&typeof((t=navigator==null?void 0:navigator.credentials)===null||t===void 0?void 0:t.create)=="function"&&typeof((e=navigator==null?void 0:navigator.credentials)===null||e===void 0?void 0:e.get)=="function")}async function mn(t){try{const e=await navigator.credentials.create(t);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new Ke("Browser returned unexpected credential type",e)}:{data:null,error:new Ke("Empty credential response",e)}}catch(e){return{data:null,error:ln({error:e,options:t})}}}async function yn(t){try{const e=await navigator.credentials.get(t);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new Ke("Browser returned unexpected credential type",e)}:{data:null,error:new Ke("Empty credential response",e)}}catch(e){return{data:null,error:cn({error:e,options:t})}}}const wn={hints:["security-key"],authenticatorSelection:{authenticatorAttachment:"cross-platform",requireResidentKey:!1,userVerification:"preferred",residentKey:"discouraged"},attestation:"direct"},vn={userVerification:"preferred",hints:["security-key"],attestation:"direct"};function We(...t){const e=i=>i!==null&&typeof i=="object"&&!Array.isArray(i),s=i=>i instanceof ArrayBuffer||ArrayBuffer.isView(i),r={};for(const i of t)if(i)for(const n in i){const a=i[n];if(a!==void 0)if(Array.isArray(a))r[n]=a;else if(s(a))r[n]=a;else if(e(a)){const o=r[n];e(o)?r[n]=We(o,a):r[n]=We(a)}else r[n]=a}return r}function bn(t,e){return We(wn,t,e||{})}function _n(t,e){return We(vn,t,e||{})}class Sn{constructor(e){this.client=e,this.enroll=this._enroll.bind(this),this.challenge=this._challenge.bind(this),this.verify=this._verify.bind(this),this.authenticate=this._authenticate.bind(this),this.register=this._register.bind(this)}async _enroll(e){return this.client.mfa.enroll(Object.assign(Object.assign({},e),{factorType:"webauthn"}))}async _challenge({factorId:e,webauthn:s,friendlyName:r,signal:i},n){var a;try{const{data:o,error:l}=await this.client.mfa.challenge({factorId:e,webauthn:s});if(!o)return{data:null,error:l};const c=i??dn.createNewAbortSignal();if(o.webauthn.type==="create"){const{user:u}=o.webauthn.credential_options.publicKey;if(!u.name){const g=r;if(g)u.name=`${u.id}:${g}`;else{const d=(await this.client.getUser()).data.user,m=((a=d==null?void 0:d.user_metadata)===null||a===void 0?void 0:a.name)||(d==null?void 0:d.email)||(d==null?void 0:d.id)||"User";u.name=`${u.id}:${m}`}}u.displayName||(u.displayName=u.name)}switch(o.webauthn.type){case"create":{const u=bn(o.webauthn.credential_options.publicKey,n==null?void 0:n.create),{data:g,error:p}=await mn({publicKey:u,signal:c});return g?{data:{factorId:e,challengeId:o.id,webauthn:{type:o.webauthn.type,credential_response:g}},error:null}:{data:null,error:p}}case"request":{const u=_n(o.webauthn.credential_options.publicKey,n==null?void 0:n.request),{data:g,error:p}=await yn(Object.assign(Object.assign({},o.webauthn.credential_options),{publicKey:u,signal:c}));return g?{data:{factorId:e,challengeId:o.id,webauthn:{type:o.webauthn.type,credential_response:g}},error:null}:{data:null,error:p}}}}catch(o){return A(o)?{data:null,error:o}:{data:null,error:new oe("Unexpected error in challenge",o)}}}async _verify({challengeId:e,factorId:s,webauthn:r}){return this.client.mfa.verify({factorId:s,challengeId:e,webauthn:r})}async _authenticate({factorId:e,webauthn:{rpId:s=typeof window<"u"?window.location.hostname:void 0,rpOrigins:r=typeof window<"u"?[window.location.origin]:void 0,signal:i}={}},n){if(!s)return{data:null,error:new Ie("rpId is required for WebAuthn authentication")};try{if(!Jt())return{data:null,error:new oe("Browser does not support WebAuthn",null)};const{data:a,error:o}=await this.challenge({factorId:e,webauthn:{rpId:s,rpOrigins:r},signal:i},{request:n});if(!a)return{data:null,error:o};const{webauthn:l}=a;return this._verify({factorId:e,challengeId:a.challengeId,webauthn:{type:l.type,rpId:s,rpOrigins:r,credential_response:l.credential_response}})}catch(a){return A(a)?{data:null,error:a}:{data:null,error:new oe("Unexpected error in authenticate",a)}}}async _register({friendlyName:e,webauthn:{rpId:s=typeof window<"u"?window.location.hostname:void 0,rpOrigins:r=typeof window<"u"?[window.location.origin]:void 0,signal:i}={}},n){if(!s)return{data:null,error:new Ie("rpId is required for WebAuthn registration")};try{if(!Jt())return{data:null,error:new oe("Browser does not support WebAuthn",null)};const{data:a,error:o}=await this._enroll({friendlyName:e});if(!a)return await this.client.mfa.listFactors().then(u=>{var g;return(g=u.data)===null||g===void 0?void 0:g.all.find(p=>p.factor_type==="webauthn"&&p.friendly_name===e&&p.status!=="unverified")}).then(u=>u?this.client.mfa.unenroll({factorId:u==null?void 0:u.id}):void 0),{data:null,error:o};const{data:l,error:c}=await this._challenge({factorId:a.id,friendlyName:a.friendly_name,webauthn:{rpId:s,rpOrigins:r},signal:i},{create:n});return l?this._verify({factorId:a.id,challengeId:l.challengeId,webauthn:{rpId:s,rpOrigins:r,type:l.webauthn.type,credential_response:l.webauthn.credential_response}}):{data:null,error:c}}catch(a){return A(a)?{data:null,error:a}:{data:null,error:new oe("Unexpected error in register",a)}}}}rn();const En={url:vr,storageKey:br,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:_r,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1,throwOnError:!1,lockAcquireTimeout:1e4,skipAutoInitialize:!1};async function Qt(t,e,s){return await s()}const pe={};class Pe{get jwks(){var e,s;return(s=(e=pe[this.storageKey])===null||e===void 0?void 0:e.jwks)!==null&&s!==void 0?s:{keys:[]}}set jwks(e){pe[this.storageKey]=Object.assign(Object.assign({},pe[this.storageKey]),{jwks:e})}get jwks_cached_at(){var e,s;return(s=(e=pe[this.storageKey])===null||e===void 0?void 0:e.cachedAt)!==null&&s!==void 0?s:Number.MIN_SAFE_INTEGER}set jwks_cached_at(e){pe[this.storageKey]=Object.assign(Object.assign({},pe[this.storageKey]),{cachedAt:e})}constructor(e){var s,r,i;this.userStorage=null,this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.autoRefreshTickTimeout=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log;const n=Object.assign(Object.assign({},En),e);if(this.storageKey=n.storageKey,this.instanceID=(s=Pe.nextInstanceID[this.storageKey])!==null&&s!==void 0?s:0,Pe.nextInstanceID[this.storageKey]=this.instanceID+1,this.logDebugMessages=!!n.debug,typeof n.debug=="function"&&(this.logger=n.debug),this.instanceID>0&&H()){const a=`${this._logPrefix()} Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.`;console.warn(a),this.logDebugMessages&&console.trace(a)}if(this.persistSession=n.persistSession,this.autoRefreshToken=n.autoRefreshToken,this.admin=new tn({url:n.url,headers:n.headers,fetch:n.fetch}),this.url=n.url,this.headers=n.headers,this.fetch=us(n.fetch),this.lock=n.lock||Qt,this.detectSessionInUrl=n.detectSessionInUrl,this.flowType=n.flowType,this.hasCustomAuthorizationHeader=n.hasCustomAuthorizationHeader,this.throwOnError=n.throwOnError,this.lockAcquireTimeout=n.lockAcquireTimeout,n.lock?this.lock=n.lock:this.persistSession&&H()&&(!((r=globalThis==null?void 0:globalThis.navigator)===null||r===void 0)&&r.locks)?this.lock=sn:this.lock=Qt,this.jwks||(this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER),this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this),webauthn:new Sn(this)},this.oauth={getAuthorizationDetails:this._getAuthorizationDetails.bind(this),approveAuthorization:this._approveAuthorization.bind(this),denyAuthorization:this._denyAuthorization.bind(this),listGrants:this._listOAuthGrants.bind(this),revokeGrant:this._revokeOAuthGrant.bind(this)},this.persistSession?(n.storage?this.storage=n.storage:cs()?this.storage=globalThis.localStorage:(this.memoryStorage={},this.storage=Gt(this.memoryStorage)),n.userStorage&&(this.userStorage=n.userStorage)):(this.memoryStorage={},this.storage=Gt(this.memoryStorage)),H()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(a){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",a)}(i=this.broadcastChannel)===null||i===void 0||i.addEventListener("message",async a=>{this._debug("received broadcast notification from other tab or client",a);try{await this._notifyAllSubscribers(a.data.event,a.data.session,!1)}catch(o){this._debug("#broadcastChannel","error",o)}})}n.skipAutoInitialize||this.initialize().catch(a=>{this._debug("#initialize()","error",a)})}isThrowOnErrorEnabled(){return this.throwOnError}_returnResult(e){if(this.throwOnError&&e&&e.error)throw e.error;return e}_logPrefix(){return`GoTrueClient@${this.storageKey}:${this.instanceID} (${as}) ${new Date().toISOString()}`}_debug(...e){return this.logDebugMessages&&this.logger(this._logPrefix(),...e),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(this.lockAcquireTimeout,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var e;try{let s={},r="none";if(H()&&(s=Dr(window.location.href),this._isImplicitGrantCallback(s)?r="implicit":await this._isPKCECallback(s)&&(r="pkce")),H()&&this.detectSessionInUrl&&r!=="none"){const{data:i,error:n}=await this._getSessionFromURL(s,r);if(n){if(this._debug("#_initialize()","error detecting session from URL",n),Tr(n)){const l=(e=n.details)===null||e===void 0?void 0:e.code;if(l==="identity_already_exists"||l==="identity_not_found"||l==="single_identity_not_deletable")return{error:n}}return{error:n}}const{session:a,redirectType:o}=i;return this._debug("#_initialize()","detected session in URL",a,"redirect type",o),await this._saveSession(a),setTimeout(async()=>{o==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",a):await this._notifyAllSubscribers("SIGNED_IN",a)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(s){return A(s)?this._returnResult({error:s}):this._returnResult({error:new oe("Unexpected error during initialization",s)})}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(e){var s,r,i;try{const n=await R(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(r=(s=e==null?void 0:e.options)===null||s===void 0?void 0:s.data)!==null&&r!==void 0?r:{},gotrue_meta_security:{captcha_token:(i=e==null?void 0:e.options)===null||i===void 0?void 0:i.captchaToken}},xform:J}),{data:a,error:o}=n;if(o||!a)return this._returnResult({data:{user:null,session:null},error:o});const l=a.session,c=a.user;return a.session&&(await this._saveSession(a.session),await this._notifyAllSubscribers("SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(n){if(A(n))return this._returnResult({data:{user:null,session:null},error:n});throw n}}async signUp(e){var s,r,i;try{let n;if("email"in e){const{email:u,password:g,options:p}=e;let d=null,m=null;this.flowType==="pkce"&&([d,m]=await de(this.storage,this.storageKey)),n=await R(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:p==null?void 0:p.emailRedirectTo,body:{email:u,password:g,data:(s=p==null?void 0:p.data)!==null&&s!==void 0?s:{},gotrue_meta_security:{captcha_token:p==null?void 0:p.captchaToken},code_challenge:d,code_challenge_method:m},xform:J})}else if("phone"in e){const{phone:u,password:g,options:p}=e;n=await R(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:u,password:g,data:(r=p==null?void 0:p.data)!==null&&r!==void 0?r:{},channel:(i=p==null?void 0:p.channel)!==null&&i!==void 0?i:"sms",gotrue_meta_security:{captcha_token:p==null?void 0:p.captchaToken}},xform:J})}else throw new qe("You must provide either an email or phone number and a password");const{data:a,error:o}=n;if(o||!a)return await M(this.storage,`${this.storageKey}-code-verifier`),this._returnResult({data:{user:null,session:null},error:o});const l=a.session,c=a.user;return a.session&&(await this._saveSession(a.session),await this._notifyAllSubscribers("SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(n){if(await M(this.storage,`${this.storageKey}-code-verifier`),A(n))return this._returnResult({data:{user:null,session:null},error:n});throw n}}async signInWithPassword(e){try{let s;if("email"in e){const{email:n,password:a,options:o}=e;s=await R(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:n,password:a,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}},xform:Kt})}else if("phone"in e){const{phone:n,password:a,options:o}=e;s=await R(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:n,password:a,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}},xform:Kt})}else throw new qe("You must provide either an email or phone number and a password");const{data:r,error:i}=s;if(i)return this._returnResult({data:{user:null,session:null},error:i});if(!r||!r.session||!r.user){const n=new ue;return this._returnResult({data:{user:null,session:null},error:n})}return r.session&&(await this._saveSession(r.session),await this._notifyAllSubscribers("SIGNED_IN",r.session)),this._returnResult({data:Object.assign({user:r.user,session:r.session},r.weak_password?{weakPassword:r.weak_password}:null),error:i})}catch(s){if(A(s))return this._returnResult({data:{user:null,session:null},error:s});throw s}}async signInWithOAuth(e){var s,r,i,n;return await this._handleProviderSignIn(e.provider,{redirectTo:(s=e.options)===null||s===void 0?void 0:s.redirectTo,scopes:(r=e.options)===null||r===void 0?void 0:r.scopes,queryParams:(i=e.options)===null||i===void 0?void 0:i.queryParams,skipBrowserRedirect:(n=e.options)===null||n===void 0?void 0:n.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(this.lockAcquireTimeout,async()=>this._exchangeCodeForSession(e))}async signInWithWeb3(e){const{chain:s}=e;switch(s){case"ethereum":return await this.signInWithEthereum(e);case"solana":return await this.signInWithSolana(e);default:throw new Error(`@supabase/auth-js: Unsupported chain "${s}"`)}}async signInWithEthereum(e){var s,r,i,n,a,o,l,c,u,g,p;let d,m;if("message"in e)d=e.message,m=e.signature;else{const{chain:v,wallet:b,statement:E,options:w}=e;let S;if(H())if(typeof b=="object")S=b;else{const K=window;if("ethereum"in K&&typeof K.ethereum=="object"&&"request"in K.ethereum&&typeof K.ethereum.request=="function")S=K.ethereum;else throw new Error("@supabase/auth-js: No compatible Ethereum wallet interface on the window object (window.ethereum) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'ethereum', wallet: resolvedUserWallet }) instead.")}else{if(typeof b!="object"||!(w!=null&&w.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");S=b}const O=new URL((s=w==null?void 0:w.url)!==null&&s!==void 0?s:window.location.href),D=await S.request({method:"eth_requestAccounts"}).then(K=>K).catch(()=>{throw new Error("@supabase/auth-js: Wallet method eth_requestAccounts is missing or invalid")});if(!D||D.length===0)throw new Error("@supabase/auth-js: No accounts available. Please ensure the wallet is connected.");const P=hs(D[0]);let U=(r=w==null?void 0:w.signInWithEthereum)===null||r===void 0?void 0:r.chainId;if(!U){const K=await S.request({method:"eth_chainId"});U=nn(K)}const V={domain:O.host,address:P,statement:E,uri:O.href,version:"1",chainId:U,nonce:(i=w==null?void 0:w.signInWithEthereum)===null||i===void 0?void 0:i.nonce,issuedAt:(a=(n=w==null?void 0:w.signInWithEthereum)===null||n===void 0?void 0:n.issuedAt)!==null&&a!==void 0?a:new Date,expirationTime:(o=w==null?void 0:w.signInWithEthereum)===null||o===void 0?void 0:o.expirationTime,notBefore:(l=w==null?void 0:w.signInWithEthereum)===null||l===void 0?void 0:l.notBefore,requestId:(c=w==null?void 0:w.signInWithEthereum)===null||c===void 0?void 0:c.requestId,resources:(u=w==null?void 0:w.signInWithEthereum)===null||u===void 0?void 0:u.resources};d=on(V),m=await S.request({method:"personal_sign",params:[an(d),P]})}try{const{data:v,error:b}=await R(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"ethereum",message:d,signature:m},!((g=e.options)===null||g===void 0)&&g.captchaToken?{gotrue_meta_security:{captcha_token:(p=e.options)===null||p===void 0?void 0:p.captchaToken}}:null),xform:J});if(b)throw b;if(!v||!v.session||!v.user){const E=new ue;return this._returnResult({data:{user:null,session:null},error:E})}return v.session&&(await this._saveSession(v.session),await this._notifyAllSubscribers("SIGNED_IN",v.session)),this._returnResult({data:Object.assign({},v),error:b})}catch(v){if(A(v))return this._returnResult({data:{user:null,session:null},error:v});throw v}}async signInWithSolana(e){var s,r,i,n,a,o,l,c,u,g,p,d;let m,v;if("message"in e)m=e.message,v=e.signature;else{const{chain:b,wallet:E,statement:w,options:S}=e;let O;if(H())if(typeof E=="object")O=E;else{const P=window;if("solana"in P&&typeof P.solana=="object"&&("signIn"in P.solana&&typeof P.solana.signIn=="function"||"signMessage"in P.solana&&typeof P.solana.signMessage=="function"))O=P.solana;else throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.")}else{if(typeof E!="object"||!(S!=null&&S.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");O=E}const D=new URL((s=S==null?void 0:S.url)!==null&&s!==void 0?s:window.location.href);if("signIn"in O&&O.signIn){const P=await O.signIn(Object.assign(Object.assign(Object.assign({issuedAt:new Date().toISOString()},S==null?void 0:S.signInWithSolana),{version:"1",domain:D.host,uri:D.href}),w?{statement:w}:null));let U;if(Array.isArray(P)&&P[0]&&typeof P[0]=="object")U=P[0];else if(P&&typeof P=="object"&&"signedMessage"in P&&"signature"in P)U=P;else throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");if("signedMessage"in U&&"signature"in U&&(typeof U.signedMessage=="string"||U.signedMessage instanceof Uint8Array)&&U.signature instanceof Uint8Array)m=typeof U.signedMessage=="string"?U.signedMessage:new TextDecoder().decode(U.signedMessage),v=U.signature;else throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields")}else{if(!("signMessage"in O)||typeof O.signMessage!="function"||!("publicKey"in O)||typeof O!="object"||!O.publicKey||!("toBase58"in O.publicKey)||typeof O.publicKey.toBase58!="function")throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");m=[`${D.host} wants you to sign in with your Solana account:`,O.publicKey.toBase58(),...w?["",w,""]:[""],"Version: 1",`URI: ${D.href}`,`Issued At: ${(i=(r=S==null?void 0:S.signInWithSolana)===null||r===void 0?void 0:r.issuedAt)!==null&&i!==void 0?i:new Date().toISOString()}`,...!((n=S==null?void 0:S.signInWithSolana)===null||n===void 0)&&n.notBefore?[`Not Before: ${S.signInWithSolana.notBefore}`]:[],...!((a=S==null?void 0:S.signInWithSolana)===null||a===void 0)&&a.expirationTime?[`Expiration Time: ${S.signInWithSolana.expirationTime}`]:[],...!((o=S==null?void 0:S.signInWithSolana)===null||o===void 0)&&o.chainId?[`Chain ID: ${S.signInWithSolana.chainId}`]:[],...!((l=S==null?void 0:S.signInWithSolana)===null||l===void 0)&&l.nonce?[`Nonce: ${S.signInWithSolana.nonce}`]:[],...!((c=S==null?void 0:S.signInWithSolana)===null||c===void 0)&&c.requestId?[`Request ID: ${S.signInWithSolana.requestId}`]:[],...!((g=(u=S==null?void 0:S.signInWithSolana)===null||u===void 0?void 0:u.resources)===null||g===void 0)&&g.length?["Resources",...S.signInWithSolana.resources.map(U=>`- ${U}`)]:[]].join(`
`);const P=await O.signMessage(new TextEncoder().encode(m),"utf8");if(!P||!(P instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");v=P}}try{const{data:b,error:E}=await R(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:m,signature:le(v)},!((p=e.options)===null||p===void 0)&&p.captchaToken?{gotrue_meta_security:{captcha_token:(d=e.options)===null||d===void 0?void 0:d.captchaToken}}:null),xform:J});if(E)throw E;if(!b||!b.session||!b.user){const w=new ue;return this._returnResult({data:{user:null,session:null},error:w})}return b.session&&(await this._saveSession(b.session),await this._notifyAllSubscribers("SIGNED_IN",b.session)),this._returnResult({data:Object.assign({},b),error:E})}catch(b){if(A(b))return this._returnResult({data:{user:null,session:null},error:b});throw b}}async _exchangeCodeForSession(e){const s=await ne(this.storage,`${this.storageKey}-code-verifier`),[r,i]=(s??"").split("/");try{if(!r&&this.flowType==="pkce")throw new Rr;const{data:n,error:a}=await R(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:r},xform:J});if(await M(this.storage,`${this.storageKey}-code-verifier`),a)throw a;if(!n||!n.session||!n.user){const o=new ue;return this._returnResult({data:{user:null,session:null,redirectType:null},error:o})}return n.session&&(await this._saveSession(n.session),await this._notifyAllSubscribers("SIGNED_IN",n.session)),this._returnResult({data:Object.assign(Object.assign({},n),{redirectType:i??null}),error:a})}catch(n){if(await M(this.storage,`${this.storageKey}-code-verifier`),A(n))return this._returnResult({data:{user:null,session:null,redirectType:null},error:n});throw n}}async signInWithIdToken(e){try{const{options:s,provider:r,token:i,access_token:n,nonce:a}=e,o=await R(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:r,id_token:i,access_token:n,nonce:a,gotrue_meta_security:{captcha_token:s==null?void 0:s.captchaToken}},xform:J}),{data:l,error:c}=o;if(c)return this._returnResult({data:{user:null,session:null},error:c});if(!l||!l.session||!l.user){const u=new ue;return this._returnResult({data:{user:null,session:null},error:u})}return l.session&&(await this._saveSession(l.session),await this._notifyAllSubscribers("SIGNED_IN",l.session)),this._returnResult({data:l,error:c})}catch(s){if(A(s))return this._returnResult({data:{user:null,session:null},error:s});throw s}}async signInWithOtp(e){var s,r,i,n,a;try{if("email"in e){const{email:o,options:l}=e;let c=null,u=null;this.flowType==="pkce"&&([c,u]=await de(this.storage,this.storageKey));const{error:g}=await R(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:o,data:(s=l==null?void 0:l.data)!==null&&s!==void 0?s:{},create_user:(r=l==null?void 0:l.shouldCreateUser)!==null&&r!==void 0?r:!0,gotrue_meta_security:{captcha_token:l==null?void 0:l.captchaToken},code_challenge:c,code_challenge_method:u},redirectTo:l==null?void 0:l.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:g})}if("phone"in e){const{phone:o,options:l}=e,{data:c,error:u}=await R(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:o,data:(i=l==null?void 0:l.data)!==null&&i!==void 0?i:{},create_user:(n=l==null?void 0:l.shouldCreateUser)!==null&&n!==void 0?n:!0,gotrue_meta_security:{captcha_token:l==null?void 0:l.captchaToken},channel:(a=l==null?void 0:l.channel)!==null&&a!==void 0?a:"sms"}});return this._returnResult({data:{user:null,session:null,messageId:c==null?void 0:c.message_id},error:u})}throw new qe("You must provide either an email or phone number.")}catch(o){if(await M(this.storage,`${this.storageKey}-code-verifier`),A(o))return this._returnResult({data:{user:null,session:null},error:o});throw o}}async verifyOtp(e){var s,r;try{let i,n;"options"in e&&(i=(s=e.options)===null||s===void 0?void 0:s.redirectTo,n=(r=e.options)===null||r===void 0?void 0:r.captchaToken);const{data:a,error:o}=await R(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:n}}),redirectTo:i,xform:J});if(o)throw o;if(!a)throw new Error("An error occurred on token verification.");const l=a.session,c=a.user;return l!=null&&l.access_token&&(await this._saveSession(l),await this._notifyAllSubscribers(e.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(i){if(A(i))return this._returnResult({data:{user:null,session:null},error:i});throw i}}async signInWithSSO(e){var s,r,i,n,a;try{let o=null,l=null;this.flowType==="pkce"&&([o,l]=await de(this.storage,this.storageKey));const c=await R(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(r=(s=e.options)===null||s===void 0?void 0:s.redirectTo)!==null&&r!==void 0?r:void 0}),!((i=e==null?void 0:e.options)===null||i===void 0)&&i.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:o,code_challenge_method:l}),headers:this.headers,xform:Xr});return!((n=c.data)===null||n===void 0)&&n.url&&H()&&!(!((a=e.options)===null||a===void 0)&&a.skipBrowserRedirect)&&window.location.assign(c.data.url),this._returnResult(c)}catch(o){if(await M(this.storage,`${this.storageKey}-code-verifier`),A(o))return this._returnResult({data:null,error:o});throw o}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:s},error:r}=e;if(r)throw r;if(!s)throw new G;const{error:i}=await R(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:s.access_token});return this._returnResult({data:{user:null,session:null},error:i})})}catch(e){if(A(e))return this._returnResult({data:{user:null,session:null},error:e});throw e}}async resend(e){try{const s=`${this.url}/resend`;if("email"in e){const{email:r,type:i,options:n}=e,{error:a}=await R(this.fetch,"POST",s,{headers:this.headers,body:{email:r,type:i,gotrue_meta_security:{captcha_token:n==null?void 0:n.captchaToken}},redirectTo:n==null?void 0:n.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:a})}else if("phone"in e){const{phone:r,type:i,options:n}=e,{data:a,error:o}=await R(this.fetch,"POST",s,{headers:this.headers,body:{phone:r,type:i,gotrue_meta_security:{captcha_token:n==null?void 0:n.captchaToken}}});return this._returnResult({data:{user:null,session:null,messageId:a==null?void 0:a.message_id},error:o})}throw new qe("You must provide either an email or phone number and a type")}catch(s){if(A(s))return this._returnResult({data:{user:null,session:null},error:s});throw s}}async getSession(){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>this._useSession(async s=>s))}async _acquireLock(e,s){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const r=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),i=(async()=>(await r,await s()))();return this.pendingInLock.push((async()=>{try{await i}catch{}})()),i}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const r=s();for(this.pendingInLock.push((async()=>{try{await r}catch{}})()),await r;this.pendingInLock.length;){const i=[...this.pendingInLock];await Promise.all(i),this.pendingInLock.splice(0,i.length)}return await r}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const s=await this.__loadSession();return await e(s)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let e=null;const s=await ne(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",s),s!==null&&(this._isValidSession(s)?e=s:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const r=e.expires_at?e.expires_at*1e3-Date.now()<nt:!1;if(this._debug("#__loadSession()",`session has${r?"":" not"} expired`,"expires_at",e.expires_at),!r){if(this.userStorage){const a=await ne(this.userStorage,this.storageKey+"-user");a!=null&&a.user?e.user=a.user:e.user=ot()}if(this.storage.isServer&&e.user&&!e.user.__isUserNotAvailableProxy){const a={value:this.suppressGetSessionWarning};e.user=zr(e.user,a),a.value&&(this.suppressGetSessionWarning=!0)}return{data:{session:e},error:null}}const{data:i,error:n}=await this._callRefreshToken(e.refresh_token);return n?this._returnResult({data:{session:null},error:n}):this._returnResult({data:{session:i},error:null})}finally{this._debug("#__loadSession()","end")}}async getUser(e){if(e)return await this._getUser(e);await this.initializePromise;const s=await this._acquireLock(this.lockAcquireTimeout,async()=>await this._getUser());return s.data.user&&(this.suppressGetSessionWarning=!0),s}async _getUser(e){try{return e?await R(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:se}):await this._useSession(async s=>{var r,i,n;const{data:a,error:o}=s;if(o)throw o;return!(!((r=a.session)===null||r===void 0)&&r.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new G}:await R(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(n=(i=a.session)===null||i===void 0?void 0:i.access_token)!==null&&n!==void 0?n:void 0,xform:se})})}catch(s){if(A(s))return it(s)&&(await this._removeSession(),await M(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({data:{user:null},error:s});throw s}}async updateUser(e,s={}){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._updateUser(e,s))}async _updateUser(e,s={}){try{return await this._useSession(async r=>{const{data:i,error:n}=r;if(n)throw n;if(!i.session)throw new G;const a=i.session;let o=null,l=null;this.flowType==="pkce"&&e.email!=null&&([o,l]=await de(this.storage,this.storageKey));const{data:c,error:u}=await R(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:s==null?void 0:s.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:o,code_challenge_method:l}),jwt:a.access_token,xform:se});if(u)throw u;return a.user=c.user,await this._saveSession(a),await this._notifyAllSubscribers("USER_UPDATED",a),this._returnResult({data:{user:a.user},error:null})})}catch(r){if(await M(this.storage,`${this.storageKey}-code-verifier`),A(r))return this._returnResult({data:{user:null},error:r});throw r}}async setSession(e){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new G;const s=Date.now()/1e3;let r=s,i=!0,n=null;const{payload:a}=He(e.access_token);if(a.exp&&(r=a.exp,i=r<=s),i){const{data:o,error:l}=await this._callRefreshToken(e.refresh_token);if(l)return this._returnResult({data:{user:null,session:null},error:l});if(!o)return{data:{user:null,session:null},error:null};n=o}else{const{data:o,error:l}=await this._getUser(e.access_token);if(l)return this._returnResult({data:{user:null,session:null},error:l});n={access_token:e.access_token,refresh_token:e.refresh_token,user:o.user,token_type:"bearer",expires_in:r-s,expires_at:r},await this._saveSession(n),await this._notifyAllSubscribers("SIGNED_IN",n)}return this._returnResult({data:{user:n.user,session:n},error:null})}catch(s){if(A(s))return this._returnResult({data:{session:null,user:null},error:s});throw s}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async s=>{var r;if(!e){const{data:a,error:o}=s;if(o)throw o;e=(r=a.session)!==null&&r!==void 0?r:void 0}if(!(e!=null&&e.refresh_token))throw new G;const{data:i,error:n}=await this._callRefreshToken(e.refresh_token);return n?this._returnResult({data:{user:null,session:null},error:n}):i?this._returnResult({data:{user:i.user,session:i},error:null}):this._returnResult({data:{user:null,session:null},error:null})})}catch(s){if(A(s))return this._returnResult({data:{user:null,session:null},error:s});throw s}}async _getSessionFromURL(e,s){try{if(!H())throw new Me("No browser detected.");if(e.error||e.error_description||e.error_code)throw new Me(e.error_description||"Error in URL with unspecified error_description",{error:e.error||"unspecified_error",code:e.error_code||"unspecified_code"});switch(s){case"implicit":if(this.flowType==="pkce")throw new Ut("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new Me("Not a valid implicit grant flow url.");break;default:}if(s==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!e.code)throw new Ut("No code detected.");const{data:w,error:S}=await this._exchangeCodeForSession(e.code);if(S)throw S;const O=new URL(window.location.href);return O.searchParams.delete("code"),window.history.replaceState(window.history.state,"",O.toString()),{data:{session:w.session,redirectType:null},error:null}}const{provider_token:r,provider_refresh_token:i,access_token:n,refresh_token:a,expires_in:o,expires_at:l,token_type:c}=e;if(!n||!o||!a||!c)throw new Me("No session defined in URL");const u=Math.round(Date.now()/1e3),g=parseInt(o);let p=u+g;l&&(p=parseInt(l));const d=p-u;d*1e3<=me&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${d}s, should have been closer to ${g}s`);const m=p-g;u-m>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",m,p,u):u-m<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",m,p,u);const{data:v,error:b}=await this._getUser(n);if(b)throw b;const E={provider_token:r,provider_refresh_token:i,access_token:n,expires_in:g,expires_at:p,refresh_token:a,token_type:c,user:v.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),this._returnResult({data:{session:E,redirectType:e.type},error:null})}catch(r){if(A(r))return this._returnResult({data:{session:null,redirectType:null},error:r});throw r}}_isImplicitGrantCallback(e){return typeof this.detectSessionInUrl=="function"?this.detectSessionInUrl(new URL(window.location.href),e):!!(e.access_token||e.error_description)}async _isPKCECallback(e){const s=await ne(this.storage,`${this.storageKey}-code-verifier`);return!!(e.code&&s)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async s=>{var r;const{data:i,error:n}=s;if(n&&!it(n))return this._returnResult({error:n});const a=(r=i.session)===null||r===void 0?void 0:r.access_token;if(a){const{error:o}=await this.admin.signOut(a,e);if(o&&!(Ar(o)&&(o.status===404||o.status===401||o.status===403)||it(o)))return this._returnResult({error:o})}return e!=="others"&&(await this._removeSession(),await M(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({error:null})})}onAuthStateChange(e){const s=xr(),r={id:s,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",s),this.stateChangeEmitters.delete(s)}};return this._debug("#onAuthStateChange()","registered callback with id",s),this.stateChangeEmitters.set(s,r),(async()=>(await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>{this._emitInitialSession(s)})))(),{data:{subscription:r}}}async _emitInitialSession(e){return await this._useSession(async s=>{var r,i;try{const{data:{session:n},error:a}=s;if(a)throw a;await((r=this.stateChangeEmitters.get(e))===null||r===void 0?void 0:r.callback("INITIAL_SESSION",n)),this._debug("INITIAL_SESSION","callback id",e,"session",n)}catch(n){await((i=this.stateChangeEmitters.get(e))===null||i===void 0?void 0:i.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",n),console.error(n)}})}async resetPasswordForEmail(e,s={}){let r=null,i=null;this.flowType==="pkce"&&([r,i]=await de(this.storage,this.storageKey,!0));try{return await R(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:r,code_challenge_method:i,gotrue_meta_security:{captcha_token:s.captchaToken}},headers:this.headers,redirectTo:s.redirectTo})}catch(n){if(await M(this.storage,`${this.storageKey}-code-verifier`),A(n))return this._returnResult({data:null,error:n});throw n}}async getUserIdentities(){var e;try{const{data:s,error:r}=await this.getUser();if(r)throw r;return this._returnResult({data:{identities:(e=s.user.identities)!==null&&e!==void 0?e:[]},error:null})}catch(s){if(A(s))return this._returnResult({data:null,error:s});throw s}}async linkIdentity(e){return"token"in e?this.linkIdentityIdToken(e):this.linkIdentityOAuth(e)}async linkIdentityOAuth(e){var s;try{const{data:r,error:i}=await this._useSession(async n=>{var a,o,l,c,u;const{data:g,error:p}=n;if(p)throw p;const d=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:(a=e.options)===null||a===void 0?void 0:a.redirectTo,scopes:(o=e.options)===null||o===void 0?void 0:o.scopes,queryParams:(l=e.options)===null||l===void 0?void 0:l.queryParams,skipBrowserRedirect:!0});return await R(this.fetch,"GET",d,{headers:this.headers,jwt:(u=(c=g.session)===null||c===void 0?void 0:c.access_token)!==null&&u!==void 0?u:void 0})});if(i)throw i;return H()&&!(!((s=e.options)===null||s===void 0)&&s.skipBrowserRedirect)&&window.location.assign(r==null?void 0:r.url),this._returnResult({data:{provider:e.provider,url:r==null?void 0:r.url},error:null})}catch(r){if(A(r))return this._returnResult({data:{provider:e.provider,url:null},error:r});throw r}}async linkIdentityIdToken(e){return await this._useSession(async s=>{var r;try{const{error:i,data:{session:n}}=s;if(i)throw i;const{options:a,provider:o,token:l,access_token:c,nonce:u}=e,g=await R(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,jwt:(r=n==null?void 0:n.access_token)!==null&&r!==void 0?r:void 0,body:{provider:o,id_token:l,access_token:c,nonce:u,link_identity:!0,gotrue_meta_security:{captcha_token:a==null?void 0:a.captchaToken}},xform:J}),{data:p,error:d}=g;return d?this._returnResult({data:{user:null,session:null},error:d}):!p||!p.session||!p.user?this._returnResult({data:{user:null,session:null},error:new ue}):(p.session&&(await this._saveSession(p.session),await this._notifyAllSubscribers("USER_UPDATED",p.session)),this._returnResult({data:p,error:d}))}catch(i){if(await M(this.storage,`${this.storageKey}-code-verifier`),A(i))return this._returnResult({data:{user:null,session:null},error:i});throw i}})}async unlinkIdentity(e){try{return await this._useSession(async s=>{var r,i;const{data:n,error:a}=s;if(a)throw a;return await R(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:(i=(r=n.session)===null||r===void 0?void 0:r.access_token)!==null&&i!==void 0?i:void 0})})}catch(s){if(A(s))return this._returnResult({data:null,error:s});throw s}}async _refreshAccessToken(e){const s=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(s,"begin");try{const r=Date.now();return await Ur(async i=>(i>0&&await Nr(200*Math.pow(2,i-1)),this._debug(s,"refreshing attempt",i),await R(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:J})),(i,n)=>{const a=200*Math.pow(2,i);return n&&at(n)&&Date.now()+a-r<me})}catch(r){if(this._debug(s,"error",r),A(r))return this._returnResult({data:{session:null,user:null},error:r});throw r}finally{this._debug(s,"end")}}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,s){const r=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:s.redirectTo,scopes:s.scopes,queryParams:s.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",s,"url",r),H()&&!s.skipBrowserRedirect&&window.location.assign(r),{data:{provider:e,url:r},error:null}}async _recoverAndRefresh(){var e,s;const r="#_recoverAndRefresh()";this._debug(r,"begin");try{const i=await ne(this.storage,this.storageKey);if(i&&this.userStorage){let a=await ne(this.userStorage,this.storageKey+"-user");!this.storage.isServer&&Object.is(this.storage,this.userStorage)&&!a&&(a={user:i.user},await ye(this.userStorage,this.storageKey+"-user",a)),i.user=(e=a==null?void 0:a.user)!==null&&e!==void 0?e:ot()}else if(i&&!i.user&&!i.user){const a=await ne(this.storage,this.storageKey+"-user");a&&(a!=null&&a.user)?(i.user=a.user,await M(this.storage,this.storageKey+"-user"),await ye(this.storage,this.storageKey,i)):i.user=ot()}if(this._debug(r,"session from storage",i),!this._isValidSession(i)){this._debug(r,"session is not valid"),i!==null&&await this._removeSession();return}const n=((s=i.expires_at)!==null&&s!==void 0?s:1/0)*1e3-Date.now()<nt;if(this._debug(r,`session has${n?"":" not"} expired with margin of ${nt}s`),n){if(this.autoRefreshToken&&i.refresh_token){const{error:a}=await this._callRefreshToken(i.refresh_token);a&&(console.error(a),at(a)||(this._debug(r,"refresh failed with a non-retryable error, removing the session",a),await this._removeSession()))}}else if(i.user&&i.user.__isUserNotAvailableProxy===!0)try{const{data:a,error:o}=await this._getUser(i.access_token);!o&&(a!=null&&a.user)?(i.user=a.user,await this._saveSession(i),await this._notifyAllSubscribers("SIGNED_IN",i)):this._debug(r,"could not get user data, skipping SIGNED_IN notification")}catch(a){console.error("Error getting user data:",a),this._debug(r,"error getting user data, skipping SIGNED_IN notification",a)}else await this._notifyAllSubscribers("SIGNED_IN",i)}catch(i){this._debug(r,"error",i),console.error(i);return}finally{this._debug(r,"end")}}async _callRefreshToken(e){var s,r;if(!e)throw new G;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const i=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(i,"begin");try{this.refreshingDeferred=new Qe;const{data:n,error:a}=await this._refreshAccessToken(e);if(a)throw a;if(!n.session)throw new G;await this._saveSession(n.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",n.session);const o={data:n.session,error:null};return this.refreshingDeferred.resolve(o),o}catch(n){if(this._debug(i,"error",n),A(n)){const a={data:null,error:n};return at(n)||await this._removeSession(),(s=this.refreshingDeferred)===null||s===void 0||s.resolve(a),a}throw(r=this.refreshingDeferred)===null||r===void 0||r.reject(n),n}finally{this.refreshingDeferred=null,this._debug(i,"end")}}async _notifyAllSubscribers(e,s,r=!0){const i=`#_notifyAllSubscribers(${e})`;this._debug(i,"begin",s,`broadcast = ${r}`);try{this.broadcastChannel&&r&&this.broadcastChannel.postMessage({event:e,session:s});const n=[],a=Array.from(this.stateChangeEmitters.values()).map(async o=>{try{await o.callback(e,s)}catch(l){n.push(l)}});if(await Promise.all(a),n.length>0){for(let o=0;o<n.length;o+=1)console.error(n[o]);throw n[0]}}finally{this._debug(i,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0,await M(this.storage,`${this.storageKey}-code-verifier`);const s=Object.assign({},e),r=s.user&&s.user.__isUserNotAvailableProxy===!0;if(this.userStorage){!r&&s.user&&await ye(this.userStorage,this.storageKey+"-user",{user:s.user});const i=Object.assign({},s);delete i.user;const n=Ht(i);await ye(this.storage,this.storageKey,n)}else{const i=Ht(s);await ye(this.storage,this.storageKey,i)}}async _removeSession(){this._debug("#_removeSession()"),this.suppressGetSessionWarning=!1,await M(this.storage,this.storageKey),await M(this.storage,this.storageKey+"-code-verifier"),await M(this.storage,this.storageKey+"-user"),this.userStorage&&await M(this.userStorage,this.storageKey+"-user"),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&H()&&(window!=null&&window.removeEventListener)&&window.removeEventListener("visibilitychange",e)}catch(s){console.error("removing visibilitychange callback failed",s)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),me);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e);const s=setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0);this.autoRefreshTickTimeout=s,s&&typeof s=="object"&&typeof s.unref=="function"?s.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(s)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e);const s=this.autoRefreshTickTimeout;this.autoRefreshTickTimeout=null,s&&clearTimeout(s)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const e=Date.now();try{return await this._useSession(async s=>{const{data:{session:r}}=s;if(!r||!r.refresh_token||!r.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const i=Math.floor((r.expires_at*1e3-e)/me);this._debug("#_autoRefreshTokenTick()",`access token expires in ${i} ticks, a tick lasts ${me}ms, refresh threshold is ${gt} ticks`),i<=gt&&await this._callRefreshToken(r.refresh_token)})}catch(s){console.error("Auto refresh tick failed with error. This is likely a transient error.",s)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(e.isAcquireTimeout||e instanceof ds)this._debug("auto refresh token tick lock not available");else throw e}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!H()||!(window!=null&&window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>{try{await this._onVisibilityChanged(!1)}catch(e){this._debug("#visibilityChangedCallback","error",e)}},window==null||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const s=`#_onVisibilityChanged(${e})`;this._debug(s,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>{if(document.visibilityState!=="visible"){this._debug(s,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,s,r){const i=[`provider=${encodeURIComponent(s)}`];if(r!=null&&r.redirectTo&&i.push(`redirect_to=${encodeURIComponent(r.redirectTo)}`),r!=null&&r.scopes&&i.push(`scopes=${encodeURIComponent(r.scopes)}`),this.flowType==="pkce"){const[n,a]=await de(this.storage,this.storageKey),o=new URLSearchParams({code_challenge:`${encodeURIComponent(n)}`,code_challenge_method:`${encodeURIComponent(a)}`});i.push(o.toString())}if(r!=null&&r.queryParams){const n=new URLSearchParams(r.queryParams);i.push(n.toString())}return r!=null&&r.skipBrowserRedirect&&i.push(`skip_http_redirect=${r.skipBrowserRedirect}`),`${e}?${i.join("&")}`}async _unenroll(e){try{return await this._useSession(async s=>{var r;const{data:i,error:n}=s;return n?this._returnResult({data:null,error:n}):await R(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(r=i==null?void 0:i.session)===null||r===void 0?void 0:r.access_token})})}catch(s){if(A(s))return this._returnResult({data:null,error:s});throw s}}async _enroll(e){try{return await this._useSession(async s=>{var r,i;const{data:n,error:a}=s;if(a)return this._returnResult({data:null,error:a});const o=Object.assign({friendly_name:e.friendlyName,factor_type:e.factorType},e.factorType==="phone"?{phone:e.phone}:e.factorType==="totp"?{issuer:e.issuer}:{}),{data:l,error:c}=await R(this.fetch,"POST",`${this.url}/factors`,{body:o,headers:this.headers,jwt:(r=n==null?void 0:n.session)===null||r===void 0?void 0:r.access_token});return c?this._returnResult({data:null,error:c}):(e.factorType==="totp"&&l.type==="totp"&&(!((i=l==null?void 0:l.totp)===null||i===void 0)&&i.qr_code)&&(l.totp.qr_code=`data:image/svg+xml;utf-8,${l.totp.qr_code}`),this._returnResult({data:l,error:null}))})}catch(s){if(A(s))return this._returnResult({data:null,error:s});throw s}}async _verify(e){return this._acquireLock(this.lockAcquireTimeout,async()=>{try{return await this._useSession(async s=>{var r;const{data:i,error:n}=s;if(n)return this._returnResult({data:null,error:n});const a=Object.assign({challenge_id:e.challengeId},"webauthn"in e?{webauthn:Object.assign(Object.assign({},e.webauthn),{credential_response:e.webauthn.type==="create"?pn(e.webauthn.credential_response):gn(e.webauthn.credential_response)})}:{code:e.code}),{data:o,error:l}=await R(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:a,headers:this.headers,jwt:(r=i==null?void 0:i.session)===null||r===void 0?void 0:r.access_token});return l?this._returnResult({data:null,error:l}):(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+o.expires_in},o)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",o),this._returnResult({data:o,error:l}))})}catch(s){if(A(s))return this._returnResult({data:null,error:s});throw s}})}async _challenge(e){return this._acquireLock(this.lockAcquireTimeout,async()=>{try{return await this._useSession(async s=>{var r;const{data:i,error:n}=s;if(n)return this._returnResult({data:null,error:n});const a=await R(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{body:e,headers:this.headers,jwt:(r=i==null?void 0:i.session)===null||r===void 0?void 0:r.access_token});if(a.error)return a;const{data:o}=a;if(o.type!=="webauthn")return{data:o,error:null};switch(o.webauthn.type){case"create":return{data:Object.assign(Object.assign({},o),{webauthn:Object.assign(Object.assign({},o.webauthn),{credential_options:Object.assign(Object.assign({},o.webauthn.credential_options),{publicKey:hn(o.webauthn.credential_options.publicKey)})})}),error:null};case"request":return{data:Object.assign(Object.assign({},o),{webauthn:Object.assign(Object.assign({},o.webauthn),{credential_options:Object.assign(Object.assign({},o.webauthn.credential_options),{publicKey:fn(o.webauthn.credential_options.publicKey)})})}),error:null}}})}catch(s){if(A(s))return this._returnResult({data:null,error:s});throw s}})}async _challengeAndVerify(e){const{data:s,error:r}=await this._challenge({factorId:e.factorId});return r?this._returnResult({data:null,error:r}):await this._verify({factorId:e.factorId,challengeId:s.id,code:e.code})}async _listFactors(){var e;const{data:{user:s},error:r}=await this.getUser();if(r)return{data:null,error:r};const i={all:[],phone:[],totp:[],webauthn:[]};for(const n of(e=s==null?void 0:s.factors)!==null&&e!==void 0?e:[])i.all.push(n),n.status==="verified"&&i[n.factor_type].push(n);return{data:i,error:null}}async _getAuthenticatorAssuranceLevel(e){var s,r,i,n;if(e)try{const{payload:d}=He(e);let m=null;d.aal&&(m=d.aal);let v=m;const{data:{user:b},error:E}=await this.getUser(e);if(E)return this._returnResult({data:null,error:E});((r=(s=b==null?void 0:b.factors)===null||s===void 0?void 0:s.filter(O=>O.status==="verified"))!==null&&r!==void 0?r:[]).length>0&&(v="aal2");const S=d.amr||[];return{data:{currentLevel:m,nextLevel:v,currentAuthenticationMethods:S},error:null}}catch(d){if(A(d))return this._returnResult({data:null,error:d});throw d}const{data:{session:a},error:o}=await this.getSession();if(o)return this._returnResult({data:null,error:o});if(!a)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:l}=He(a.access_token);let c=null;l.aal&&(c=l.aal);let u=c;((n=(i=a.user.factors)===null||i===void 0?void 0:i.filter(d=>d.status==="verified"))!==null&&n!==void 0?n:[]).length>0&&(u="aal2");const p=l.amr||[];return{data:{currentLevel:c,nextLevel:u,currentAuthenticationMethods:p},error:null}}async _getAuthorizationDetails(e){try{return await this._useSession(async s=>{const{data:{session:r},error:i}=s;return i?this._returnResult({data:null,error:i}):r?await R(this.fetch,"GET",`${this.url}/oauth/authorizations/${e}`,{headers:this.headers,jwt:r.access_token,xform:n=>({data:n,error:null})}):this._returnResult({data:null,error:new G})})}catch(s){if(A(s))return this._returnResult({data:null,error:s});throw s}}async _approveAuthorization(e,s){try{return await this._useSession(async r=>{const{data:{session:i},error:n}=r;if(n)return this._returnResult({data:null,error:n});if(!i)return this._returnResult({data:null,error:new G});const a=await R(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:i.access_token,body:{action:"approve"},xform:o=>({data:o,error:null})});return a.data&&a.data.redirect_url&&H()&&!(s!=null&&s.skipBrowserRedirect)&&window.location.assign(a.data.redirect_url),a})}catch(r){if(A(r))return this._returnResult({data:null,error:r});throw r}}async _denyAuthorization(e,s){try{return await this._useSession(async r=>{const{data:{session:i},error:n}=r;if(n)return this._returnResult({data:null,error:n});if(!i)return this._returnResult({data:null,error:new G});const a=await R(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:i.access_token,body:{action:"deny"},xform:o=>({data:o,error:null})});return a.data&&a.data.redirect_url&&H()&&!(s!=null&&s.skipBrowserRedirect)&&window.location.assign(a.data.redirect_url),a})}catch(r){if(A(r))return this._returnResult({data:null,error:r});throw r}}async _listOAuthGrants(){try{return await this._useSession(async e=>{const{data:{session:s},error:r}=e;return r?this._returnResult({data:null,error:r}):s?await R(this.fetch,"GET",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:s.access_token,xform:i=>({data:i,error:null})}):this._returnResult({data:null,error:new G})})}catch(e){if(A(e))return this._returnResult({data:null,error:e});throw e}}async _revokeOAuthGrant(e){try{return await this._useSession(async s=>{const{data:{session:r},error:i}=s;return i?this._returnResult({data:null,error:i}):r?(await R(this.fetch,"DELETE",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:r.access_token,query:{client_id:e.clientId},noResolveJson:!0}),{data:{},error:null}):this._returnResult({data:null,error:new G})})}catch(s){if(A(s))return this._returnResult({data:null,error:s});throw s}}async fetchJwk(e,s={keys:[]}){let r=s.keys.find(o=>o.kid===e);if(r)return r;const i=Date.now();if(r=this.jwks.keys.find(o=>o.kid===e),r&&this.jwks_cached_at+Er>i)return r;const{data:n,error:a}=await R(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(a)throw a;return!n.keys||n.keys.length===0||(this.jwks=n,this.jwks_cached_at=i,r=n.keys.find(o=>o.kid===e),!r)?null:r}async getClaims(e,s={}){try{let r=e;if(!r){const{data:d,error:m}=await this.getSession();if(m||!d.session)return this._returnResult({data:null,error:m});r=d.session.access_token}const{header:i,payload:n,signature:a,raw:{header:o,payload:l}}=He(r);s!=null&&s.allowExpired||Kr(n.exp);const c=!i.alg||i.alg.startsWith("HS")||!i.kid||!("crypto"in globalThis&&"subtle"in globalThis.crypto)?null:await this.fetchJwk(i.kid,s!=null&&s.keys?{keys:s.keys}:s==null?void 0:s.jwks);if(!c){const{error:d}=await this.getUser(r);if(d)throw d;return{data:{claims:n,header:i,signature:a},error:null}}const u=Wr(i.alg),g=await crypto.subtle.importKey("jwk",c,u,!0,["verify"]);if(!await crypto.subtle.verify(u,g,a,Pr(`${o}.${l}`)))throw new wt("Invalid JWT signature");return{data:{claims:n,header:i,signature:a},error:null}}catch(r){if(A(r))return this._returnResult({data:null,error:r});throw r}}}Pe.nextInstanceID={};const kn=Pe,An="2.97.0";let ke="";typeof Deno<"u"?ke="deno":typeof document<"u"?ke="web":typeof navigator<"u"&&navigator.product==="ReactNative"?ke="react-native":ke="node";const Tn={"X-Client-Info":`supabase-js-${ke}/${An}`},Rn={headers:Tn},On={schema:"public"},Cn={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},Ln={};function $e(t){"@babel/helpers - typeof";return $e=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},$e(t)}function In(t,e){if($e(t)!="object"||!t)return t;var s=t[Symbol.toPrimitive];if(s!==void 0){var r=s.call(t,e);if($e(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(t)}function Pn(t){var e=In(t,"string");return $e(e)=="symbol"?e:e+""}function $n(t,e,s){return(e=Pn(e))in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}function Yt(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),s.push.apply(s,r)}return s}function N(t){for(var e=1;e<arguments.length;e++){var s=arguments[e]!=null?arguments[e]:{};e%2?Yt(Object(s),!0).forEach(function(r){$n(t,r,s[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):Yt(Object(s)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(s,r))})}return t}const xn=t=>t?(...e)=>t(...e):(...e)=>fetch(...e),Dn=()=>Headers,jn=(t,e,s)=>{const r=xn(s),i=Dn();return async(n,a)=>{var o;const l=(o=await e())!==null&&o!==void 0?o:t;let c=new i(a==null?void 0:a.headers);return c.has("apikey")||c.set("apikey",t),c.has("Authorization")||c.set("Authorization",`Bearer ${l}`),r(n,N(N({},a),{},{headers:c}))}};function Nn(t){return t.endsWith("/")?t:t+"/"}function Un(t,e){var s,r;const{db:i,auth:n,realtime:a,global:o}=t,{db:l,auth:c,realtime:u,global:g}=e,p={db:N(N({},l),i),auth:N(N({},c),n),realtime:N(N({},u),a),storage:{},global:N(N(N({},g),o),{},{headers:N(N({},(s=g==null?void 0:g.headers)!==null&&s!==void 0?s:{}),(r=o==null?void 0:o.headers)!==null&&r!==void 0?r:{})}),accessToken:async()=>""};return t.accessToken?p.accessToken=t.accessToken:delete p.accessToken,p}function Bn(t){const e=t==null?void 0:t.trim();if(!e)throw new Error("supabaseUrl is required.");if(!e.match(/^https?:\/\//i))throw new Error("Invalid supabaseUrl: Must be a valid HTTP or HTTPS URL.");try{return new URL(Nn(e))}catch{throw Error("Invalid supabaseUrl: Provided URL is malformed.")}}var Fn=class extends kn{constructor(t){super(t)}},qn=class{constructor(t,e,s){var r,i;this.supabaseUrl=t,this.supabaseKey=e;const n=Bn(t);if(!e)throw new Error("supabaseKey is required.");this.realtimeUrl=new URL("realtime/v1",n),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",n),this.storageUrl=new URL("storage/v1",n),this.functionsUrl=new URL("functions/v1",n);const a=`sb-${n.hostname.split(".")[0]}-auth-token`,o={db:On,realtime:Ln,auth:N(N({},Cn),{},{storageKey:a}),global:Rn},l=Un(s??{},o);if(this.storageKey=(r=l.auth.storageKey)!==null&&r!==void 0?r:"",this.headers=(i=l.global.headers)!==null&&i!==void 0?i:{},l.accessToken)this.accessToken=l.accessToken,this.auth=new Proxy({},{get:(u,g)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(g)} is not possible`)}});else{var c;this.auth=this._initSupabaseAuthClient((c=l.auth)!==null&&c!==void 0?c:{},this.headers,l.global.fetch)}this.fetch=jn(e,this._getAccessToken.bind(this),l.global.fetch),this.realtime=this._initRealtimeClient(N({headers:this.headers,accessToken:this._getAccessToken.bind(this)},l.realtime)),this.accessToken&&Promise.resolve(this.accessToken()).then(u=>this.realtime.setAuth(u)).catch(u=>console.warn("Failed to set initial Realtime auth token:",u)),this.rest=new As(new URL("rest/v1",n).href,{headers:this.headers,schema:l.db.schema,fetch:this.fetch,timeout:l.db.timeout,urlLengthLimit:l.db.urlLengthLimit}),this.storage=new wr(this.storageUrl.href,this.headers,this.fetch,s==null?void 0:s.storage),l.accessToken||this._listenForAuthEvents()}get functions(){return new ys(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}from(t){return this.rest.from(t)}schema(t){return this.rest.schema(t)}rpc(t,e={},s={head:!1,get:!1,count:void 0}){return this.rest.rpc(t,e,s)}channel(t,e={config:{}}){return this.realtime.channel(t,e)}getChannels(){return this.realtime.getChannels()}removeChannel(t){return this.realtime.removeChannel(t)}removeAllChannels(){return this.realtime.removeAllChannels()}async _getAccessToken(){var t=this,e,s;if(t.accessToken)return await t.accessToken();const{data:r}=await t.auth.getSession();return(e=(s=r.session)===null||s===void 0?void 0:s.access_token)!==null&&e!==void 0?e:t.supabaseKey}_initSupabaseAuthClient({autoRefreshToken:t,persistSession:e,detectSessionInUrl:s,storage:r,userStorage:i,storageKey:n,flowType:a,lock:o,debug:l,throwOnError:c},u,g){const p={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new Fn({url:this.authUrl.href,headers:N(N({},p),u),storageKey:n,autoRefreshToken:t,persistSession:e,detectSessionInUrl:s,storage:r,userStorage:i,flowType:a,lock:o,debug:l,throwOnError:c,fetch:g,hasCustomAuthorizationHeader:Object.keys(this.headers).some(d=>d.toLowerCase()==="authorization")})}_initRealtimeClient(t){return new Ms(this.realtimeUrl.href,N(N({},t),{},{params:N(N({},{apikey:this.supabaseKey}),t==null?void 0:t.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((t,e)=>{this._handleTokenChanged(t,"CLIENT",e==null?void 0:e.access_token)})}_handleTokenChanged(t,e,s){(t==="TOKEN_REFRESHED"||t==="SIGNED_IN")&&this.changedAccessToken!==s?(this.changedAccessToken=s,this.realtime.setAuth(s)):t==="SIGNED_OUT"&&(this.realtime.setAuth(),e=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}};const Mn=(t,e,s)=>new qn(t,e,s);function Hn(){if(typeof window<"u")return!1;const t=globalThis.process;if(!t)return!1;const e=t.version;if(e==null)return!1;const s=e.match(/^v(\d+)\./);return s?parseInt(s[1],10)<=18:!1}Hn()&&console.warn("  Node.js 18 and below are deprecated and will no longer be supported in future versions of @supabase/supabase-js. Please upgrade to Node.js 20 or later. For more information, visit: https://github.com/orgs/supabase/discussions/37217");const Vn=void 0,Kn=void 0,Wn=Mn(Vn,Kn);window.supabase=Wn;(function(){const t=document.getElementById("authModal"),e=document.getElementById("authForm"),s=document.getElementById("authEmail"),r=document.getElementById("authPassword"),i=document.getElementById("authError"),n=document.getElementById("authSubmitBtn"),a=document.getElementById("toggleAuthMode"),o=document.getElementById("authModalTitle"),l=document.getElementById("nav-logout");let c=!0;async function u(d){d.preventDefault();const m=s.value,v=r.value;i.style.display="none";try{if(c){const{error:b}=await window.supabase.auth.signInWithPassword({email:m,password:v});if(b)throw b}else{const{error:b}=await window.supabase.auth.signUp({email:m,password:v});if(b)throw b;alert("Check your email for the confirmation link!")}t.style.display="none"}catch(b){i.textContent=b.message,i.style.display="block"}}function g(){c=!c,o.textContent=c?"Login":"Sign Up",n.textContent=c?"Login":"Sign Up",a.textContent=c?"Need an account? Sign Up":"Already have an account? Login"}async function p(){await window.supabase.auth.signOut(),window.location.reload()}e&&e.addEventListener("submit",u),a&&a.addEventListener("click",g),l&&l.addEventListener("click",p),window.supabase.auth.onAuthStateChange((d,m)=>{m?(t.classList.remove("active"),t.style.display="none",window.dispatchEvent(new CustomEvent("supabase-auth-success",{detail:{session:m}}))):(t.classList.add("active"),t.style.display="flex")})})();window.notebookSources=[{id:"32514f64-70fe-4089-9aec-ad2cf0203aa8",title:"Amendment to Founders Agreement 08Jan26.pdf",type:"image",content:`https://lh3.googleusercontent.com/notebooklm/ANHLwAwZLZjFR9OGB77rvSGnnSu_dgbda58D9TnCt7-5tzhC2nhFsQuiw9ujJTaSdQFqPsxBWmXumew2CLVJd9c-qOwDlO6cnQ--qacoGx9Y_82AUp2VQx0cre9-SjBFeNdpObLTzR8sKQ=w838-h1185-v0

https://lh3.googleusercontent.com/notebooklm/ANHLwAx1YrbnbJjUXxsrpVQjYzGxC0kWmWmiDH3E6wuY-nh-9uaP1T78fFA41cZqnrSmspoKBvFrTEB0YuFazYdITqV2OEMRfzWdwI4cfCJ-Ydb4YhSLm2gO2PhaH43B98I1mvFG04asxg=w838-h1185-v0`,painpointIds:["vesting"]},{id:"2b46a572-04c4-4237-bf45-a961c9eeedf3",title:"Amendment to Founders Agreement 26Dec2024.pdf",type:"image",content:`https://lh3.googleusercontent.com/notebooklm/ANHLwAwqpFXR1HxbW7AVIAzk5eVfJ6lY4TIhFqFdSCLdazZoTncQx2KhBNLayHs8Pnko_6vfXjlKshQ_5BoRVKWFHz1A7BEWK2pdQw8QqEOy6BVwqVuDAzQ0sZl2QEdGu6kKqv1EuhC7xQ=w838-h1185-v0

https://lh3.googleusercontent.com/notebooklm/ANHLwAx4nXURbyBMvNY-IjT9fGusAz_1tBnQFSKqbzaxr5jApOq6fpysRMvyfHuAgqeFaru6-1BeH8j4pfHEpS2YQnXJ6D3nHSJWIzxcm_LwLHJ_a3rEkj5ndIbPBBw1MUB_IXVIEIVN=w838-h1185-v0`,painpointIds:["spanish","vesting"]},{id:"1be3bd5d-5485-4e02-a60c-4d95eec3b7ab",title:"Articles of Association - Rommaana - Feb 2026 - English.pdf",type:"text",content:`ARTICLES OF ASSOCIATION OF
ROMMAANA FOR INFORMATION TECHNOLOGY COMPANY
(A SINGLE PERSON LIMITED LIABILITY COMPANY)

I, the undersigned:
Mr. Gustavo [Surname], [Nationality] national, holding ID No. [Number] dated [Date], issued at [Place], residing in [City], [Country], (the "Founder").

PREAMBLE
Whereas the Founder is desirous of incorporating a Single Person Limited Liability Company in accordance with the Companies Law issued by Royal Decree No. M/132 dated 01/12/1443H and its Implementing Regulations (the "Law"), the Founder has established these Articles of Association (the "Articles") as follows:

ARTICLE 1: INCORPORATION
A Single Person Limited Liability Company shall be incorporated by the Founder in accordance with the provisions of the Law and these Articles (the "Company").

ARTICLE 2: NAME OF THE COMPANY
The name of the Company is: Rommaana For Information Technology Company (A Single Person Limited Liability Company).

ARTICLE 3: HEAD OFFICE OF THE COMPANY
The head office of the Company shall be in the city of Riyadh. The Company may establish branches, offices, or agencies inside or outside the Kingdom by a resolution of the Founder.

ARTICLE 4: OBJECTIVES OF THE COMPANY
The Company observes the following purposes:
1. Systems analysis.
2. Design and programming of special software.
3. Software maintenance.
4. Web page design.
5. Establishment of the infrastructure for hosting websites on the network, data processing services and related activities.

ARTICLE 5: DURATION OF THE COMPANY
The duration of the Company shall be indefinite, commencing from the date of its registration in the Commercial Register.

ARTICLE 6: CAPITAL OF THE COMPANY
The capital of the Company is set at (SAR 20,000) Twenty Thousand Saudi Riyals, divided into (2,000) Two Thousand shares of equal value of (SAR 10) Ten Saudi Riyals each. The Founder acknowledges that the capital has been paid in full.

ARTICLE 7: TRANSFER OF SHARES
The Founder may transfer all or part of the shares to another person in accordance with the provisions of the Law.

ARTICLE 8: MANAGEMENT OF THE COMPANY
The Company shall be managed by one or more managers appointed by the Founder. The manager(s) shall have such powers and authorities as determined by the Founder.
Mr. Gustavo [Surname] is appointed as the General Manager of the Company for an indefinite period.

ARTICLE 9: AUDITOR
The Company shall have an auditor appointed by the Founder, if required by Law.

ARTICLE 10: FISCAL YEAR
The fiscal year of the Company shall satisfy a period of 12 months, commencing on 01 January and ending on 31 December of each Gregorian year. The first fiscal year shall commence from the date of registration in the Commercial Register and end on 31 December of the following year.

ARTICLE 11: PROFITS AND LOSSES
The annual net profits of the Company shall be distributed after deducting general expenses and other costs as determined by the Founder, in accordance with the Law.

ARTICLE 12: DISSOLUTION AND LIQUIDATION
The Company shall be dissolved and liquidated in the cases provided for in the Law or if the Founder decides to dissolve it.

ARTICLE 13: GENERAL PROVISIONS
1. The Company allows the entry of new partners, subject to the amendment of these Articles.
2. The Founder represents the Company before judicial bodies and government agencies.
3. These Articles are subject to the Laws of the Kingdom of Saudi Arabia.

[Signature of Founder]
`,painpointIds:["fakedebt","article80"]},{id:"777ce9f0-bb8d-4750-9874-d14085995453",title:"Articles of Association - Rommaana - Feb 2026.pdf",type:"image",content:"https://lh3.googleusercontent.com/notebooklm/ANHLwAwZLZjFR9OGB77rvSGnnSu_dgbda58D9TnCt7-5tzhC2nhFsQuiw9ujJTaSdQFqPsxBWmXumew2CLVJd9c-qOwDlO6cnQ--qacoGx9Y_82AUp2VQx0cre9-SjBFeNdpObLTzR8sKQ=w838-h1185-v0",painpointIds:["fakedebt","article80"]},{id:"789bb33f-4dd7-4695-9ab4-ce529e51f617",title:"Defending Founder Rights and Equity in Saudi Corporate Law",type:"text",content:`Subject: Defending Founder Rights and Equity in Saudi Corporate Law

**1. Vesting and Resetting Service Time**

*   **Key Question:** Can a partner or investor force a founder to reset their vesting start date to the date of a new entitys registration (e.g., a Saudi LLC) despite prior service and agreements (e.g., a SAFE note)?
*   **Legal Principle:** Vesting is a contractual mechanism, not a statutory requirement under Saudi Companies Law. However, standard commercial practice and principles of *good faith* (Shariah principle) apply.
*   **Analysis:**
    *   If a founder has been working and has a prior agreement (like a SAFE note or a previous service contract) referencing their start date, that date should be respected as the "Vesting Commencement Date."
    *   Creating a new vehicle (the Saudi LLC) does not automatically negate prior service unless the founder explicitly agrees to a new start date in the new Shareholders' Agreement (SHA).
    *   **Defense:** Argue that the economic reality of the relationship began in Jan 2024 (or whenever service started). Resetting vesting without additional consideration (compensation) could be challenged as *unjust enrichment* for the company/other partners, as they are getting 2 years of "free" risk-mitigation.
    *   **Spanish Amendment:** If the Spanish amendment explicitly extended a *cliff* (waiting period), it does not logically imply a reset of the *vesting* (earning) schedule, unless explicitly stated. Confusing the two is a negotiation tactic, not a legal mandate.

**2. Article 80 of Labor Law as a "Bad Leaver" Trigger**

*   **Key Question:** Is it standard/safe to link "Bad Leaver" status (stripping equity) to Article 80 of the KSA Labor Law?
*   **Legal Principle:** Article 80 allows an employer to terminate an employee *without notice or indemnity* for specific grave reasons (e.g., assault, forgery, disclosure of secrets, *failure to follow instructions*).
*   **Analysis:**
    *   **HIGH RISK:** Using Article 80 as a "Bad Leaver" definition is extremely dangerous for a minority founder who is also an employee/manager.
    *   **Subjectivity:** Article 80 includes vague grounds like "failure to perform essential duties" or "insubordination." A majority shareholder (or CEO with executive power) could manufacture a reason to fire the founder under Article 80, thereby triggering the Bad Leaver clause and confiscating shares.
    *   **Recommendation:** Bad Leaver clauses should be restricted to objectively verifiable events:
        *   Final, non-appealable criminal conviction (involving fraud/dishonesty).
        *   Material breach of the SHA/Founders Agreement *that is not cured* after notice.
        *   Voluntary resignation (sometimes).
    *   **Defense:** Insist that Article 80 termination is an *employment* matter, not an *ownership* matter. Stripping property (shares) based on a manager's subjective firing decision is aggressive and potentially unenforceable if challenged as un-Islamic (gharar/uncertainty or unjust taking).

**3. "Fake Debt" and Paid-in Capital**

*   **Key Question:** If the AoA says capital is "Paid in Full," but a side agreement says it is owed, which prevails?
*   **Legal Principle:** The Articles of Association (AoA) registered with the Ministry of Commerce is the definitive public record.
*   **Analysis:**
    *   **Public Order:** Statements in the AoA (like "Capital has been paid in full") are deemed accurate by the regulator. Contradicting them in a side letter implies that the AoA filing was false (a potential violation of the Companies Law, penalties apply for providing false info).
    *   **Debt Validity:** If you sign a side agreement acknowledging a debt for capital that the AoA says is paid, you are creating a personal contractual obligation. The other partner could sue you on the *contract*, even if the AoA says otherwise.
    *   **Defense:** Do not sign a document stating you owe capital if the official record says you paid it. It creates a liability where none legally exists vis-a-vis the state. It essentially converts your equity into a debt obligation.

**4. Nominal Value Buyback**

*   **Key Question:** Is it fair to buy back shares at Nominal Value (e.g., 10 SAR/share) when the company is worth millions?
*   **Legal Principle:** Freedom of contract allows partners to set buyback terms. However, Shariah principles discourage *ghaban* (gross unfairness) and unjust enrichment.
*   **Analysis:**
    *   Buying back a founder's shares at Nominal Value (Par Value) instead of Fair Market Value (FMV) is a standard *penalty* for Bad Leavers.
    *   **The Trap:** If "Bad Leaver" is defined loosely (e.g., Article 80), then the Nominal Value buyback becomes a tool for the majority to expropriate the minority's value for pennies.
    *   **Defense:**
        *   Fight the *Bad Leaver definition* first (as above).
        *   If you are a "Good Leaver" (terminated without cause, death, disability), the buyback MUST be at Fair Market Value.
        *   Ensure there is a "Leaver" category (intermediate) or that unjustified termination treats you as a Good Leaver.

**5. Cure Periods**

*   **Key Question:** Is 10 days enough to cure a breach?
*   **Analysis:**
    *   10 days is very short for substantive business breaches. 30 days is standard.
    *   For "payment" breaches, 10-15 days is common.
    *   For "performance" or "material breach" (e.g., not delivering code), 30-60 days is more reasonable to allow for rectification.

**Summary Strategy for Rommaana:**
1.  **Refuse the Vesting Reset:** Stand on the SAFE note and 2024 service start.
2.  ** decoupling Article 80 from Bad Leaver:** Limit Bad Leaver to Criminal Acts/Fraud only.
3.  **Reject the Debt Acknowledgement:** Rely on the AoA's "Paid in Full" statement.
4.  **Demand Fair Market Value:** For any exit that isn't a proven crime.`,painpointIds:["vesting","article80","fakedebt","nominal","cureperiod","spanish"]},{id:"73a709a0-98b8-4282-b7b1-dc9f71551a93",title:"Founders Agreement 170124.pdf",type:"image",content:"https://lh3.googleusercontent.com/notebooklm/ANHLwAzfWVWhpoU9p4xAySRzV-dTsrSGOGDoCgUda-3IR6r7qqtI2at2qnHDpQ3yNgkp5HHgpr_RYBd-uRcr5zghsQXLJUYQKAixlfxxOJXIR1-Nqaawiy5s0c8_g6UTHD8a9z6eU1fR2w=w838-h1185-v0",painpointIds:["vesting"]},{id:"0c2983d7-50fa-467f-8fd7-0e22994dd530",title:"Founders Agreement- Bilingual (Final) provided by Gustavo.pdf",type:"text",content:`FOUNDERS AGREEMENT

This Agreement is made on [Date] between:

1. Mr. Gustavo [Surname] ("First Party" / "Founder")
2. Mr. David [Surname] ("Second Party" / "Co-Founder")
(collectively the "Parties")

...

**Article 18: LEAVER PROVISIONS**

18.1. If a Founder ceases to be an employee or consultant of the Company, their Unvested Shares shall be transferred to the Company or the other shareholders.

18.2. **Bad Leaver**:
A Bad Leaver is any Founder who ceases to be employed due to:
(a) Termination for cause under Article 80 of the Saudi Labor Law;
(b) Resignation within the first 2 years;
(c) Material breach of this Agreement.
Consequence: All Shares (Vested and Unvested) shall be transferred at **Nominal Value**.

18.3. **Good Leaver**:
Means any Leaver who is not a Bad Leaver (e.g., death, disability, termination without cause).
Consequence: Vested Shares retained or bought at Fair Market Value. Unvested Shares forfeited.

**Article 6: VESTING**
6.1. The Second Party's shares shall vest over a period of 4 years.
6.2. **Vesting Start Date**: The date of registration of the Company in KSA (February 2026).
6.3. Cliff Period: 12 months from the Vesting Start Date.

...

[Note: This is an extract of the dangerous clauses identified in the review]`,painpointIds:["article80","nominal","cureperiod","vesting"]},{id:"0a7b5701-9e0e-4367-9144-1ef861f98d7b",title:"2024 SAFE Note (Proof of History)",type:"text",content:`POST-MONEY VALUATION CAP SAFE
(Simple Agreement for Future Equity)

THIS CERTIFIES THAT in exchange for the payment of [Amount], Rommaana (the "Company") issues to the Investor the right to certain shares of the Company's Capital Stock, subject to the terms set forth below.

**Valuation Cap:** $7,000,000 (Seven Million US Dollars)

Date: September 21, 2024

**1. Events**
(a) **Equity Financing**: If there is an Equity Financing before the expiration or termination of this instrument, the Company will automatically issue to the Investor a number of shares of Safe Preferred Stock equal to the Purchase Amount divided by the Conversion Price.

...

**Signature:**
Company: Rommaana
By: Gustavo [Surname]
Title: CEO

Investor: Jaume Cases Marco
`,painpointIds:["vesting"]},{id:"dcd2694c-3a69-4fe0-8e19-5e326990a69e",title:"Official Request for Correction of shareholders' Names 08Feb202.pdf",type:"image",content:"https://lh3.googleusercontent.com/notebooklm/ANHLwAwo-ThcmndgLmP_ovFvNsT9wxaQI3mmI4GW59arYx6hoZ-1xoP0IrDDDE2wYwboE2sln2QRj9dVxEdAh6O_S-Ibq6FMtCO4YL__ZHDgVH0ipDC4jHm3mxvQX2ohrGokOzqsiun3=w838-h1185-v0",painpointIds:["article80"]},{id:"f6032f1d-0b82-44ac-836a-4809751d5251",title:"Rommaana - amendment Dec 25.pdf",type:"image",content:"https://lh3.googleusercontent.com/notebooklm/ANHLwAygNvh9msFgZIvubv88QMGT7XV5dzLQtClj92q58e56Cqb76bNTNf4oYDIqrw2VdfwG-th_H4n-sZ05axP-7Css5ih-UX-HUAOsryrhf9lHLJFb8Zwr4SbPPil9JzGB03I8FEt2Gg=w838-h1187-v0",painpointIds:["spanish","vesting"]}];(function(){const t=(f,h=document)=>h.querySelector(f),e=(f,h=document)=>[...h.querySelectorAll(f)],s="rommaana_lang";let r=localStorage.getItem(s)||"en";const i={en:{sidebarTitle:"Rommaana",sidebarSubtitle:"Legal Defense Tracker",navOverview:"Overview",navDashboard:"Dashboard",navLawyers:"Lawyers",navDocuments:"Documents",navCompare:"Compare Answers",navRedFlags:"Red Flags",navVesting:"Vesting Start",navArticle80:"Article 80 Trap",navFakeDebt:"Fake Debt",navNominal:"Nominal Value",navCurePeriod:"10-Day Cure",navSpanish:"Spanish Amendment",navDocumentation:"Documentation",docLibraryTitle:"Documentation Library",relatedDocuments:"Related Documents",noRelatedDocs:"No related documents found.",imageLoadError:"Image could not be loaded. The link may have expired.",langToggleLabel:"",dashboardTitle:"Defense Dashboard",dashboardDesc:`Track the 6 red flags in Gustavo's Founders Agreement draft. Get each confirmed as "Non-Standard" by your lawyers.`,statUnresolved:"Unresolved",statInProgress:"In Progress",statResolved:"Resolved",statLawyers:"Lawyers",statAnswersRecorded:"Answers Recorded",question:"question",questions:"questions",answer:"answer",answers:"answers",statusUnresolved:" Unresolved",statusInProgress:" In Progress",statusResolved:" Resolved",statusLabel:"Status:",statusBadgeUnresolved:"unresolved",statusBadgeInProgress:"in progress",statusBadgeResolved:"resolved",backToDashboard:" Back to Dashboard",evidence:"Evidence",answersLabel:"ANSWERS",addAnswer:"+ Add Answer",noAnswersYet:"No answers recorded yet. Add a lawyer and record their response.",lawyersTitle:"Lawyers",lawyersDesc:"Manage your legal consultants. Compare their responses across all questions.",addLawyerBtn:"+ Add Lawyer",noLawyersTitle:"No lawyers added yet",noLawyersDesc:"Add your first lawyer to start tracking consultations.",answersRecorded:"answer(s) recorded",editBtn:" Edit",deleteBtn:" Delete",independent:"Independent",documentsTitle:"Evidence Documents",documentsDesc:"Your legal proof that the draft is factually incorrect and legally dangerous. Track which lawyers have reviewed each document.",addDocBtn:"+ Add Document",keySection:"Key Section",sharedWith:"Shared with:",addLawyersFirst:"Add lawyers first",compareTitle:"Compare Answers",compareDesc:"Side-by-side comparison of all lawyers' responses for each question. Identify consensus and disagreements.",filterByPainPoint:"Filter by Pain Point",allQuestions:"All Questions",addLawyersFirstCompare:"Add lawyers first",addLawyersFirstCompareDesc:"You need at least one lawyer to compare answers.",noQuestionsFound:"No questions found.",noAnswer:" no answer ",questionHeader:"Question",addLawyerTitle:"Add Lawyer",editLawyerTitle:"Edit Lawyer",labelFullName:"Full Name *",labelFirm:"Firm / Organization",labelSpecialization:"Specialization",placeholderSpec:"e.g. Corporate Law, KSA Companies Law",labelConsultDate:"Consultation Date",labelPhone:"Phone",labelEmail:"Email",labelNotes:"Notes",placeholderNotes:"e.g. Referred by Monsha'at, specializes in partner disputes...",cancelBtn:"Cancel",saveLawyerBtn:"Save Lawyer",answerModalTitle:"Record Lawyer's Answer",labelQuestion:"Question",labelSelectLawyer:"Select Lawyer *",selectLawyerPlaceholder:" Select Lawyer ",labelLawyerAnswer:"Lawyer's Answer *",placeholderAnswer:"Record the lawyer's response here...",labelRecommendation:"Recommendation",selectDefault:" Select ",recRedFlag:" Red Flag / Non-Standard",recCaution:" Caution / Needs Modification",recSafe:" Acceptable / Standard",saveAnswerBtn:"Save Answer",addDocTitle:"Add Document",editDocTitle:"Edit Document",labelDocName:"Document Name *",placeholderDocName:"e.g. Employment Contract",labelFileName:"File Name",placeholderFileName:"e.g. employment_contract.pdf",labelDescription:"Description",placeholderDocDesc:"What this document proves and what section to show the lawyer...",labelKeySection:"Key Section",placeholderKeySection:"e.g. Article 6 (Capital)",labelQuestionToAsk:"Question to Ask",placeholderQuestionToAsk:"What question should you ask the lawyer about this document?",saveDocBtn:"Save Document",viewDoc:"View Content",alertDeleteLawyer:'Delete this lawyer? Their answers will remain but show as "Unknown Lawyer."',alertDeleteAnswer:"Delete this answer?",alertDeleteDoc:"Delete this document?",alertAddLawyerFirst:"Please add a lawyer first (go to the Lawyers section).",alertSelectLawyer:"Please select a lawyer.",alertEnterAnswer:"Please enter the answer.",unknownLawyer:"Unknown Lawyer",recLabelRedFlag:" Red Flag / Non-Standard",recLabelCaution:" Caution",recLabelSafe:" Acceptable"},ar:{sidebarTitle:"",sidebarSubtitle:"  ",navOverview:" ",navDashboard:" ",navLawyers:"",navDocuments:"",navCompare:" ",navRedFlags:" ",navVesting:" ",navArticle80:"  80",navFakeDebt:" ",navNominal:" ",navCurePeriod:" 10 ",navSpanish:" ",navDocumentation:"",docLibraryTitle:" ",relatedDocuments:"  ",noRelatedDocs:"      .",imageLoadError:"  .    .",langToggleLabel:"EN",dashboardTitle:" ",dashboardDesc:'    6      .    " "  .',statUnresolved:" ",statInProgress:" ",statResolved:" ",statLawyers:"",statAnswersRecorded:" ",question:"",questions:"",answer:"",answers:"",statusUnresolved:"  ",statusInProgress:"  ",statusResolved:"  ",statusLabel:":",statusBadgeUnresolved:" ",statusBadgeInProgress:" ",statusBadgeResolved:" ",backToDashboard:"    ",evidence:"",answersLabel:"",addAnswer:"+  ",noAnswersYet:"    .    .",lawyersTitle:"",lawyersDesc:"  .     .",addLawyerBtn:"+  ",noLawyersTitle:"    ",noLawyersDesc:"     .",answersRecorded:" ",editBtn:" ",deleteBtn:" ",independent:"",documentsTitle:" ",documentsDesc:"        .      .",addDocBtn:"+  ",keySection:" ",sharedWith:"  :",addLawyersFirst:"  ",compareTitle:" ",compareDesc:"        .   .",filterByPainPoint:"   ",allQuestions:" ",addLawyersFirstCompare:"  ",addLawyersFirstCompareDesc:"       .",noQuestionsFound:"    .",noAnswer:"    ",questionHeader:"",addLawyerTitle:" ",editLawyerTitle:" ",labelFullName:"  *",labelFirm:" / ",labelSpecialization:"",placeholderSpec:":     ",labelConsultDate:" ",labelPhone:"",labelEmail:" ",labelNotes:"",placeholderNotes:":        ...",cancelBtn:"",saveLawyerBtn:" ",answerModalTitle:"  ",labelQuestion:"",labelSelectLawyer:"  *",selectLawyerPlaceholder:"   ",labelLawyerAnswer:"  *",placeholderAnswer:"   ...",labelRecommendation:"",selectDefault:"  ",recRedFlag:"   /  ",recCaution:"  /  ",recSafe:"  / ",saveAnswerBtn:" ",addDocTitle:" ",editDocTitle:" ",labelDocName:"  *",placeholderDocName:":  ",labelFileName:" ",placeholderFileName:": employment_contract.pdf",labelDescription:"",placeholderDocDesc:"          ...",labelKeySection:" ",placeholderKeySection:":  6 ( )",labelQuestionToAsk:"  ",placeholderQuestionToAsk:"          ",saveDocBtn:" ",viewDoc:" ",alertDeleteLawyer:'        "  ".',alertDeleteAnswer:"  ",alertDeleteDoc:"  ",alertAddLawyerFirst:"    (   ).",alertSelectLawyer:"  .",alertEnterAnswer:"  .",unknownLawyer:"  ",recLabelRedFlag:"   /  ",recLabelCaution:" ",recLabelSafe:" "}};function n(f){return i[r]&&i[r][f]||i.en[f]||f}function a(f){r=f,localStorage.setItem(s,f),l()}function o(){a(r==="en"?"ar":"en")}function l(){const f=document.documentElement;f.lang=r,f.dir=r==="ar"?"rtl":"ltr",e("[data-i18n]").forEach(y=>{const _=y.dataset.i18n;y.textContent=n(_)}),e("[data-i18n-placeholder]").forEach(y=>{y.placeholder=n(y.dataset.i18nPlaceholder)});const h=t("#langToggle");h&&(h.textContent=n("langToggleLabel")),O==="dashboard"&&Ye(),O==="lawyers"&&_t(),O==="documents"&&St(),O==="documentation"&&Et(),O==="compare"&&kt(),O==="painpoint"&&D&&_e(D)}async function c(){const{data:{user:f}}=await window.supabase.auth.getUser();if(!f)return;const{data:h}=await window.supabase.from("painpoints").select("*");if(h&&h.length>0){w.painpoints=h;const{data:L}=await window.supabase.from("questions").select("*");w.painpoints.forEach(C=>{C.questions=L.filter(k=>k.painpoint_id===C.id),C.questions.forEach(k=>k.answers=[])});const{data:I}=await window.supabase.from("answers").select("*");I&&w.painpoints.forEach(C=>{C.questions.forEach(k=>{k.answers=I.filter($=>$.question_id===k.id)})})}else return await u(f.id),c();const{data:y}=await window.supabase.from("lawyers").select("*");y&&(w.lawyers=y);const{data:_}=await window.supabase.from("documents").select("*");_&&(w.documents=_),Ye()}async function u(f){const h=E();for(const y of h.painpoints){const{questions:_,...L}=y;await window.supabase.from("painpoints").upsert({...L,user_id:f});for(const I of _){const{answers:C,...k}=I;await window.supabase.from("questions").upsert({...k,painpoint_id:y.id,user_id:f})}}for(const y of h.documents)await window.supabase.from("documents").upsert({...y,user_id:f})}async function g(f){const{data:{user:h}}=await window.supabase.auth.getUser();if(!h)return;const{data:y,error:_}=await window.supabase.from("lawyers").upsert({...f,user_id:h.id}).select();return y?y[0]:null}async function p(f){await window.supabase.from("lawyers").delete().eq("id",f)}async function d(f){const{data:{user:h}}=await window.supabase.auth.getUser();if(!h)return;const{data:y}=await window.supabase.from("answers").upsert({...f,user_id:h.id}).select();return y?y[0]:null}async function m(f){const{data:{user:h}}=await window.supabase.auth.getUser();if(!h)return;const{data:y}=await window.supabase.from("documents").upsert({...f,user_id:h.id}).select();return y?y[0]:null}async function v(f){await window.supabase.from("documents").delete().eq("id",f)}async function b(f,h){await window.supabase.from("painpoints").update({status:h}).eq("id",f)}function E(){return{painpoints:[{id:"vesting",title:'The "Vesting Start" Gaslight',shortDesc:'Gustavo wants to reset your vesting to zero (Feb 2026). You have been working since Jan 2024. He claims the Spanish amendment resets everything because of "new funding."',evidence:"SAFE Note + Jan 8 Amendment",status:"unresolved",questions:[{id:"v1",text:`I have a SAFE Note from Sept 2024 proving the company had a $7M valuation and I was a founder then. Is it standard in Saudi Arabia to "reset" a founder's service to zero just because of new investment?`,evidence:"SAFE Note Sept 2024",answers:[]},{id:"v2",text:'I signed an amendment for a Spanish entity to extend a "cliff." Does that legally force me to change my "Vesting Start Date" in this new Saudi LLC? Or are they separate legal issues?',evidence:"Spanish Amendment Dec 25",answers:[]},{id:"v3",text:'What is the difference between a "Cliff" (waiting period) and "Vesting Start" (earning period) under KSA practice?',evidence:"Crucial distinction",answers:[]}]},{id:"article80",title:'The "Article 80" Death Trap',shortDesc:'The draft says if you are fired under Article 80 of the Saudi Labor Law, you are a "Bad Leaver" and lose your shares. Article 80 covers "disobedience" or "not following instructions"  totally subjective.',evidence:"Draft Page 36",status:"unresolved",questions:[{id:"a1",text:'As a 38.5% Partner registered in the AoA, is it standard to have my ownership tied to Labor Law disciplinary articles? Or should "Bad Leaver" triggers be limited to Objective Facts like a Final Court Judgment for fraud or a criminal conviction?',evidence:"AoA  38.5% partnership",answers:[]},{id:"a2",text:"Does this clause give the CEO the power to strip me of my equity without a court order?",evidence:"Draft Page 36",answers:[]}]},{id:"fakedebt",title:'The "Fake Debt"',shortDesc:`Your notarized Articles of Association (AoA) say your capital is "Paid in Full." Gustavo's draft says you still owe it  creating a legal debt that doesn't exist.`,evidence:"AoA Article 6",status:"unresolved",questions:[{id:"f1",text:"My AoA says my capital is paid. This side-agreement says it is NOT. If I sign this, am I creating a legal debt that doesn't exist? In a conflict, does the registered AoA or this private contract prevail in a Saudi court?",evidence:"AoA Article 6 vs Draft",answers:[]}]},{id:"nominal",title:'The "Nominal Value" Steal',shortDesc:'If you are a "Bad Leaver," the company buys your shares for "Nominal Value" (pennies). Since the company is worth millions (per the SAFE note), Gustavo can fire you and take your millions for 9,000 SAR.',evidence:"Clause 18.2",status:"unresolved",questions:[{id:"n1",text:'Is a buyback at "Nominal Value" for a subjective "Bad Leaver" trigger considered Unjust Enrichment or predatory under the New Saudi Companies Law?',evidence:"Clause 18.2  Nominal Value buyback",answers:[]}]},{id:"cureperiod",title:'The "10-Day" Setup',shortDesc:'You only have 10 days to "fix" a breach. This is unreasonably short for a CTO dealing with complex technical or business issues.',evidence:"Page 36 snippet",status:"unresolved",questions:[{id:"c1",text:"Is a 10-day cure period reasonable for a CTO, or is 60-90 days the market standard for tech founders in KSA?",evidence:"Draft  10-day cure clause",answers:[]}]},{id:"spanish",title:"Spanish Amendment Confusion",shortDesc:'A recently signed amendment extended the "Cliff" (waiting period) for the Spanish entity, but is being used to justify a "Vesting Reset" (earning period) in the Saudi LLC.',evidence:"Rommaana - amendment Dec 25.pdf",status:"unresolved",questions:[{id:"s1",text:'I signed this extension for a Spanish entity. Does a "Cliff Extension" legally allow my partner to "Reset" my vesting years to zero in the new Saudi company? Or should I still get credit for my 2024 start date?',evidence:"Clause 1.1  Extension of Cliff Period",answers:[]}]}],lawyers:[],documents:[{id:"doc_aoa",name:"Articles of Association (AoA)",fileName:"ContractByNationalNumber.pdf",description:'Official Saudi government document proving 38.5% partnership and capital "Paid in Full."',keySection:"Article 6 (Capital)",questionToAsk:"Since this Ministry-stamped document says my capital is paid, is it legal for my partner to force me to sign a side-contract saying I still owe it?",sharedWith:[],isDefault:!0},{id:"doc_safe",name:"2024 SAFE Note (Proof of History)",fileName:"Jaume Cases Marco - Postmoney Safe...pdf",description:"Proves the company was active and valuable in 2024 with a $7,000,000 Valuation Cap. Destroys the argument that service only starts in Feb 2026.",keySection:"Page 1  Date: Sept 2024, $7M Valuation Cap",questionToAsk:"This investment was made in 2024 based on my role as a founder. Does this prove that my Vesting Start Date should be January 17, 2024, regardless of when the Saudi LLC was registered?",sharedWith:[],isDefault:!0},{id:"doc_spanish",name:'Spanish "Cliff" Amendment',fileName:"Rommaana - amendment Dec 25.pdf",description:"Signed to extend the waiting period (Cliff), NOT to reset the earning period (Vesting). Gustavo is confusing the two to take 2024-2025 shares.",keySection:"Clause 1.1 (Extension of Cliff Period)",questionToAsk:'I signed this extension for a Spanish entity. Does a "Cliff Extension" legally allow my partner to "Reset" my vesting years to zero in the new Saudi company? Or should I still get credit for my 2024 start date?',sharedWith:[],isDefault:!0},{id:"doc_draft",name:'New Bilingual Draft (The "Trap")',fileName:"Founders Agreement- Bilingual (Final).pdf",description:'The dangerous draft containing the Article 80 trigger. Allows Gustavo to fire for "disobedience" and take shares.',keySection:"Page 36  Bad Leaver Table",questionToAsk:`Is it standard in KSA for a 38.5% Partner to be subject to Article 80 of the Labor Law as a reason to lose their equity? Shouldn't "Bad Leaver" be restricted to Objective Criminal Acts or a Final Court Judgment?`,sharedWith:[],isDefault:!0}]}}let w=loadState()||E();const S=E();S.painpoints.forEach(f=>{const h=w.painpoints.find(y=>y.id===f.id);h?f.questions.forEach(y=>{h.questions.find(_=>_.id===y.id)||h.questions.push(y)}):w.painpoints.push(f)}),S.documents.forEach(f=>{w.documents.find(h=>h.id===f.id)||w.documents.push(f)}),saveState();let O="dashboard",D=null;const P=t("#sidebar"),U=t("#hamburger"),V=t("#sidebarOverlay");function K(f,h){if(O=f,h&&(D=h),e(".view-section").forEach(y=>y.classList.remove("active")),e(".nav-item").forEach(y=>y.classList.remove("active")),f==="painpoint"){t("#view-painpoint").classList.add("active");const y=t(`[data-painpoint="${h}"]`);y&&y.classList.add("active"),_e(h)}else{const y=t(`#view-${f}`);y&&y.classList.add("active");const _=t(`[data-view="${f}"]:not([data-painpoint])`);_&&_.classList.add("active")}P.classList.remove("open"),V.classList.remove("open"),f==="dashboard"&&Ye(),f==="lawyers"&&_t(),f==="documents"&&St(),f==="documentation"&&Et(),f==="compare"&&kt()}e(".nav-item").forEach(f=>{f.addEventListener("click",()=>{const h=f.dataset.view,y=f.dataset.painpoint;K(h,y)})}),t("#backToDashboard").addEventListener("click",()=>K("dashboard")),U.addEventListener("click",()=>{P.classList.toggle("open"),V.classList.toggle("open")}),V.addEventListener("click",()=>{P.classList.remove("open"),V.classList.remove("open")}),t("#langToggle").addEventListener("click",o);function Ye(){w.painpoints.length;const f=w.painpoints.filter(k=>k.status==="unresolved").length,h=w.painpoints.filter(k=>k.status==="in-progress").length,y=w.painpoints.filter(k=>k.status==="resolved").length,_=w.painpoints.reduce((k,$)=>k+$.questions.reduce((j,W)=>j+W.answers.length,0),0);t("#dashboardStats").innerHTML=`
      <div class="stat-card"><div class="stat-value red">${f}</div><div class="stat-label">${n("statUnresolved")}</div></div>
      <div class="stat-card"><div class="stat-value amber">${h}</div><div class="stat-label">${n("statInProgress")}</div></div>
      <div class="stat-card"><div class="stat-value green">${y}</div><div class="stat-label">${n("statResolved")}</div></div>
      <div class="stat-card"><div class="stat-value blue">${w.lawyers.length}</div><div class="stat-label">${n("statLawyers")}</div></div>
      <div class="stat-card"><div class="stat-value blue">${_}</div><div class="stat-label">${n("statAnswersRecorded")}</div></div>
    `;const L={vesting:"",article80:"",fakedebt:"",nominal:"",cureperiod:"",spanish:""},I={unresolved:n("statusBadgeUnresolved"),"in-progress":n("statusBadgeInProgress"),resolved:n("statusBadgeResolved")};let C="";w.painpoints.forEach((k,$)=>{const j=k.questions.length,W=k.questions.reduce((et,tt)=>et+tt.answers.length,0),je=n(j!==1?"questions":"question"),Ze=n(W!==1?"answers":"answer");C+=`
        <div class="card" data-ppid="${k.id}">
          <div class="card-header">
            <div class="card-number">${L[k.id]||$+1}</div>
            <span class="status-badge ${k.status}"><span class="status-dot"></span>${I[k.status]||k.status}</span>
          </div>
          <div class="card-title">${k.title}</div>
          <div class="card-desc">${k.shortDesc}</div>
          <div class="card-footer">
            <span class="card-meta"> ${j} ${je}   ${W} ${Ze}</span>
            <span class="card-meta" style="color:var(--accent-amber);"> ${k.evidence}</span>
          </div>
        </div>`}),t("#painpointCards").innerHTML=C,e(".card[data-ppid]").forEach(k=>{k.addEventListener("click",()=>K("painpoint",k.dataset.ppid))}),t("#lawyerCount").textContent=w.lawyers.length}function _e(f){const h=w.painpoints.find(k=>k.id===f);if(!h)return;t("#ppDetailHeader").innerHTML=`
      <h2>${h.title}</h2>
      <p>${h.shortDesc}</p>
      <p style="margin-top:6px;color:var(--accent-amber);font-size:0.82rem;"> ${n("evidence")}: ${h.evidence}</p>
    `;const y=t("#ppStatusSelect");y.innerHTML=`
      <option value="unresolved" ${h.status==="unresolved"?"selected":""}>${n("statusUnresolved")}</option>
      <option value="in-progress" ${h.status==="in-progress"?"selected":""}>${n("statusInProgress")}</option>
      <option value="resolved" ${h.status==="resolved"?"selected":""}>${n("statusResolved")}</option>
    `,y.onchange=()=>{b(h.id,y.value).then(()=>{c().then(()=>_e(h.id))})};const _=t("#ppStatusLabel");_&&(_.textContent=n("statusLabel")),t("#backToDashboard").textContent=n("backToDashboard");let L="";h.questions.forEach(k=>{let $="";k.answers.length===0?$=`<div class="empty-state" style="padding:24px;"><p style="margin:0;">${n("noAnswersYet")}</p></div>`:($='<div class="answers-list">',k.answers.forEach((j,W)=>{const je=w.lawyers.find(tt=>tt.id===j.lawyerId),Ze=je?je.name:n("unknownLawyer"),et={"red-flag":n("recLabelRedFlag"),caution:n("recLabelCaution"),safe:n("recLabelSafe")};$+=`
            <div class="answer-item">
              <div class="answer-header">
                <span class="answer-lawyer"> ${Ze}</span>
                <div style="display:flex;gap:6px;align-items:center;">
                  <span class="answer-date">${j.date||""}</span>
                  <button class="btn-icon btn-sm" title="Edit" onclick="window._editAnswer('${k.id}', ${W})"></button>
                  <button class="btn-icon btn-sm" title="Delete" onclick="window._deleteAnswer('${k.id}', ${W})"></button>
                </div>
              </div>
              <div class="answer-text">${B(j.text)}</div>
              ${j.recommendation?`<span class="answer-recommendation ${j.recommendation}">${et[j.recommendation]||j.recommendation}</span>`:""}
            </div>`}),$+="</div>"),L+=`
        <div class="question-detail-panel">
          <div class="question-text">"${B(k.text)}"</div>
          <div class="question-evidence"> ${k.evidence}</div>
          <div class="flex-between mb-1">
            <span style="font-size:0.78rem;color:var(--text-muted);font-weight:600;">${n("answersLabel")} (${k.answers.length})</span>
            <button class="btn btn-sm btn-primary" onclick="window._addAnswer('${k.id}')">${n("addAnswer")}</button>
          </div>
          ${$}
        </div>`}),t("#ppQuestions").innerHTML=L;const I=window.notebookSources.filter(k=>k.painpointIds&&k.painpointIds.includes(f)),C=t("#ppRelatedDocs");if(I.length>0){let k=`<h3 style="margin-bottom:16px; font-size:1.1rem; border-bottom:1px solid var(--border-color); padding-bottom:8px;">${n("relatedDocuments")}</h3>
            <div class="cards-grid" style="grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));">`;I.forEach($=>{const j=$.type==="image"?"":"";k+=`
                <div class="card" onclick="window._viewDoc('${$.id}')" style="cursor:pointer; min-height:100px;">
                    <div class="card-header" style="justify-content:flex-start; gap:10px;">
                        <span style="font-size:1.5rem;">${j}</span>
                        <div class="card-title" style="font-size:0.95rem; margin-bottom:0;">${$.title}</div>
                    </div>
                </div>`}),k+="</div>",C.innerHTML=k}else C.innerHTML=""}function B(f){const h=document.createElement("div");return h.textContent=f,h.innerHTML}function _t(){const f=t("#lawyerCards"),h=t("#lawyerEmptyState");if(w.lawyers.length===0){f.innerHTML="",h.classList.remove("hidden");const _=h.querySelector("h3"),L=h.querySelector("p");_&&(_.textContent=n("noLawyersTitle")),L&&(L.textContent=n("noLawyersDesc"));return}h.classList.add("hidden");let y="";w.lawyers.forEach(_=>{const L=_.name.split(" ").map(C=>C[0]).join("").toUpperCase().slice(0,2),I=w.painpoints.reduce((C,k)=>C+k.questions.reduce(($,j)=>$+j.answers.filter(W=>W.lawyerId===_.id).length,0),0);y+=`
        <div class="lawyer-card">
          <div class="lawyer-avatar">${L}</div>
          <div class="lawyer-name">${B(_.name)}</div>
          <div class="lawyer-firm">${B(_.firm||n("independent"))}</div>
          <div class="lawyer-meta">
            ${_.specialization?`<span> ${B(_.specialization)}</span>`:""}
            ${_.consultDate?`<span> ${_.consultDate}</span>`:""}
            ${_.phone?`<span> ${B(_.phone)}</span>`:""}
            ${_.email?`<span> ${B(_.email)}</span>`:""}
            <span> ${I} ${n("answersRecorded")}</span>
          </div>
          ${_.notes?`<p style="margin-top:10px;font-size:0.78rem;color:var(--text-muted);line-height:1.4;">${B(_.notes)}</p>`:""}
          <div class="lawyer-actions">
            <button class="btn btn-sm btn-secondary" onclick="window._editLawyer('${_.id}')">${n("editBtn")}</button>
            <button class="btn btn-sm btn-danger" onclick="window._deleteLawyer('${_.id}')">${n("deleteBtn")}</button>
          </div>
        </div>`}),f.innerHTML=y,t("#lawyerCount").textContent=w.lawyers.length}function St(){let f="";w.documents.forEach(h=>{let y=`<div class="doc-shared"><span class="doc-shared-label">${n("sharedWith")}</span>`;w.lawyers.length===0?y+=`<span style="font-size:0.72rem;color:var(--text-muted);font-style:italic;">${n("addLawyersFirst")}</span>`:w.lawyers.forEach(_=>{h.sharedWith.includes(_.id)?y+=`<span class="doc-shared-lawyer" onclick="window._toggleDocShare('${h.id}','${_.id}')"> ${B(_.name)}</span>`:y+=`<span class="doc-not-shared" onclick="window._toggleDocShare('${h.id}','${_.id}')" title="Click to mark as shared">${B(_.name)}</span>`}),y+="</div>",f+=`
        <div class="doc-item">
          <div class="doc-header">
            <div class="doc-icon"></div>
            <div>
              <div class="doc-title">${B(h.name)}</div>
              <div class="doc-filename">${B(h.fileName||"")}</div>
              ${h.keySection?`<div style="margin-top:4px;font-size:0.75rem;color:var(--accent-amber);"> ${n("keySection")}: ${B(h.keySection)}</div>`:""}
            </div>
            <div style="margin-left:auto;display:flex;gap:6px;">
              <button class="btn-icon btn-sm" title="Edit" onclick="window._editDoc('${h.id}')"></button>
              ${h.isDefault?"":`<button class="btn-icon btn-sm" title="Delete" onclick="window._deleteDoc('${h.id}')"></button>`}
            </div>
          </div>
          <div class="doc-desc">${B(h.description||"")}</div>
          ${h.questionToAsk?`<div class="doc-question">${B(h.questionToAsk)}</div>`:""}
          ${y}
        </div>`}),t("#docList").innerHTML=f}function Et(){const f=t("#documentationList");if(!window.notebookSources||window.notebookSources.length===0){f.innerHTML='<div class="empty-state"><p>No documentation loaded.</p></div>';return}let h="";window.notebookSources.forEach(y=>{const _=y.type==="image"?"":"";h+=`
        <div class="doc-item">
          <div class="doc-header">
            <div class="doc-icon">${_}</div>
            <div style="flex:1;">
              <div class="doc-title">${B(y.title)}</div>
              <div class="doc-desc" style="margin-top:4px;font-size:0.75rem;color:var(--text-muted);">${y.type.toUpperCase()}</div>
            </div>
            <button class="btn btn-sm btn-secondary" onclick="window._viewDoc('${y.id}')">${n("viewDoc")}</button>
          </div>
        </div>`}),f.innerHTML=h}window._viewDoc=f=>{const h=window.notebookSources.find(_=>_.id===f);if(!h)return;t("#contentModalTitle").textContent=h.title;const y=t("#contentModalBody");if(h.type==="image"){const _=h.content.split(/\r?\n/).filter(I=>I.trim()!=="");let L='<div style="display:flex;flex-direction:column;gap:16px;">';_.forEach(I=>{const C=I.match(/(https?:\/\/[^\s]+)/);C?L+=`
                    <div>
                        <img src="${C[0]}" style="max-width:100%;border-radius:4px;border:1px solid var(--border-color);"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div style="display:none; padding:32px; background:var(--bg-secondary); border:1px dashed var(--border-color); border-radius:4px; text-align:center;">
                            <p style="margin-bottom:8px; font-size:1.5rem;"></p>
                            <p style="margin:0; color:var(--text-secondary);">${n("imageLoadError")||"Image could not be loaded (link usage expired)."}</p>
                        </div>
                    </div>`:I.match(/^[0-9a-f-]{36}$/)||(L+=`<p>${B(I)}</p>`)}),L+="</div>",y.innerHTML=L}else y.textContent=h.content;Se("contentModal")},t("#closeContentModal").addEventListener("click",()=>X("contentModal"));function kt(){const f=t("#compareFilter");let h=`<option value="all">${n("allQuestions")}</option>`;w.painpoints.forEach(y=>{h+=`<option value="${y.id}">${y.title}</option>`}),f.innerHTML=h,f.onchange=()=>At(),At()}function At(){const f=t("#compareFilter").value,h=t("#compareContainer");if(w.lawyers.length===0){h.innerHTML=`<div class="empty-state"><div class="empty-icon"></div><h3>${n("addLawyersFirstCompare")}</h3><p>${n("addLawyersFirstCompareDesc")}</p></div>`;return}const y=f==="all"?w.painpoints:w.painpoints.filter(C=>C.id===f);let _=[];if(y.forEach(C=>{C.questions.forEach(k=>{_.push({ppTitle:C.title,...k})})}),_.length===0){h.innerHTML=`<div class="empty-state"><p>${n("noQuestionsFound")}</p></div>`;return}let L=`<th>${n("questionHeader")}</th>`;w.lawyers.forEach(C=>{L+=`<th>${B(C.name)}</th>`});let I="";_.forEach(C=>{I+="<tr>",I+=`<td class="compare-question-cell"><strong style="color:var(--accent-blue);font-size:0.72rem;">${B(C.ppTitle)}</strong><br>${B(C.text)}</td>`,w.lawyers.forEach(k=>{const $=C.answers.find(j=>j.lawyerId===k.id);if($){const j={"red-flag":"var(--accent-red)",caution:"var(--accent-amber)",safe:"var(--accent-green)"},W={"red-flag":"",caution:"",safe:""};I+=`<td>${B($.text)}${$.recommendation?`<br><span style="color:${j[$.recommendation]||"inherit"};font-size:0.72rem;font-weight:600;">${W[$.recommendation]||""} ${$.recommendation.replace("-"," ")}</span>`:""}</td>`}else I+=`<td class="compare-no-answer">${n("noAnswer")}</td>`}),I+="</tr>"}),h.innerHTML=`<table class="compare-table"><thead><tr>${L}</tr></thead><tbody>${I}</tbody></table>`}function Se(f){t(`#${f}`).classList.add("active")}function X(f){t(`#${f}`).classList.remove("active")}e(".modal-overlay").forEach(f=>{f.addEventListener("click",h=>{h.target===f&&f.classList.remove("active")})});function Xe(f){if(t("#lawyerForm").reset(),t("#lawyerEditId").value="",f){const y=w.lawyers.find(_=>_.id===f);if(!y)return;t("#lawyerModalTitle").textContent=n("editLawyerTitle"),t("#lawyerEditId").value=y.id,t("#lawyerName").value=y.name,t("#lawyerFirm").value=y.firm||"",t("#lawyerSpec").value=y.specialization||"",t("#lawyerDate").value=y.consultDate||"",t("#lawyerPhone").value=y.phone||"",t("#lawyerEmail").value=y.email||"",t("#lawyerNotes").value=y.notes||""}else t("#lawyerModalTitle").textContent=n("addLawyerTitle");De(),Se("lawyerModal")}function De(){e("#lawyerForm [data-i18n]").forEach(h=>{h.textContent=n(h.dataset.i18n)}),e("#lawyerForm [data-i18n-placeholder]").forEach(h=>{h.placeholder=n(h.dataset.i18nPlaceholder)}),e("#answerForm [data-i18n]").forEach(h=>{h.textContent=n(h.dataset.i18n)}),e("#answerForm [data-i18n-placeholder]").forEach(h=>{h.placeholder=n(h.dataset.i18nPlaceholder)}),e("#docForm [data-i18n]").forEach(h=>{h.textContent=n(h.dataset.i18n)}),e("#docForm [data-i18n-placeholder]").forEach(h=>{h.placeholder=n(h.dataset.i18nPlaceholder)});const f=t("#answerRecommendation");f&&(f.options[0].textContent=n("selectDefault"),f.options[1]&&(f.options[1].textContent=n("recRedFlag")),f.options[2]&&(f.options[2].textContent=n("recCaution")),f.options[3]&&(f.options[3].textContent=n("recSafe")))}t("#addLawyerBtn").addEventListener("click",()=>Xe()),t("#addLawyerBtn2").addEventListener("click",()=>Xe()),t("#closeLawyerModal").addEventListener("click",()=>X("lawyerModal")),t("#cancelLawyer").addEventListener("click",()=>X("lawyerModal")),t("#lawyerForm").addEventListener("submit",f=>{f.preventDefault();const h=t("#lawyerEditId").value,y={name:t("#lawyerName").value.trim(),firm:t("#lawyerFirm").value.trim(),specialization:t("#lawyerSpec").value.trim(),consultDate:t("#lawyerDate").value,phone:t("#lawyerPhone").value.trim(),email:t("#lawyerEmail").value.trim(),notes:t("#lawyerNotes").value.trim()};h&&(y.id=h),g(y).then(()=>{c(),X("lawyerModal")})}),window._editLawyer=f=>Xe(f),window._deleteLawyer=f=>{confirm(n("alertDeleteLawyer"))&&p(f).then(()=>{c()})},window._addAnswer=f=>{if(w.lawyers.length===0){alert(n("alertAddLawyerFirst"));return}t("#answerForm").reset(),t("#answerQuestionId").value=f,t("#answerEditIdx").value="";let h="";w.painpoints.forEach(_=>{const L=_.questions.find(I=>I.id===f);L&&(h=L.text)}),t("#answerQuestionText").textContent=h;let y=`<option value="">${n("selectLawyerPlaceholder")}</option>`;w.lawyers.forEach(_=>{y+=`<option value="${_.id}">${_.name}</option>`}),t("#answerLawyer").innerHTML=y,t("#answerModalTitle").textContent=n("answerModalTitle"),De(),Se("answerModal")},window._editAnswer=(f,h)=>{let y=null;if(w.painpoints.forEach(I=>{const C=I.questions.find(k=>k.id===f);C&&(y=C)}),!y||!y.answers[h])return;const _=y.answers[h];t("#answerForm").reset(),t("#answerQuestionId").value=f,t("#answerEditIdx").value=h,t("#answerQuestionText").textContent=y.text;let L=`<option value="">${n("selectLawyerPlaceholder")}</option>`;w.lawyers.forEach(I=>{L+=`<option value="${I.id}" ${I.id===_.lawyerId?"selected":""}>${I.name}</option>`}),t("#answerLawyer").innerHTML=L,t("#answerText").value=_.text,t("#answerRecommendation").value=_.recommendation||"",t("#answerModalTitle").textContent=n("answerModalTitle"),De(),Se("answerModal")},window._deleteAnswer=(f,h)=>{confirm(n("alertDeleteAnswer"))&&(w.painpoints.forEach(y=>{const _=y.questions.find(L=>L.id===f);_&&_.answers.splice(h,1)}),saveState(),_e(D))},t("#closeAnswerModal").addEventListener("click",()=>X("answerModal")),t("#cancelAnswer").addEventListener("click",()=>X("answerModal")),t("#answerForm").addEventListener("submit",f=>{f.preventDefault();const h=t("#answerQuestionId").value,y=t("#answerEditIdx").value,_=t("#answerLawyer").value,L=t("#answerText").value.trim(),I=t("#answerRecommendation").value;if(!_){alert(n("alertSelectLawyer"));return}if(!L){alert(n("alertEnterAnswer"));return}const C={question_id:h,lawyer_id:_,text:L,recommendation:I,date:new Date().toISOString().split("T")[0]};if(y!==""){let k=null;w.painpoints.forEach($=>{const j=$.questions.find(W=>W.id===h);j&&(k=j)}),C.id=k.answers[parseInt(y)].id}d(C).then(()=>{c().then(()=>{X("answerModal"),_e(D)})})});function Tt(f){if(t("#docForm").reset(),t("#docEditId").value="",f){const y=w.documents.find(_=>_.id===f);if(!y)return;t("#docModalTitle").textContent=n("editDocTitle"),t("#docEditId").value=y.id,t("#docName").value=y.name||"",t("#docFileName").value=y.fileName||"",t("#docDesc").value=y.description||"",t("#docSection").value=y.keySection||"",t("#docQuestion").value=y.questionToAsk||""}else t("#docModalTitle").textContent=n("addDocTitle");De(),Se("docModal")}t("#addDocBtn").addEventListener("click",()=>Tt()),t("#closeDocModal").addEventListener("click",()=>X("docModal")),t("#cancelDoc").addEventListener("click",()=>X("docModal")),t("#docForm").addEventListener("submit",f=>{f.preventDefault();const h=t("#docEditId").value,y={name:t("#docName").value.trim(),fileName:t("#docFileName").value.trim(),description:t("#docDesc").value.trim(),keySection:t("#docSection").value.trim(),questionToAsk:t("#docQuestion").value.trim()};h&&(y.id=h),m(y).then(()=>{c(),X("docModal")})}),window._editDoc=f=>Tt(f),window._deleteDoc=f=>{confirm(n("alertDeleteDoc"))&&v(f).then(()=>{c()})},window._toggleDocShare=(f,h)=>{const y=w.documents.find(L=>L.id===f);if(!y)return;const _=y.sharedWith.indexOf(h);_>=0?y.sharedWith.splice(_,1):y.sharedWith.push(h),m({id:y.id,shared_with:y.sharedWith}).then(()=>{c()})},window.addEventListener("supabase-auth-success",f=>{c()}),window.supabase&&window.supabase.auth.getSession().then(({data:{session:f}})=>{f&&c()}),l()})();
